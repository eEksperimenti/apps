<!-- $Id$
 *
 * Red Pitaya Oscilloscope client.
 *
 * Author: Dakus <info@eskala.eu>
 *         
 * (c) Red Pitaya  http://www.redpitaya.com
 *
 * This part of code is written in Javascript & HTML.
 * Please visit http://en.wikipedia.org/wiki/JavaScript
 *              http://en.wikipedia.org/wiki/HTML
 * for more details on the languages used herein.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sončna celica</title>
  <link href="../assets/bootstrap-3.0.0/css/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../assets/style.css?6" rel="stylesheet" type="text/css">
  <script src="../assets/bootstrap-3.0.0/js/jquery.js"></script>
  <script src="../assets/bootstrap-3.0.0/js/bootstrap.min.js"></script>
  <script src="../assets/flot/jquery.flot.min.js"></script>
  <script src="../assets/flot/jquery.flot.selection.min.js"></script>
  <script src="../assets/flot/jquery.flot.navigate.js"></script>
  <script src="../assets/flot/jquery.flot.resize.min.js"></script>
  <script src="../assets/flot/jquery.flot.touch.js?2"></script>
  <style type="text/css">
    .xtitle {
      text-align: center;  
      margin: 5px 30px 0;
      min-height: 20px;
    }
    .ytitle {
      position: absolute;
      top: 50%;
      left: 7px;
      transform: rotate(-90deg);
      -o-transform: rotate(-90deg);
      -ms-transform: rotate(-90deg);
      -moz-transform: rotate(-90deg);
      -webkit-transform:  rotate(-90deg);
      transform-origin: 0 0;
      -o-transform-origin: 0 0;
      -ms-transform-origin: 0 0;
      -moz-transform-origin: 0 0;
      -webkit-transform-origin: 0 0;
    }
    .y2title {
        position: absolute;
        top: 50%;
        right: -7%;
        transform: rotate(-90deg);
        -o-transform: rotate(-90deg);
        -ms-transform: rotate(-90deg);
        -moz-transform: rotate(-90deg);
        -webkit-transform:  rotate(-90deg);
        transform-origin: 0 0;
        -o-transform-origin: 0 0;
        -ms-transform-origin: 0 0;
        -moz-transform-origin: 0 0;
        -webkit-transform-origin: 0 0;
      }
   .plot_holder {
        height: 460px; 
        margin: 0 30px 0 10px; 
        padding: 0;
    }
  </style>
  <script type="text/javascript">
  
  // Settings which can be modified
  var meritve=[];
  var cMeritev=null;
  var app_id = 'soncna_celica';  
  var root_url = '';
  //var root_url = 'http://10.0.1.221';      // Test local
  //var root_url = 'http://192.168.53.133';  // Test remote and local
  //var root_url = 'http://192.168.1.100';   // Default RedPitaya IP
  var start_app_url = root_url + '/bazaar?start=' + app_id;
  var stop_app_url = root_url + '/bazaar?stop=';
  var get_url = root_url + '/data';
  var post_url = root_url + '/data';
  
  var auto_x=true;
  var auto_y=true;
  var auto_y2=true;
  var merilni_upor=1.0;
  
  var plot1_options = {
      series: {
          lines: { show: true },
          points: { show: true }
      },
      xaxis: {tickDecimals: 1},
      yaxes: [ {}, {
                  // align if we are to the right
                  alignTicksWithAxis: 1,
                  position: 'right'
          } ],
      legend: { show: false}
  };
  
  var plot1_options2 = {
      series: {
          lines: { show: true },
          points: { show: true }
      },
      xaxis: {tickDecimals: 1},
      legend: { show: false}
  };
  
  var zadnja_vrednost=null;
  
  var update_interval = 250;              // Update interval for PC, milliseconds
  var update_interval_mobdev = 500;      // Update interval for mobile devices, milliseconds 
  var request_timeout = 3000;            // Milliseconds
  var long_timeout = 20000;              // Milliseconds
  var meas_panel_dec = 1;                // Decimation for numerical measure panel to make it human readable
  var meas_panel_dec_mobdev = 1;         // Decimation for numerical measure panel for mobile devices
  var points_per_px = 5;                 // How many points per pixel should be drawn. Set null for unlimited (will disable client side decimation).
  var xdecimal_places = 2;               // Number of decimal places for the xmin/xmax values. Maximum supported are 12.
  var trigger_level_xdecimal_places = 4; // Number of decimal places for trigger level tooltip
  var range_offset = 1;                  // Percentages
  
  var show_power=false;
    
  var xmin = -1000000;
  var xmax = 1000000;  

  var time_range_max = [130, 1000, 8, 130, 1, 8];
  var range_steps = [0.5, 1, 2, 5, 10, 20, 50, 100];
  
  var plot_options = {
    colors: ['#3276B1', '#D2322D', '#009900'],    // channel1, channel2, trigger line
    lines: { lineWidth: 1 },
    selection: { mode: 'xy' },
    zoom: { interactive: true, trigger: null },
    xaxis: { min: xmin, max: xmax },
    grid: { borderWidth: 0 },
    legend: { noColumns: 2, margin: [0, 0], backgroundColor: 'transparent' },
    touch: { autoWidth: false, autoHeight: false }
  };
  
  // Settings which should not be modified
  
  var update_timer = null;
  var zoompan_timer = null;
  var downloading = false;
  var sending = false;
  var send_que = false;
  var use_long_timeout = false;
  var trig_dragging = false;
  var touch_last_y = 0;
  var user_editing = false;
  var app_started = false;
  var last_get_failed = false;
  var refresh_counter = 0;
  var autorun = 1;
  var datasets = [];
  var plot = null;
  var plot1=null;
  var params = {
    original: null,
    local: null
  };
  
  // Default parameters - posted after server side app is started 
  var def_params = {
    en_avg_at_dec: 0
  }; 
    
  
  function set_x_range()
  {
    var options=plot1.getOptions();
    options.xaxes[0].min=parseFloat($('#xmin').val());
    options.xaxes[0].max=parseFloat($('#xmax').val());
    plot1.setupGrid();
  }
  
  function set_y_range()
  {
    var options=plot1.getOptions();
    options.yaxes[0].min=parseFloat($('#ymin').val());
    options.yaxes[0].max=parseFloat($('#ymax').val());
    plot1.setupGrid();
  }
  
  function set_y2_range()
  {
    var options=plot1.getOptions();
    options.yaxes[1].min=parseFloat($('#ymin2').val());
    options.yaxes[1].max=parseFloat($('#ymax2').val());
    plot1.setupGrid();
  }
  
  function update_panels_state()
  {
    if (cMeritev>=0 && meritve[cMeritev]!==undefined && meritve[cMeritev].data.length>=1)
    {
      var zm=meritve[cMeritev].data[meritve[cMeritev].data.length-1];
      var umer=zm[0];
      var imer=zm[1];
      
      if (imer>parseFloat($('#im').val()))
      {
        $('#Umer').text(floatToLocalString(shortenFloat(umer+parseFloat($('#uk').val()))));
        
        $('#panel2').show();
        if ($('#collapseOne').hasClass('in')) $('#collapseOne').collapse('toggle');
        if (!$('#collapseTwo').hasClass('in')) $('#collapseTwo').collapse('toggle');
      }
      else
      {
        $('#panel3').show();
        if ($('#collapseOne').hasClass('in')) $('#collapseOne').collapse('toggle');
        if ($('#collapseTwo').hasClass('in')) $('#collapseTwo').collapse('toggle');
        if (!$('#collapseThree').hasClass('in')) $('#collapseThree').collapse('toggle');
      }
    }
  }
  
  function reset_panels()
  {
    if (!$('#collapseOne').hasClass('in')) $('#collapseOne').collapse('toggle');
    $('#panel2').hide();
    $('#panel3').hide();
    update_panels_state();
  }
  
  // On page loaded
  
  $(function() { 

        var protocol  = window.location.protocol;
    var base_addr = window.location.hostname;

    $(".opis").on("click", function(){
      var win = window.open(protocol +"//" + base_addr + '/index.html?page=soncna-celica-aplikacija', '_blank');
      win.focus();
    });

    $("#tezji_navodila").on("click", function(){
      var win = window.open(protocol +"//" + base_addr + '/index.html?page=soncna-celica-tezji', '_blank');
      win.focus();
    });

    $("#srednji_navodila").on("click", function(){
      var win = window.open(protocol +"//" + base_addr + '/index.html?page=soncna-celica-srednji', '_blank');
      win.focus();
    });

    $("#lazji_navodila").on("click", function(){
      var win = window.open(protocol +"//" + base_addr + '/index.html?page=soncna-celica-lazji', '_blank');
      win.focus();
    });
    
    // Show different buttons on touch screens    
    if(window.ontouchstart === undefined) {
      $('.btn-lg').removeClass('btn-lg');
      $('#accordion .btn, .modal .btn').addClass('btn-sm');
      $('#btn_zoompan').remove();
      $('#btn_zoomin, #btn_zoomout, #btn_pan').show();
    }
    else {
      update_interval = update_interval_mobdev;
      $('#btn_zoomin, #btn_zoomout, #btn_pan').remove();
      $('#btn_zoompan').show();
    }
    
    // Add application ID in the message from modal popup
    $('.app-id').text(app_id);
    
    // Disable all controls until the params state is loaded for the first time 
    $('input, select, button', '.container').prop('disabled', false);
    $('[data-toggle="tooltip"]').tooltip();
    
    $.get("navodila.html", function( data ) {
      $('#navodila').html(data);
      reset_panels();
    });
    
    merilni_upor=$('#rm').val();
    $('#rm').keypress(function( event )
    {
      if (event.which==13) merilni_upor=$('#rm').val();
    });
    
    $('#xmin,#xmax').keypress(function( event )
                              {
                                $('#auto-x').prop('checked',false);
                                auto_x=false;
                                if (event.which==13) set_x_range();
                              });
    $('#auto-x').click(function()
                       {
                          if ($(this).prop('checked')) {
                              var options=plot1.getOptions();
                              options.xaxes[0].min=null;
                              options.xaxes[0].max=null;
                              plot1.setupGrid();
                              auto_x=true;
                          }
                          else
                          {
                            set_x_range();
                            auto_x=false;
                          }
                       });
    $('#ymin,#ymax').keypress(function( event )
                              {
                                $('#auto-y').prop('checked',false);
                                auto_y=false;
                                if (event.which==13) set_y_range();
                              });
    $('#auto-y').click(function()
                       {
                          if ($(this).prop('checked')) {
                              var options=plot1.getOptions();
                              options.yaxes[0].min=null;
                              options.yaxes[0].max=null;
                              plot1.setupGrid();
                              auto_y=true;
                          }
                          else
                          {
                            set_y_range();
                            auto_y=false;
                          }
                       });
    
    $('#ymin2,#ymax2').keypress(function( event )
                              {
                                $('#auto-y2').prop('checked',false);
                                auto_y2=false;
                                if (event.which==13) set_y2_range();
                              });
    $('#auto-y2').click(function()
                       {
                          if ($(this).prop('checked')) {
                              var options=plot1.getOptions();
                              options.yaxes[1].min=null;
                              options.yaxes[1].max=null;
                              plot1.setupGrid();
                              auto_y2=true;
                          }
                          else
                          {
                            set_y2_range();
                            auto_y2=false;
                          }
                       });
    // Events binding for trigger controls
    
    $('#trigger_canvas').on({
      'mousedown touchstart': function(evt) {
      
        // Ignore the event if trigger source is External or mode is not Normal
        if(!params.original || params.original.trig_mode != 1 || params.original.trig_source == 2) {
          return;
        }
      
        trig_dragging = true;
        $('input, select', '#accordion').blur();
        mouseDownMove(this, evt);
        evt.preventDefault();
        return false;
      },
      'mousemove touchmove': function(evt) {
        if(! trig_dragging) {
          return;
        }
        mouseDownMove(this, evt);
        evt.preventDefault();
        return false;
      },
      'mouseup mouseout touchend': mouseUpOut
    });
    
    $('input,select', '#accordion').on('focus', function() {
      user_editing = true;
    });
    
    $('#trig_mode').on('change', function() {
      onDropdownChange($(this), 'trig_mode', true);
      
      // Autorun if trigger mode is Auto(0) or Normal(1), stop if it is Single(2).
      autorun = (params.local.trig_mode == 2 ? 0 : 1); 
      runStop();
    });
    
    $('#trig_source').on('change', function() { onDropdownChange($(this), 'trig_source'); });
    $('#trig_edge').on('change', function() { onDropdownChange($(this), 'trig_edge'); });
    
    $('#trig_level')
      .on('focus paste', function() {
        $(this).parent().addClass('input-group');
        $('#apply_trig_level').show();
      })
      .on('blur', function() {
        $('#apply_trig_level').hide();
        $(this).parent().removeClass('input-group');
        
        var tlev = parseLocalFloat($(this).val());
        var scale = (params.local.trig_source == 0 ? params.local.scale_ch1 : params.local.scale_ch2);
        if(! isNaN(tlev)) {
          params.local.trig_level = tlev / scale;
          updateTriggerSlider(undefined, false);
          redrawPlot();
          sendParams();
        }
        else {
          tlev = params.local.trig_level * scale;
          $(this).val(tlev)
        }
        user_editing = false;
      })
      .on('change', function() {
        $(this).blur();
      })
      .on('keypress', function(e) {
        if(e.keyCode == 13) {
          $(this).blur();
        }
      });
    
    // Events binding for range controls
    
    $('#range_x_minus, #range_x_plus').on('click', function() {
      var nearest = $(this).data('nearest');
      if(nearest && plot) {
        var options = plot.getOptions();
        var axes = plot.getAxes();
        var min = (options.xaxes[0].min !== null ? options.xaxes[0].min : axes.xaxis.min);
        var max = (options.xaxes[0].max !== null ? options.xaxes[0].max : axes.xaxis.max);
        var unit = $(this).data('unit');
        
        // Convert nanoseconds to milliseconds.
        if(unit == 'ns') {
          nearest /= 1000;
        }
        
        var center = (min + max) / 2;
        var half = nearest / 2;
        min = center - half;
        max = center + half;

        options.xaxes[0].min = min;
        options.xaxes[0].max = max;

        plot.setupGrid();
        plot.draw();
        
        params.local.xmin = min;
        params.local.xmax = max;       
        updateRanges();
        $(this).tooltip($(this).prop('disabled') === true ? 'hide' : 'show');
        sendParams(true);
      }
    });
    
    $('#range_y_minus, #range_y_plus').on('click', function() {
      var nearest = $(this).data('nearest');
      
      if(nearest && plot) {
        var options = plot.getOptions();
        var axes = plot.getAxes();
        var min = (options.yaxes[0].min !== null ? options.yaxes[0].min : axes.yaxis.min);
        var max = (options.yaxes[0].max !== null ? options.yaxes[0].max : axes.yaxis.max);
        var unit = $(this).data('unit');
        
        // Convert millivolts to volts.
        if(unit == 'mV') {
          nearest /= 1000;
        }
        
        var center = (min + max) / 2;
        var half = nearest / 2;
        min = center - half;
        max = center + half;
        
        options.yaxes[0].min = min;
        options.yaxes[0].max = max;

        plot.setupGrid();
        plot.draw();
               
        updateRanges();
        $(this).tooltip($(this).prop('disabled') === true ? 'hide' : 'show');
        updateTriggerSlider();
      }
    });
    
    $('#offset_x_minus, #offset_x_plus').on('click', function() {
      if(plot) {
        var direction = ($(this).attr('id') == 'offset_x_minus' ? 'left' : 'right');
        var options = plot.getOptions();
        var axes = plot.getAxes();
        var min = (options.xaxes[0].min !== null ? options.xaxes[0].min : axes.xaxis.min);
        var max = (options.xaxes[0].max !== null ? options.xaxes[0].max : axes.xaxis.max);
        var offset = (max - min) * range_offset/100;
        
        if(direction == 'left') {
          min -= offset;
          max -= offset;
        }
        else {
          min += offset;
          max += offset;
        }
        
        options.xaxes[0].min = min;
        options.xaxes[0].max = max;

        plot.setupGrid();
        plot.draw();
        
        params.local.xmin = min;
        params.local.xmax = max;
               
        updateRanges();
        sendParams(true);
      }
    });
    
    $('#offset_y_minus, #offset_y_plus').on('click', function() {
      if(plot) {
        var direction = ($(this).attr('id') == 'offset_y_minus' ? 'down' : 'up');
        var options = plot.getOptions();
        var axes = plot.getAxes();
        var min = (options.yaxes[0].min !== null ? options.yaxes[0].min : axes.yaxis.min);
        var max = (options.yaxes[0].max !== null ? options.yaxes[0].max : axes.yaxis.max);
        var offset = (max - min) * range_offset/100;
        
        if(direction == 'down') {
          min -= offset;
          max -= offset;
        }
        else {
          min += offset;
          max += offset;
        }
        
        options.yaxes[0].min = min;
        options.yaxes[0].max = max;

        plot.setupGrid();
        plot.draw();
               
        updateRanges();
        updateTriggerSlider();
      }
    });
      
    // Events binding for gain controls
    
    $('#gain_ch1_att').on('change', function() { onDropdownChange($(this), 'prb_att_ch1'); });
    $('#gain_ch1_sett').on('change', function() { onDropdownChange($(this), 'gain_ch1'); });
    $('#gain_ch2_att').on('change', function() { onDropdownChange($(this), 'prb_att_ch2'); });
    $('#gain_ch2_sett').on('change', function() { onDropdownChange($(this), 'gain_ch2'); });
    
    // Modals
    
    $('#modal_err, #modal_app').modal({ show: false, backdrop: 'static', keyboard: false });
    
    $('#btn_switch_app').on('click', function() {
      var newapp_id = $('#new_app_id').text();
      if(newapp_id.length) {
        location.href = location.href.replace(app_id, newapp_id);
      }
    });
    
    $('.btn-app-restart').on('click', function() {
      location.reload();
    });
    
    $('#btn_retry_get').on('click', function() {
      $('#modal_err').modal('hide');
      updateGraphData();
    });
    
    $('.btn-close-modal').on('click', function() {
      $(this).closest('.modal').modal('hide');
    });
      
    // Other event bindings
    
    $('#trigger_tooltip').tooltip({
      title: '',
      trigger: 'manual',
      placement: 'auto left',
      animation: false
    });
    
    $('.btn').on('click', function() {
      var btn = $(this);
      setTimeout(function() { btn.blur(); }, 10);
    });
    
    $('#btn_toolbar .btn').on('blur', function() {
      $(this).removeClass('active');
    });
    
    $(document).on('click', '#accordion > .panel > .panel-heading', function(event) {
      $(this).next('.panel-collapse').collapse('toggle');
      event.stopImmediatePropagation();
    });
    
    // Tooltips for range buttons
    $('#range_x_minus, #range_x_plus, #range_y_minus, #range_y_plus').tooltip({
      container: 'body'
    });
    
    // Load first data
    updateGraphData();
    
    // Stop the application when page is unloaded
    window.onbeforeunload = function() { 
      $.ajax({
        url: stop_app_url,
        async: false
      });
    };

  });
  
  function startApp() {
    $.get(
      start_app_url
    )
    .done(function(dresult) {
      if(dresult.status == 'ERROR') {
        showModalError((dresult.reason ? dresult.reason : 'Could not start the application.'), true);
      }
      else {
        $.post(
          post_url, 
          JSON.stringify({ datasets: { params: def_params } })
        )
        .done(function(dresult) {
          app_started = true;
          updateGraphData();      
        })
        .fail(function() {
          showModalError('Could not initialize the application with default parameters.', false, true);
        });
      }
    })
    .fail(function() {
      showModalError('Could not start the application.', true);
    });
  }
  
  function showModalError(err_msg, retry_btn, restart_btn, ignore_btn) {
    var err_modal = $('#modal_err');
    
    err_modal.find('#btn_retry_get')[retry_btn ? 'show' : 'hide']();
    err_modal.find('.btn-app-restart')[restart_btn ? 'show' : 'hide']();
    err_modal.find('#btn_ignore')[ignore_btn ? 'show' : 'hide']();
    err_modal.find('.modal-body').html(err_msg);
    err_modal.modal('show');
  }   
  
  function updateGraphData() {
    if(downloading) {
      return;
    }
    if(update_timer) {
      clearTimeout(update_timer);
      update_timer = null;
    }
    downloading = true;
    
    // Send params if there are any unsent changes
    sendParams();
    
    var arun_before_ajax = autorun;
    var long_timeout_used = use_long_timeout;
    
    $.ajax({
      url: get_url,
      timeout: (use_long_timeout ? long_timeout : request_timeout),
      cache: false
    })
    .done(function(dresult) {
      last_get_failed = false;
    
      if(dresult.status === 'ERROR') {
        if(! app_started) {
          startApp();
        }
        else {
          showModalError((dresult.reason ? dresult.reason : 'Application error.'), true, true);
        }
      }
      else if(dresult.datasets !== undefined && dresult.datasets.params !== undefined) {
        // Check if the application started on the server is the same as on client
        if(app_id !== dresult.app.id) {
          if(! app_started) {
            startApp();
          }
          else {
            $('#new_app_id').text(dresult.app.id);
            $('#modal_app').modal('show');
          }
          return;
        }
        
        app_started = true;
      
        // Check if trigger mode (which may switch autorun) was changed during ajax request
        var arun_after_ajax = autorun;
        
        datasets = [];
        for(var i=0; i<dresult.datasets.g1.length; i++) {
          dresult.datasets.g1[i].color = i;
          dresult.datasets.g1[i].label = 'Channel ' + (i+1);          
          datasets.push(dresult.datasets.g1[i]);
        }
        
        if(! plot1) {
          initPlot(dresult.datasets.params);
          updateRanges();
          $('.y2title').hide();
          plot1=$.plot($("#plot1 .plot_holder:first"),[ {data:[[0, 0]]},{label:'moč',color:0,data:[[0,0]],ido:'p',yaxis:2} ], plot1_options2);
          var data=plot1.getData();
          addLegendItem(data[1],$('#legenda-power'));
          plot1=$.plot($("#plot1 .plot_holder:first"),[ {data:[[0, 0]]} ], plot1_options2);
          
          nova_karakteristika();
        }
        else {
          // Apply the params state received from server if not in edit mode
          if(! user_editing) {
            loadParams(dresult.datasets.params);
            
            // Restore the autorun value modified by loadParams 
            if(arun_before_ajax != arun_after_ajax) {
              autorun = arun_after_ajax; 
            }
          }
          // Time units must be always updated
          else {
            updateTimeUnits(dresult.datasets.params);
          }
          
          // Force X min/max
          if(dresult.datasets.params.forcex_flag == 1) {
            var options = plot.getOptions();
            options.xaxes[0].min = dresult.datasets.params.xmin;
            options.xaxes[0].max = dresult.datasets.params.xmax;
          }
          
          // Redraw the plot using new datasets
          /*plot.setData(filterData(datasets, plot.width()));
          plot.setupGrid();
          plot.draw();*/
          zadnja_vrednost=[dresult.datasets.params.meas_avg_ch1*1000,dresult.datasets.params.meas_avg_ch2*1000/merilni_upor];
          //var ul=dresult.datasets.params.meas_avg_ch1*1000;zadnja_vrednost=[ul,1.0/ul];
          var _m=[];
          for (var i=0;i<meritve.length;++i)
          {
            if (meritve[i].visible) _m.push(meritve[i]);
          }
          
          if (show_power)
          {
            var uidata=meritve[cMeritev].data;
            var pdata=[];
            for (j=0;j<uidata.length;++j)
            {
              pdata.push([uidata[j][0],uidata[j][0]*uidata[j][1]]);
            }
            _m.push({ido:cMeritev,label:'moč',color:0,data:pdata,yaxis:2,lines:{fill: true, fillColor: { colors: [ { opacity: 0.8 }, { opacity: 0.1 } ] }}});
          }
          
          plot1.setData(_m.concat({data:[zadnja_vrednost],points:{radius:15}}));
          if (auto_x || auto_y || auto_y2) plot1.setupGrid();
          plot1.draw();
          
          plot_table_body(zadnja_vrednost);
        }
        
        if(! trig_dragging) {
          ;//updateTriggerSlider();
        }
        
        //updateRanges();

        if(autorun || dresult.status === 'AGAIN') {
          if(autorun) {
            $('#btn_single').prop('disabled', true);
          }
          update_timer = setTimeout(function() {
            updateGraphData();
          }, update_interval);
        }
        else {
          $('#btn_single').prop('disabled', false);
        }
      }
      else {
        showModalError('Wrong application data received.', true, true);
      }
    })
    .fail(function(jqXHR, textStatus, errorThrown) {
      if(last_get_failed) {
        showModalError('Data receiving failed.<br>Error status: ' + textStatus, true, true);
        last_get_failed = false;
      }
      else {
        last_get_failed = true;
        downloading = false;
        updateGraphData();  // One more try
      }
    })
    .always(function() {
      if(! last_get_failed) {
        downloading = false;
        
        if(params.local) {
          // Disable trigger level input if trigger source is External or mode is not Normal
          if(params.original.trig_mode != 1 || params.original.trig_source == 2) {
            $('#trig_level').prop('disabled', true);
            if($('#trig_level').is(':focus')) {
              $('#trig_level').blur();
            }
            $('#apply_trig_level').hide().parent().removeClass('input-group');
          }
          else {
            $('#trig_level').prop('disabled', false);
          }
          
          // Manage the state of other components
          $('#accordion').find('input,select').not('#trig_level').prop('disabled', false);
          $('.btn').not('#btn_single, #range_y_plus, #range_y_minus, #range_x_plus, #range_x_minus').prop('disabled', false);
        }
      }
      
      if(long_timeout_used) {
        use_long_timeout = false;
      }
    });
  }
  
  function togglePower()
  {
    show_power=!show_power;
    
    var icon='glyphicon-eye-open';
    if (show_power) icon='glyphicon-eye-close';
    $('#sb-p span').attr('class','glyphicon '+icon);
    if (show_power)
    {
      $('.y2title').show();
      plot1=$.plot($("#plot1 .plot_holder:first"),[ {data:[[0, 0]]},{label:'moč',color:0,data:[[0,0]],ido:'p',yaxis:2} ], plot1_options);
    }
    else
    {
      $('.y2title').hide();
      plot1=$.plot($("#plot1 .plot_holder:first"),[ {data:[[0, 0]]} ], plot1_options2);
    }
  }
  
  function toggleSeries(seriesIdx)
  {
    meritve[seriesIdx].visible=!meritve[seriesIdx].visible;
    var icon='glyphicon-eye-open';
    if (meritve[seriesIdx].visible) icon='glyphicon-eye-close';
    $('#sb-'+seriesIdx+' span').attr('class','glyphicon '+icon);
  }
  
  function plot_table_body(zadnja_vrednost)
  {
    if (cMeritev===null) return;
    var tmp=meritve[cMeritev].data;
    var tmer=[];
    for (var i=0;i<tmp.length;++i)
    {
      tmer.push({ 'A': tmp[i][0], 'B': tmp[i][1] });
    }
    
    if (zadnja_vrednost!==undefined) tmer.push({ 'A': zadnja_vrednost[0], 'B': zadnja_vrednost[1] });
    
    tmer.sort(function(a, b) {
      return a.A - b.A;
    });

    var oznaka=false;
    
    var i=0;
    var k=0;
    $('#tabela_body tr').each(function()
    {
      if (!oznaka && zadnja_vrednost!==undefined && Math.abs(tmer[i].A-zadnja_vrednost[0])<1e-6 && Math.abs(tmer[i].B-zadnja_vrednost[1])<1e-6)
      {
        $(this).addClass("success");
        oznaka=true;
        $(this).find('td.td-remove').empty();
        k--;
      }
      else if ($(this).hasClass("success"))
      {
        $(this).removeClass("success");
        $(this).find('td.td-remove').html(removal_link_template());
      }
      
      $(this).find('td.td-u').html(floatToLocalString(shortenFloat(tmer[i].A)));
      $(this).find('td.td-i').html(floatToLocalString(shortenFloat(tmer[i].B)));
      $(this).find('td.td-p').html(floatToLocalString(shortenFloat(tmer[i].A*tmer[i].B)));
      $(this).find('td.td-remove a').attr('data-inx',k);
      ++k;
      
      ++i;
    });
    
    $('#tabela_body a').off('click').click(function() {
        zbrisi_meritev($(this).attr('data-inx'));
        return false;
    });
  }
  
  function tr_template()
  {
    return '<tr><th scope="row"></th><td class="td-u"></td><td class="td-i"></td><td class="td-p"></td><td class="td-remove">'+removal_link_template()+'</td></tr>';
  }
  
  function removal_link_template()
  {
    return '<a href="#"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>';
  }
  
  function initPlot(init_params) {
    var plot_holder = $('#plot_holder');
    var ymax = init_params.gui_reset_y_range / 2;
    var ymin = ymax * -1;
    
    // Load received params
    loadParams(init_params);
    
    // When xmin/xmax are null, the min/max values of received data will be used. For ymin/ymax use the gui_reset_y_range param.
    $.extend(true, plot_options, {
      xaxis: { min: null, max: null },
      yaxis: { min: ymin, max: ymax }
    });
    
    // Local optimization    
    var filtered_data = filterData(datasets, plot_holder.width());
  
    // Plot first creation and drawing
    plot = $.plot(
      plot_holder, 
      filtered_data,
      plot_options
    );
  }
  
  function onDropdownChange(that, param_name, do_get) {
    params.local[param_name] = parseInt(that.val());
    sendParams(do_get);
    that.blur();
    user_editing = false;
  }
  
  function loadParams(orig_params) {
    if(! $.isPlainObject(orig_params)) {
      return;
    }
    
    // Ignore xmin/xmax values received from server. That values must be used only on AUTO button click 
    // and on ForceX flag, but that is done before the sendParams() function is called.
    if(plot) {
      var options = plot.getOptions();
      if(options.xaxes[0].min && options.xaxes[0].max) {
        orig_params.xmin = options.xaxes[0].min;
        orig_params.xmax = options.xaxes[0].max;
      }
    }
    
    // Same data in local and original params
    params.original = $.extend({}, orig_params);
    params.local = $.extend({}, params.original);

    // Autorun if trigger mode is Auto(0) or Normal(1), stop if it is Single(2)
    autorun = (params.original.trig_mode == 2 ? 0 : 1);
    
    // Enable the Single button when not in autorun mode
    $('#btn_single').prop('disabled', autorun);
    
    $('#trig_mode').val(params.original.trig_mode);
    $('#trig_source').val(params.original.trig_source);
    $('#trig_edge').val(params.original.trig_edge);
    var scale = (params.original.trig_source == 0 ? params.original.scale_ch1 : params.original.scale_ch2);
    $('#trig_level').val(floatToLocalString(params.original.trig_level * scale));
    
    if ((refresh_counter++ % meas_panel_dec) == 0) {
      /*
        $('#info_u').html(floatToLocalString(shortenFloat(params.original.meas_avg_ch1)));
        $('#info_i').html(floatToLocalString(shortenFloat(params.original.meas_avg_ch2)));
        $('#info_p').html(floatToLocalString(shortenFloat(params.original.meas_avg_ch1*params.original.meas_avg_ch2*1000)));
        */
        
        $('#info_ch1_min').html(floatToLocalString(shortenFloat(params.original.meas_min_ch1)));
        $('#info_ch1_max').html(floatToLocalString(shortenFloat(params.original.meas_max_ch1)));
        $('#info_ch1_amp').html(floatToLocalString(shortenFloat(params.original.meas_amp_ch1)));
        $('#info_ch1_avg').html(floatToLocalString(shortenFloat(params.original.meas_avg_ch1)));
        $('#info_ch1_freq').html(convertHz(params.original.meas_freq_ch1));
        $('#info_ch1_period').html(convertSec(params.original.meas_per_ch1));

        $('#info_ch2_min').html(floatToLocalString(shortenFloat(params.original.meas_min_ch2)));
        $('#info_ch2_max').html(floatToLocalString(shortenFloat(params.original.meas_max_ch2)));
        $('#info_ch2_amp').html(floatToLocalString(shortenFloat(params.original.meas_amp_ch2)));
        $('#info_ch2_avg').html(floatToLocalString(shortenFloat(params.original.meas_avg_ch2)));
        $('#info_ch2_freq').html(convertHz(params.original.meas_freq_ch2));
        $('#info_ch2_period').html(convertSec(params.original.meas_per_ch2));
    }
    
    $('#gain_ch1_att').val(params.original.prb_att_ch1);
    $('#gain_ch1_sett').val(params.original.gain_ch1);
    $('#gain_ch2_att').val(params.original.prb_att_ch2);
    $('#gain_ch2_sett').val(params.original.gain_ch2);
        
    if(params.original.en_avg_at_dec) {
      $('#btn_avg').removeClass('btn-default').addClass('btn-primary');
    }
    else {
      $('#btn_avg').removeClass('btn-primary').addClass('btn-default');
    }
    
    updateTimeUnits(orig_params);
    $('#ytitle').show();
  }
  
  function updateTimeUnits(new_params) {
    if(! $.isPlainObject(new_params)) {
      return;
    } 
    
    params.original.time_units = params.local.time_units = new_params.time_units;

    var timeu_lbl = (params.original.time_units == 0 ? 'μs' : (params.original.time_units == 1 ? 'ms' : 's'));
    $('#xtitle').text('Time [ ' + timeu_lbl + ' ]');
  }
  
  function isParamChanged() {
    if(params.original) {
      for(var key in params.original) {
        if(params.original[key] != params.local[key]) {
          return true;
        }
      }
    }
    return false;
  }
  
  function sendParams(refresh_data, force_send, single_btn) {
    if(sending || (force_send !== true && !isParamChanged())) {
      send_que = sending;
      return;
    }
    
    var auto_flag = params.local.auto_flag;  // Keep the value of auto_flag, because in POST response it is always 0
    sending = true;
    params.local.single_btn = (single_btn === true ? 1 : 0);
    use_long_timeout = !!auto_flag;
  
    $.ajax({
      type: 'POST',
      url: post_url,
      data: JSON.stringify({ datasets: { params: params.local } }),
      timeout: (use_long_timeout ? long_timeout : request_timeout),
      cache: false
    })
    .done(function(dresult) {
      // OK: Load the params received as POST result
      if(dresult.datasets !== undefined && dresult.datasets.params !== undefined) {
      
        // Use the provided min/max values only once after AUTO button was clicked
        if(auto_flag == 1 && dresult.datasets.params.min_y !== dresult.datasets.params.max_y) {
          var options = plot.getOptions();
          
          options.xaxes[0].min = dresult.datasets.params.xmin;
          options.xaxes[0].max = dresult.datasets.params.xmax;
          options.yaxes[0].min = dresult.datasets.params.min_y;
          options.yaxes[0].max = dresult.datasets.params.max_y;
          
          // Enable both channels after click on AUTO button
          if(!$('#btn_ch1').data('checked') || !$('#btn_ch2').data('checked')) {
            $('#btn_ch1').data('checked', true).removeClass('btn-default').addClass('btn-primary');
            $('#btn_ch2').data('checked', true).removeClass('btn-default').addClass('btn-primary');
            redrawPlot();
          }
          // Both channels are already active, do a quick redraw
          else {
            plot.setupGrid();
            plot.draw();
          }
        }
      
        if(auto_flag == 0 && dresult.datasets.params.forcex_flag == 1) {
          var options = plot.getOptions();
          
          options.xaxes[0].min = dresult.datasets.params.xmin;
          options.xaxes[0].max = dresult.datasets.params.xmax;
         
          plot.setupGrid();
          plot.draw();
        }      
      
        loadParams(dresult.datasets.params);
        //updateTriggerSlider();
        
        if(refresh_data && !downloading) {
          //updateGraphData();
        } 
      }
      else if(dresult.status == 'ERROR') {
        showModalError((dresult.reason ? dresult.reason : 'Error while sending data (E1).'), false, true, true);
        send_que = false;
      }
      else {
        showModalError('Error while sending data (E2).', false, true, true);
      }
    })
    .fail(function() {
      showModalError('Error while sending data (E3).', false, true, true);
    })
    .always(function() {
      sending = false;
      user_editing = false;
      
      if(send_que) {
        send_que = false;
        setTimeout(function(refresh_data) {
          sendParams(refresh_data);
        }, 100);
      }
    });
  }
  
  function getData(from, to) {
    var rangedata = new Array();
    for(var i=0; i<datasets.length; i++) {
      if(! $('#btn_ch' + (i+1)).data('checked')) {
        continue;
      }
      rangedata.push({ color: datasets[i].color, label: datasets[i].label, data: [] });
      for(var j=0; j<datasets[i].data.length; j++) {
        if(datasets[i].data[j][0] > to) {
          break;
        }
        if(datasets[i].data[j][0] >= from) {
          rangedata[rangedata.length - 1].data.push(datasets[i].data[j]);
        }
      }
    }
    rangedata = filterData(rangedata, (plot ? plot.width() : $('plot_holder').width()));
    return rangedata;
  }
  
  // Use only data for selected channels and do downsamling (data decimation), which is required for 
  // better performance. On the canvas cannot be shown too much graph points. 
  function filterData(dsets, points) {
    var filtered = [];
    var num_of_channels = 2;

    for(var l=0; l<num_of_channels; l++) {
      if(! $('#btn_ch' + (l+1)).data('checked')) {
        continue;
      }

      i = Math.min(l, dsets.length - 1);

      filtered.push({ color: dsets[i].color, label: dsets[i].label, data: [] });
      
      if(points_per_px === null || dsets[i].data.length > points * points_per_px) {
        var step = Math.ceil(dsets[i].data.length / (points * points_per_px));
        var k = 0;
        for(var j=0; j<dsets[i].data.length; j++) {
          if(k > 0 && ++k < step) {
            continue;
          }
          filtered[filtered.length - 1].data.push(dsets[i].data[j]);
          k = 1;
        }
      }
      else {
        filtered[filtered.length - 1].data = dsets[i].data.slice(0);
      }
    }
    
    filtered = addTriggerDataSet(filtered);
    return filtered;
  }
  
  // Add a data series for the trigger level line
  function addTriggerDataSet(dsets) {

    // Transform trigger level to real values
    var scale = (params.local.trig_source == 0 ? params.local.scale_ch1 : params.local.scale_ch2);
    var tlev = params.local.trig_level * scale;
  
    // Don't add trigger dataset if trigger level is outside the visible area...
    if(plot) {
      var yaxis = plot.getAxes().yaxis;
      if(tlev < yaxis.min || tlev > yaxis.max) {
        return dsets;
      }
    }
    // ...or trigger mode is not Normal
    if(params.local.trig_mode != 1) {
      return dsets;
    }
    // ...or trigger source is external
    if(params.local.trig_source == 2) {
      return dsets;
    }
    // ...or outside of received data for Y axis
    var ch1ymin = null, 
        ch1ymax = null;
    // Find Y min/max values from data for first visible channel
    for(var i=0; i<dsets[0].data.length; i++) {
      ch1ymin = (ch1ymin === null || ch1ymin > dsets[0].data[i][1] ? dsets[0].data[i][1] : ch1ymin);
      ch1ymax = (ch1ymax === null || ch1ymax < dsets[0].data[i][1] ? dsets[0].data[i][1] : ch1ymax);
    }
    if(dsets.length > 1) {
      var ch2ymin = null, 
          ch2ymax = null;
      // Find Y min/max values from data for second visible channel
      for(var i=0; i<dsets[1].data.length; i++) {
        ch2ymin = (ch2ymin === null || ch2ymin > dsets[1].data[i][1] ? dsets[1].data[i][1] : ch2ymin);
        ch2ymax = (ch2ymax === null || ch2ymax < dsets[1].data[i][1] ? dsets[1].data[i][1] : ch2ymax);
      }
      // Check if trigger level is outside of found values
      if(tlev < Math.min(ch1ymin, ch2ymin) || tlev > Math.max(ch1ymax, ch2ymax)) {
        return dsets;
      }
    }
    else {
      // Check if trigger level is outside of found values
      if(tlev < ch1ymin || tlev > ch1ymax) {
        return dsets;
      }
    }
  
    var index = 0;
    var dxmin = 0;
    var dxmax = 1;
    
    if(dsets.length && dsets[0].data[0]) {
      index = dsets.length;
      
      dxmin = dsets[0].data[0][0];
      dxmax = dsets[0].data[dsets[0].data.length - 1][0];
    }
    dsets[index] = { color: 2, data: [[dxmin, tlev], [dxmax, tlev]], shadowSize: 1 };
    
    return dsets;
  }
  
  function runStop() {
    if(autorun) {
      $('#btn_single').prop('disabled', true);
      updateGraphData();
    }
    else {
      $('#btn_single').prop('disabled', false);
      if(update_timer) {
        clearTimeout(update_timer);
        update_timer = null;
      }
    }
  }
  
  function singleUpdate() {
    if(! autorun) {
      sendParams(true, true, true);
    }
  }
  
  function redrawPlot() {
    if(! downloading) {
      if(! plot) {
        updateGraphData();
      }
      else {
        var options = plot.getOptions();
        plot = $.plot(
          plot.getPlaceholder(), 
          filterData(datasets, plot.width()),
          $.extend(true, plot_options, {
            xaxis: { min: options.xaxes[0].min, max: options.xaxes[0].max },
            yaxis: { min: options.yaxes[0].min, max: options.yaxes[0].max }
          })
        );
        updateTriggerSlider();        
      }
    }
  }
  
  function setVisibleChannels(btn) {
    var other_btn = $(btn.id == 'btn_ch1' ? '#btn_ch2' : '#btn_ch1');
    var btn = $(btn);
    var checked = !btn.data('checked');
    
    btn.data('checked', checked).toggleClass('btn-default btn-primary');
    
    // At least one button must be checked, so that at least one graph will be visible.
    if(! checked) {
      other_btn.data('checked', true).removeClass('btn-default').addClass('btn-primary');
    }
    redrawPlot();
  }
  
  function autoscaleY() {
    if(! plot) {
      return;
    }
    
    var options = plot.getOptions();
    var axes = plot.getAxes();
    
    // Set Y scale to data min/max + 10%
    options.yaxes[0].min = (axes.yaxis.datamin < 0 ? axes.yaxis.datamin * 1.1 : axes.yaxis.datamin - axes.yaxis.datamin * 0.1); 
    options.yaxes[0].max = (axes.yaxis.datamax > 0 ? axes.yaxis.datamax * 1.1 : axes.yaxis.datamax + axes.yaxis.datamax * 0.1);

    plot.setupGrid();
    plot.draw();
    
    updateRanges();
    updateTriggerSlider();
  }
  
  function setAvgAtDec() {
    if(! plot) {
      return;
    }
    
    $('#btn_avg').toggleClass('btn-default btn-primary');

    if($('#btn_avg').hasClass('btn-primary')) {
      params.local.en_avg_at_dec = 1;
    }
    else{
      params.local.en_avg_at_dec = 0;
    }

    sendParams(true, true);
  }

  function resetZoom() {
    if(! plot) {
      return;
    }
    
    $('#btn_ch1, #btn_ch2').data('checked', true).removeClass('btn-default').addClass('btn-primary');
    
    var ymax = params.original.gui_reset_y_range / 2;
    var ymin = ymax * -1;
    
    $.extend(true, plot_options, {
      xaxis: { min: null, max: null },
      yaxis: { min: ymin, max: ymax }
    });
         
    var options = plot.getOptions();
    options.xaxes[0].min = null;
    options.xaxes[0].max = null;
    options.yaxes[0].min = ymin;
    options.yaxes[0].max = ymax;
    
    plot.setupGrid();
    plot.draw();
    
    params.local.xmin = xmin;
    params.local.xmax = xmax;
    
    sendParams(true, true);
  }

  function updateZoom() {
    if(! plot) {
      return;
    }
    
    params.local.xmin = 0;
    params.local.xmax = time_range_max[params.local.time_range];
  
    var axes = plot.getAxes();
    var options = plot.getOptions();
    
    options.xaxes[0].min = params.local.xmin;
    options.xaxes[0].max = params.local.xmax;
    options.yaxes[0].min = axes.yaxis.min;
    options.yaxes[0].max = axes.yaxis.max;
    
    plot.setupGrid();
    plot.draw();

    sendParams(true, true);
  }
  
  function selectTool(toolname) {
    $('#selzoompan .btn').removeClass('btn-primary').addClass('btn-default');
    $(this).toggleClass('btn-default btn-primary');
  
    if(toolname == 'zoomin') {
      enableZoomInSelection();
    }
    if(toolname == 'zoomout') {
      enableZoomOut();
    }
    else if(toolname == 'pan') {
      enablePanning();
    }
  }

  function enableZoomInSelection() {
    if(plot_options.hasOwnProperty('selection')) {
      return;
    }
    
    var plot_pholder = plot.getPlaceholder();

    // Disable panning and zoom out
    delete plot_options.pan;
    plot_pholder.off('click.rp');
    
    // Get current min/max for both axes to use them to fix the current view
    var axes = plot.getAxes();
    
    plot = $.plot(
      plot_pholder, 
      plot.getData(),
      $.extend(true, plot_options, {
        selection: { mode: 'xy' },
        xaxis: { min: axes.xaxis.min, max: axes.xaxis.max },
        yaxis: { min: axes.yaxis.min, max: axes.yaxis.max }
      })
    );
  }
  
  function enableZoomOut() {
    var plot_pholder = plot.getPlaceholder();
    
    plot_pholder.on('click.rp', function(event) {
      var offset = $(event.target).offset();
      
      plot.zoomOut({
        center: { left: event.pageX - offset.left, top: event.pageY - offset.top },
        amount: 1.2
      });
    });
    
    // Disable zoom in selection and panning
    delete plot_options.selection;
    delete plot_options.pan;
    
    // Get current min/max for both axes to use them to fix the current view
    var axes = plot.getAxes();
    
    plot = $.plot(
      plot_pholder, 
      plot.getData(),
      $.extend(true, plot_options, {
        xaxis: { min: axes.xaxis.min, max: axes.xaxis.max },
        yaxis: { min: axes.yaxis.min, max: axes.yaxis.max }
      })
    );
  }
  
  function enablePanning() {
    if(plot_options.hasOwnProperty('pan')) {
      return;
    }
    
    var plot_pholder = plot.getPlaceholder();
    
    // Disable selection zooming and zoom out
    delete plot_options.selection;
    plot_pholder.off('click.rp');
    
    // Get current min/max for both axes to use them to fix the current view
    var axes = plot.getAxes();
    
    plot = $.plot(
      plot_pholder, 
      plot.getData(),
      $.extend(true, plot_options, {
        pan: { interactive: true },
        xaxis: { min: axes.xaxis.min, max: axes.xaxis.max },
        yaxis: { min: axes.yaxis.min, max: axes.yaxis.max }
      })
    );
  }
  
  function mouseDownMove(that, evt) {
    var y;
    user_editing = true;
    
    if(evt.type.indexOf('touch') > -1) {
      y = evt.originalEvent.touches[0].clientY - that.getBoundingClientRect().top - plot.getPlotOffset().top;
      touch_last_y = y;
    }
    else {
      y = evt.clientY - that.getBoundingClientRect().top - plot.getPlotOffset().top;
    }
    updateTriggerSlider(y);
    
    $('#trigger_tooltip').data('bs.tooltip').options.title = plot.getAxes().yaxis.c2p(y).toFixed(trigger_level_xdecimal_places);
    $('#trigger_tooltip').tooltip('show');
  }

  function mouseUpOut(evt) {
    if(trig_dragging) {
      trig_dragging = false;
      
      var y;
      if(evt.type.indexOf('touch') > -1) {
        //y = evt.originalEvent.touches[0].clientY - this.getBoundingClientRect().top - plot.getPlotOffset().top;
        y = touch_last_y;
      }
      else {
        y = evt.clientY - this.getBoundingClientRect().top - plot.getPlotOffset().top;
      }
      
      var scale = (params.local.trig_source == 0 ? params.local.scale_ch1 : params.local.scale_ch2);
      params.local.trig_level = parseFloat(plot.getAxes().yaxis.c2p(y).toFixed(trigger_level_xdecimal_places)) / scale;           
      
      updateTriggerSlider();
      redrawPlot();
      sendParams();
    }
    else {
      user_editing = false;
    }
    $('#trigger_tooltip').tooltip('hide');
  }
  
  function updateTriggerSlider(y, update_input) {
    if(! plot) {
      return;
    }
    
    var canvas = $('#trigger_canvas')[0];
    var context = canvas.getContext('2d');
    var plot_offset = plot.getPlotOffset();
    var ymax = params.original.gui_reset_y_range / 2;
    var ymin = ymax * -1;
    
    // Transform trigger level to real values
    // TODO: local or original params?
    var scale = (params.local.trig_source == 0 ? params.local.scale_ch1 : params.local.scale_ch2);
    var tlev = params.local.trig_level * scale;

    // If trigger level is outside the predefined ymin/ymax, change the level
    
    if(tlev < ymin) {
      tlev = ymin;
    }
    else if(tlev > ymax) {
      tlev = ymax;
    }
    
    if(y === undefined) {
      if(update_input !== false) {
        $('#trig_level').not(':focus').val(floatToLocalString(tlev));
      }
      y = plot.getAxes().yaxis.p2c(tlev);
    }
    
    // If trigger source is External or mode is not Normal or trigger level is not in visible area, do not show the trigger slider and paint the vertical line with gray
    context.clearRect(0, 0, canvas.width, canvas.height); 
    var yaxis = plot.getAxes().yaxis;
    if(params.original.trig_mode != 1 || tlev < yaxis.min || tlev > yaxis.max || params.original.trig_source == 2) {
      context.lineWidth = 1;
      context.strokeStyle = '#dddddd';
      context.stroke();
      context.beginPath();
      context.moveTo(10, plot_offset.top);
      context.lineTo(10, canvas.height - plot_offset.bottom + 1);
      context.stroke();
    }
    else {
      context.beginPath();
      context.arc(10, y + plot_offset.top, 8, 0, 2 * Math.PI, false);
      context.fillStyle = '#009900';
      context.fill();
      context.lineWidth = 1;
      context.strokeStyle = '#007700';
      context.stroke();
      context.beginPath();
      context.moveTo(10, plot_offset.top);
      context.lineTo(10, canvas.height - plot_offset.bottom + 1);
      context.stroke();
    }
    $('#trigger_tooltip').css({ top: y + plot_offset.top });  
  }
  
  function updateRanges() {
    var xunit = (params.local.time_units == 0 ? 'μs' : (params.local.time_units == 1 ? 'ms' : 's'));
    var axes = plot.getAxes();
    var xrange = axes.xaxis.max - axes.xaxis.min;
    var xmaxrange = 10.0;  // seconds
    var xminrange = 20e-9; // seconds
    var decimals = 0;

	/**********************************************/
	/**/ $.extend(params.local, {gain_ch1: 1}); /**/
	/**********************************************/
  
	
    if(xunit == 'μs' && xrange < 1) {
      xrange *= 1000;
      xunit = 'ns';
    }
    if(xrange < 1) {
      decimals = 1;
    }
    var seconds = (xunit == 'ns' ? 1e-9 : ( xunit == 'μs' ? 1e-6 : (xunit == 'ms' ? 1e-3 : 1)));
    
    $('#range_x').html(+(Math.round(xrange + "e+" + decimals) + "e-" + decimals) + ' ' + xunit);
    
    var nearest_x = getNearestRanges(xrange);
        
    // X limitations 
    if(nearest_x.next * seconds > xmaxrange) {
      nearest_x.next = null;
      $('#range_x_plus').prop('disabled', true);
    }
    else {
      $('#range_x_plus').prop('disabled', false);
    }
    if(nearest_x.prev * seconds < xminrange) {
      nearest_x.prev = null;
      $('#range_x_minus').prop('disabled', true);
    }
    else {
      $('#range_x_minus').prop('disabled', false);
    }
    
    $('#range_x_minus').data({ nearest: nearest_x.prev, unit: xunit }).data('bs.tooltip').options.title = nearest_x.prev;
    $('#range_x_plus').data({ nearest: nearest_x.next, unit: xunit }).data('bs.tooltip').options.title = nearest_x.next;
  }
  
  function getNearestRanges(number) {
    var log10 = Math.floor(Math.log(number) / Math.LN10); 
    var normalized = number / Math.pow(10, log10);    
    var i = 0;
    var prev = null;
    var next = null;
    
    while(i < range_steps.length - 1) {
      var ratio = range_steps[i+1] / normalized;
      if(ratio > 0.99 && ratio < 1.01) {
        prev = range_steps[i];
        next = range_steps[i+2];
        break;
      }
      if(range_steps[i] < normalized && normalized < range_steps[i+1]) {
        prev = range_steps[i];
        next = range_steps[i+1];
        break;
      }
      i++;
    }

    return { 
      prev: prev * Math.pow(10, log10), 
      next: next * Math.pow(10, log10) 
    };
  }
  
  function serverAutoScale() {
    params.local.auto_flag = 1;
    sendParams(true);
  }
  
  function getLocalDecimalSeparator() {
    var n = 1.1;
    return n.toLocaleString().substring(1,2);
  }
  
  function parseLocalFloat(num) {
    return +(num.replace(getLocalDecimalSeparator(), '.'));
  }
  
  function floatToLocalString(num) {
    // Workaround for a bug in Safari 6 (reference: https://github.com/mleibman/SlickGrid/pull/472)
    //return num.toString().replace('.', getLocalDecimalSeparator());
    return (num + '').replace('.', getLocalDecimalSeparator());
  }
  
  function shortenFloat(value) {
    return value.toFixed(Math.abs(value) >= 10 ? 1 : 3);
  }

  function convertHz(value) {
    var unit = '';
    var decsep = getLocalDecimalSeparator();
    
    if(value >= 1e6) {
      value /= 1e6;
      unit = '<span class="unit">MHz</span>';
    }
    else if(value >= 1e3) {
      value /= 1e3;
      unit = '<span class="unit">kHz</span>';
    }
    else {
      unit = '<span class="unit">Hz</span>';
    }

    // Fix to 4 decimal digits in total regardless of the decimal point placement
    var eps = 1e-2;
    if (value >= 100 - eps) {
      value = value.toFixed(1);
    }
    else if  (value >= 10 - eps) {
      value = value.toFixed(2);
    }
    else {
      value = value.toFixed(3);
    }
    
    value = (value == 0 ? '---' + decsep + '-' : floatToLocalString(value));
    return value + unit;
  }
  
  function izvoz()
  {
    //http://blog.eliacontini.info/post/79860720828/export-to-csv-using-javascript-the-download
    // some data to export
    // prepare CSV data
    var csvData = [];
    csvData.push('"karakteristika","id","U","I","P"');
    for (var i=0;i<meritve.length;++i)
    {
      var label=meritve[i].label;
      var data=meritve[i].data;
      for (var j=0;j<data.length;++j)
      {
        csvData.push('"'+label+'","'+(j+1)+'","'+data[j][0]+'","'+data[j][1]+'","'+data[j][0]*data[j][1]+'"');
      }
    }
    
    // download stuff
    var fileName = "data.csv";
    var buffer = csvData.join("\n");
    var blob = new Blob([buffer], {
      "type": "text/csv;charset=utf8;"			
    });
  
    var link = document.createElement("a");
    
    var a;
    if(link.download !== undefined)
    { // feature detection
      a = $('<a id="export"><span>export</span></a>');
      a.attr('href',window.URL.createObjectURL(blob));
      a.attr('download',fileName);
    }
    else if(navigator.msSaveBlob)
    { // IE 10+
      a = $('<a id="export" href="#"><span>export</span></a>');
      a.click(function()
              {
                navigator.msSaveBlob(blob, fileName);
                return false;
              });
    }
    
    a.hide();
    $('body').append(a);
    a.find('span').trigger('click');
    a.remove();
  }
  
  function zbrisi_karakteristiko()
  {
    if (meritve.length<2) return;
    cMeritev=parseInt($("#karakteristike").val());
    $('#legenda #l-'+meritve[cMeritev].ido).remove();
    meritve.splice(cMeritev,1);
    UI_selector();
    cMeritev=parseInt($("#karakteristike").val());
    tabela_init();
  }
  
  function zbrisi_meritev(i)
  {
    meritve[cMeritev].data.splice(i,1);
    tabela_init();
    reset_panels();
  }
  
  function onChangeUI()
  {
    cMeritev=parseInt($("#karakteristike").val());
    tabela_init(-1);
    plot_table_body();
    dodaj_vrstico(tr_template(),meritve[cMeritev].data.length+1);
  }
  
  function UI_selector()
  {
    var select='<select id="karakteristike" class="form-control">';
    for (var i = 0; i < meritve.length; ++i)
    {
      select+='<option value="'+i+'">'+meritve[i].label+'</option>';
    }
    
    $('#tabela_naslov').html(select+'</select>');
  }
  
  function addLegendItem(data,div)
  {
    var item='<div id="l-'+data.ido+'">';
    item+='<div class="pull-left" style="width:1em;height:1em;margin-top:0.2em;background-color:'+data.color+'">&nbsp;</div>';
    item+='<div style="font-size:small" class="pull-left">&nbsp;'+data.label+'</div>';
    
    var icon='glyphicon-eye-close';
    if (!data.visible) icon='glyphicon-eye-open';
    var onclk='toggleSeries('+data.ido+')';
    if (data.yaxis!==undefined && data.yaxis.n==2)
    {
      icon='glyphicon-eye-close';
      onclk='togglePower()';
      if (!show_power) icon='glyphicon-eye-open';
    }
    item+='<button id="sb-'+data.ido+'" onclick="'+onclk+'" type="button" class="btn btn-default btn-xs pull-right"><span class="glyphicon '+icon+'" aria-hidden="true"></span></button>';
    item+='</div>';
    item+='<div style="clear:both"></div>';
    
    div.append(item);
  }
  
  function nova_karakteristika()
  {
    var karakteristika_trans=$('#karakteristika_trans').text();
    cMeritev=meritve.length;
    var meritev_ini={ido:cMeritev, color:cMeritev+1, visible:true,label:karakteristika_trans+' '+(cMeritev+1),data:[]};
    if (cMeritev>0)
    {
      var n=meritve[cMeritev-1].ido+2;
      meritev_ini.ido=n-1;
      meritev_ini.label=karakteristika_trans+' '+n;
      meritev_ini.color=n;
    
    }
    meritve.push(meritev_ini);
    
    UI_selector();
    $("#karakteristike").val(cMeritev);
    $('#karakteristike').change(function(){onChangeUI()});
    
    tabela_init();
    
    plot1.setData(meritve);
    plot1.setupGrid();
    
    var data=plot1.getData();
    addLegendItem(data[data.length-1],$('#legenda'));
    
    reset_panels();
  }
  
  function tabela_init(k)
  {
    if (k===undefined) k=0;
    $('#tabela_body').empty();
    var data_length=meritve[cMeritev].data.length+k;
    var template=tr_template();
    for (var i=0;i<=data_length;++i)
    {
      dodaj_vrstico(template,i+1);
    }
  }
  
  function dodaj_vrstico(template,i)
  {
    $('#tabela_body').append(template);
    $('#tabela_body th:last').html(i);
  }
  
  function shrani_meritev()
  {
    meritve[cMeritev].data.push(zadnja_vrednost);
    
    var tmp=meritve[cMeritev].data;
    
    var tmer=[];
    for (var i=0;i<tmp.length;++i)
    {
      tmer.push({ 'A': tmp[i][0], 'B': tmp[i][1] });
    }
    
    tmer.sort(function(a, b) {
      return a.A - b.A;
    });
    
    var x=[];
    for(var i=0;i<tmer.length;++i)
    {
      x.push([tmer[i].A,tmer[i].B]);
    }
    
    meritve[cMeritev].data=x;
    
    var _m=[];
    for (var i=0;i<meritve.length;++i)
    {
      if (meritve[i].visible) _m.push(meritve[i]);
    }
    
    plot1.setData(_m);
    plot1.setupGrid();
    plot1.draw();
    
    tabela_init(-1);
    plot_table_body();
    dodaj_vrstico(tr_template(),x.length+1);
    $("#tbody-div").scrollTop($("#tbody-div")[0].scrollHeight);
    update_panels_state();
  }
  
  function convertSec(value) {
    var unit = '';
    var decsep = getLocalDecimalSeparator();
    
    if(value < 1e-6) {
      value *= 1e9;
      unit = '<span class="unit">ns</span>';
    }
    else if(value < 1e-3) {
      value *= 1e6;
      unit = '<span class="unit">μs</span>';
    }
    else if(value < 1) {
      value *= 1e3
      unit = '<span class="unit">ms</span>';
    }
    else {
      unit = '<span class="unit">s</span>';
    }

    // Fix to 4 decimal digits in total regardless of the decimal point placement
    var eps = 1e-2;
    if (value >= 100 - eps) {
      value = value.toFixed(1);
    }
    else if  (value >= 10 - eps) {
      value = value.toFixed(2);
    }
    else {
      value = value.toFixed(3);
    }
    
    value = (value == 0 ? '---' + decsep + '-' : floatToLocalString(value));
    return value + unit;
  }
  
  </script>
  <script src="../assets/redpitaya.custom.js"></script>
</head>
<body>
  <div class="header">
    <div class="container">
      <a id="btn_exit" class="pull-left" href="../../../apps"><span class="glyphicon glyphicon-chevron-left" title="Exit" alt="Exit"></span></a>
      <img class="logo pull-left" src="../assets/images/eEksperimenti_logo.png">
      <h2 class="page-title">UI karakteristike</h2>
    </div>
  </div>
  <div class="conteiner">
    <div class="row" style="padding: 2em 3em">
      <div class="col-md-3">
        <button id="nova_karakteristika" class="btn btn-primary btn-sm" style="width:49%;margin-bottom: 5px" onclick="nova_karakteristika()">nova</button>
        <button id="zbrisi_karakteristiko" class="btn btn-primary btn-sm" style="width:49%;margin-bottom: 5px" onclick="zbrisi_karakteristiko()">odstrani</button>
    <table class="table">
      <caption id='tabela_naslov'></caption>
      <thead>
        <tr>
          <th>#</th>
          <th>U</th>
          <th>I</th>
          <th>P</th>
          <th></th>
        </tr>
      </thead>
    </table>
    <div style="height:423px;overflow: auto" id="tbody-div">
      <table class="table">
        <tbody id='tabela_body'>
        </tbody>
      </table>
    </div>
    <div class="row">
      <div class="col-md-6">
        <button id="izvoz" style="width:98%" onclick="izvoz()" class="btn btn-primary btn-lg">izvoz</button>
      </div>
      <div class="col-md-6">
        <button id="shrani_meritev" class="btn btn-primary btn-lg" style="width:100%" onclick="shrani_meritev()">shrani meritev</button>
      </div>
    </div>
      </div>
      <div class="col-xs-12 col-sm-12 col-md-6">
        <div class="col-xs-12">
          <div class="graph-holder well well-small" id="plot1">
            <div class="ytitle">tok I / mA </div>
            <div class="y2title">moč P / &micro;W </div>
            <div class="plot_holder"></div>
            <div class="xtitle">napetost U / mV </div>
          </div>
        </div>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-3">
          <ul class="nav nav-tabs">
              <li class="active" style="text-center"><a style="text-center" data-toggle="tab" href="#meritve" > MERITVE </a></li>
              <li style="text-center">
                <a data-toggle="tab" href="#navodila1" style="text-center"> NAVODILA </a>
              </li>
          </ul>
            <div class="tab-content">
              <div class="tab-pane fade in active" id="meritve">
                <div class="col-md-12" style="padding: 0 2em;">
                  <div id='legenda'></div>
                  <div id='legenda-power'></div>
                  <hr>
                    <a class="btn btn-primary btn-xs" data-toggle="collapse" href="#nastavitve" aria-expanded="false" aria-controls="nastavitve">
                      Nastavitve
                    </a>
                    <div class="collapse" id="nastavitve" style="margin-top: 10px">
                      <div class="input-group input-group-sm" data-toggle="tooltip" data-placement="top" title="upornost merilnega upora za tok">
                        <span class="input-group-addon" id="sizing-addon3">R=</span>
                        <input id="rm" value="100" type="text" class="form-control" aria-describedby="sizing-addon3">
                        <span class="input-group-addon" id="sizing-addon3">&Omega;</span>
                      </div>
                      <div class="input-group input-group-sm" data-toggle="tooltip" data-placement="top" title="navodila: korak za napetost">
                        <span class="input-group-addon" id="sizing-addon3">Uk=</span>
                        <input id="uk" value="100" type="text" class="form-control" aria-describedby="sizing-addon3">
                        <span class="input-group-addon" id="sizing-addon3">mV</span>
                      </div>
                      <div class="input-group input-group-sm" data-toggle="tooltip" data-placement="top" title="tok 'odprtih sponk'">
                        <span class="input-group-addon" id="sizing-addon3">Im=</span>
                        <input id="im" value="0.01" type="text" class="form-control" aria-describedby="sizing-addon3">
                        <span class="input-group-addon" id="sizing-addon3">mA</span>
                      </div>
                      <hr>
                      <div class="checkbox">
                        <label style="font-size: 80%">
                          <input type="checkbox" id="auto-x" checked="checked"> avtomatska nastavitev osi X
                        </label>
                      </div>
                      <div class="row">
                        <div class="input-group input-group-sm col-md-6" style="padding-right: 5px">
                          <span class="label label-default">Xmin (mV)</span>
                          <input type="text" id="xmin" class="form-control" value="0" aria-describedby="sizing-addon3">
                         </div>
                        <div class="input-group input-group-sm col-md-6" style="padding-right: 5px">
                          <span class="label label-default">Xmax (mV)</span>
                          <input type="text" id="xmax" class="form-control" value="100" aria-describedby="sizing-addon3">
                        </div>
                      </div>
                      <hr>
                      <div class="checkbox">
                        <label style="font-size: 80%">
                          <input type="checkbox" id="auto-y" checked="checked"> avtomatska nastavitev osi Y1
                        </label>
                      </div>
                      <div class="row">
                        <div class="input-group input-group-sm col-md-6" style="padding-right: 5px">
                          <span class="label label-default">Ymin (mA)</span>
                          <input type="text" id="ymin" class="form-control" value="0" aria-describedby="sizing-addon3">
                         </div>
                        <div class="input-group input-group-sm col-md-6" style="padding-right: 5px">
                          <span class="label label-default">Ymax (mA)</span>
                          <input type="text" id="ymax" class="form-control" value="100" aria-describedby="sizing-addon3">
                        </div>
                      </div>
                      <hr>
                      <div class="checkbox">
                        <label style="font-size: 80%">
                          <input type="checkbox" id="auto-y2" checked="checked"> avtomatska nastavitev osi Y2
                        </label>
                      </div>
                      <div class="row">
                        <div class="input-group input-group-sm col-md-6" style="padding-right: 5px">
                          <span class="label label-default">Ymin (uW)</span>
                          <input type="text" id="ymin2" class="form-control" value="0" aria-describedby="sizing-addon3">
                         </div>
                        <div class="input-group input-group-sm col-md-6" style="padding-right: 5px">
                          <span class="label label-default">Ymax (uW)</span>
                          <input type="text" id="ymax2" class="form-control" value="100" aria-describedby="sizing-addon3">
                        </div>
                      </div>
                      <hr>
                      <div class="text-center">
                        <div style="padding-bottom: 10px;" class="group-label">X axis</div>
                        <div style="margin-bottom: -3px;" class="btn-group">
                          <button class="btn btn-primary range-btn-left btn-sm" type="button" id="range_x_minus" data-original-title="" title="">
                            <span class="glyphicon glyphicon-minus"></span>
                          </button>
                          <button class="btn btn-primary range-btn-right btn-sm" type="button" id="range_x_plus" data-original-title="" title="">
                            <span class="glyphicon glyphicon-plus"></span>
                          </button>
                        </div>
                        <div>
                          <span class="badge range-badge" id="range_x">20 μs</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="navodila1" style="padding: 2em">
                  Aplikacija eSončna celica je namenjena prikazu tokovno-napetostne (I-U) karakteristike sončne celice. 
                  Aplikacija je vezana na eEksperiment <a>Sončna celica</a>, ki se lahko izvaja v treh zahtevnostnih načinih. Če ste pravilno povezali potrebne komponente, se navodila za izvajanje eksperimenta nahajajo na sledečih povezavah:
                  <br>
                  <br>
                    -<a href="" id="lazji_navodila"> Enostaven način izvajanja</a>
                  <br>
                  <br>
                    -<a href="" id="srednji_navodila"> Srednje zahteven način izvajanja</a>
                  <br>
                  <br>
                    -<a href="" id="tezji_navodila"> Zahteven način izvajanja</a>
                </div>  
              </div>  
            </div>
          </div>
    </div>

    <!-------------------->
  <div id="modal_err" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_err_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_err_label">Application error</h4>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default btn-close-modal" id="btn_ignore">Ignore</button>
          <button type="button" class="btn btn-default" id="btn_retry_get">Retry</button>
          <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
        </div>
      </div>
    </div>
  </div>
  <div id="modal_app" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_app_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_app_label">Application stopped</h4>
        </div>
        <div class="modal-body">
          The <strong><span class="app-id"></span></strong> application was stopped. The current started application is <strong><span id="new_app_id"></span></strong>.<br />
          Do you want to switch to newly started application or to restart <strong><span class="app-id"></span></strong>?
        </div>
        <div class="modal-footer">
          <a href="/index.html" class="btn btn-danger pull-left">Exit app</a>
          <button type="button" class="btn btn-default" id="btn_switch_app">Switch</button>
          <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
        </div>
      </div>
    </div>
  </div>
  <hr>
  <div class="container" style="padding: 0 0 5em 0;"> 
    <div id="navodila"></div>
  </div>
  </div>
  <!--templates-->
  <div id="plot_holder" style='width:600px; display: none'></div>
  <span id='karakteristika_trans' style='display: none'>karakteristika</span>
</body>
</html>
