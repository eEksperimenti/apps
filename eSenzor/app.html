<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> eSenzor </title>
  <link href="../assets/bootstrap-3.0.0/css/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../assets/style.css" rel="stylesheet" type="text/css">
  <script src="../assets/bootstrap-3.0.0/js/jquery.js"></script>
  <script src="../assets/bootstrap-3.0.0/js/bootstrap.min.js"></script>
  <script src="../assets/highcharts.js"></script>
  <!--script src="../assets/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
  </script-->
  <script type="text/javascript">
  
  // Settings which can be modified
   
  var app_id = 'eSenzor';  
  var root_url = '';

  //var root_url = 'http://10.0.1.221';      // Test local
  //var root_url = 'http://192.168.53.133';  // Test remote and local
  //var root_url = 'http://192.168.1.100';   // Default RedPitaya IP
  
  var start_app_url = root_url + '/bazaar?start=' + app_id;
  var stop_app_url = root_url + '/bazaar?stop=';
  var get_url = root_url + '/data';
  var post_url = root_url + '/data';
  
  var update_interval = 50;              // Update interval for PC, milliseconds
  var update_interval_mobdev = 500;      // Update interval for mobile devices, milliseconds 
  var request_timeout = 3000;            // Milliseconds
  var long_timeout = 20000;              // Milliseconds
  var meas_panel_dec = 5;                // Decimation for numerical measure panel to make it human readable
  
  /////////// eSenzorji /////////

  var senzorji_podatki = [[], [], [], []];
  var t = 0;
  var j = 0;

  var cas = 0;
  var st_meritev = 0;
  var dolzina_meritve = 0; 

  var ime = "";
  var oznaka = "";
  var enota = "";

  var ustavi = 0;
  var koncaj = 0;

  if(sessionStorage.kolicine != null){
    ime = JSON.parse(sessionStorage.kolicine)[0].ime;
    oznaka = JSON.parse(sessionStorage.kolicine)[0].oznaka;
    enota = JSON.parse(sessionStorage.kolicine)[0].enota;
  }

  var change;

  // Settings which should not be modified
  
  var update_timer = null;
  var zoompan_timer = null;
  var downloading = false;
  var sending = false;
  var send_que = false;
  var use_long_timeout = false;
  var trig_dragging = false;
  var touch_last_y = 0;
  var user_editing = false;
  var app_started = false;
  var last_get_failed = false;
  var refresh_counter = 0;
  var autorun = 1;
  var datasets = [];
  var params = {
    original: null,
    local: null
  };
  
  // Default parameters - posted after server side app is started 
  var def_params = {
    en_avg_at_dec: 0
  }; 

  // On page loaded

  $(function() {

    ////////////// aplikacija s signali ////////////

    $("#obstojece").height($("#nastavi").height());
    $("#merjenje").height($("#obstojece").height());

    if(sessionStorage.poljubno != null){

      if(sessionStorage.poljubno == "1"){
        $("#dodaj").parent().css("display", "");
      }
    } 

    var barve = ["#E6E600", "#FF0000", "#006633", "#000099", "#CC66CC", "#CC9900", "#CCCCFF", "#99CC99", "#99CCFF", "#000000", "#FFCCCC"];

    var nastavitve = {
        chart: {
          plotBackgroundColor: '#F2F2F2',
          renderTo: 'senzorji_graf',
          zoomType: 'x'
        },
        title: {
          text: "",
        },
        xAxis: {
          min: 0,
          gridLineWidth: 1,
          title: {
              enabled: true,
              useHTML: true,
              text: '<h4> Čas [ms] </h4>'
          },
          showLastLabel: true
        },
        yAxis: {
          plotLines: [{
            value: 0,
            width: 1,
            color: '#808080'
          }],
          allowDecimals: true,
          min: 0,
          max: 4,
          title: {
            useHTML: true,
            margin: 35,
            text: '<h4> Vrednosti količin </h4>'
          }
        },
        legend: {
          layout: 'vertical',
          align: 'right',
          verticalAlign: 'middle'
        },
        plotOptions: {
          line: {
            marker: {
                enabled: false,
                states: {
                    hover: {
                        enabled: false
                    }
                }
            }
          },
          series: {
                lineWidth: 2,
            states: {
              hover: {
                enabled: true,
                lineWidth: 2
              }
            }
          }
        },
        series: [],
        tooltip: {
          enabled: false,
          headerFormat: '<b>{series.name}</b><br>',
          pointFormat: 'x: {point.x}, y: {point.y}'
        },
    };

    if(oznaka == "a"){
      nastavitve.yAxis.min = -200;
      nastavitve.yAxis.max = 200;
    }
    else if(oznaka == "B"){

    }
    else if(oznaka == "T"){

    }
    else if(oznaka == "Napetost"){

    }
    else if(oznaka == "E"){

    }
    else if(oznaka == "p"){

    }

    nastavitve.yAxis.title.text = "<h4>" + JSON.parse(sessionStorage.kolicine)[0].ime + " [ " + JSON.parse(sessionStorage.kolicine)[0].enota + " ] </h4>";
    var graf = new Highcharts.Chart(nastavitve);

    function ponovnoNarisiGraf(){

      nastavitve.tooltip.enabled = false;
      graf = new Highcharts.Chart(nastavitve);
      nastavitve = graf.options;
    }

    $("#tabela_signalov").find(".col-xs-6").eq(1).html(
      JSON.parse(sessionStorage.kolicine)[0].ime + " [ " + JSON.parse(sessionStorage.kolicine)[0].enota + " ]"
    );

    $('#start').on('click', function(){

      cas = parseFloat($('#cas').val());
      st_meritev = parseInt($('#st_meritev').val());
      dolzina_meritve = cas*st_meritev;

      if(veljavenCas() && veljavneMeritve()){

        $("#neveljavno").css("display", "none");

        if(params.local != null){

          params.local.delta_T = cas;
          params.local.num_of_meas = st_meritev;
          params.local.trig_mode = 0;
          params.local.meas_control = 0;
          
          sendParams();
        }
      }
      else{
        $("#neveljavno").css("display", "");
      }

      // zacetek meritev ali po pritisku koncaj
      if(ustavi == 0 && t < dolzina_meritve){
        t = cas;
        graf.series[0].addPoint([0, 0], false);
      }

      ustavi = 0;
      koncaj = 0;
    });

    $("#ustavi").on("click", function(){

      if(params.local != null){

        if(params.local.meas_control == 1){
          params.local.meas_control = 2;
          sendParams();
        }
        else if(params.local.meas_control != 1){
          params.local.meas_control = 1;
          sendParams();
        }
      }

      ustavi = 1;

    });

    $("#koncaj").on("click", function(){

      if(params.local != null){

        params.local.meas_control = 3;
        params.local.change = 0;
        sendParams();
      }

      t = 0;
      senzorji_podatki[0] = [];

      graf.series[0].remove();
      if(sessionStorage.kolicine != undefined){
        dodajKolicine(true);
      }

      koncaj = 1;

      $('#tabela_signalov').html("");

      $('#tabela_signalov').append(
        "<div class='row' style='border-bottom: solid 1px #D3D3D3;'> <div class='col-xs-6 text-center'> ČAS </div><div class='col-xs-6 text-center'>" + JSON.parse(sessionStorage.kolicine)[0].ime + " [ " + JSON.parse(sessionStorage.kolicine)[0].enota + " ]" + "</div>"
      );
    });

    /////////// opozorila //////////

    function opozorilo(vsebina){

      var o = $("#formulaNapaka");

      o.css("display", "");
      o.empty();
      o.append(vsebina);
    };

    function veljavnaFormula( formula ){

      var uklepaji = 0;
      var zaklepaji = 0;

      for(var i = 0; i < formula.length; i++){
        if(formula[i] == " ( "){
          uklepaji++;
        }
        else if(formula[i] == " ) "){
          zaklepaji++;
        }
      }

      if(uklepaji == zaklepaji){
        return 0;
      }
      else if( uklepaji < zaklepaji ){
        return 1;
      }
      else if( uklepaji > zaklepaji){
        return -1;
      }
      else{
        return 99;
      }
    };

    function veljavenCas(){

      var cas = parseFloat($('#cas').val());

      if(isNaN(cas)){
        return false;
      }

      if(cas >= 0.001 && cas <= 10000000000){
        return true;
      }
      else{
        return false;
      }
    };

    function veljavneMeritve(){
      var st_meritev = parseInt($('#st_meritev').val());

      if(isNaN(st_meritev)){
        return false;
      }

      if(st_meritev >= 1 && st_meritev <= 10000000){
        return true;
      }
      else{
        return false;
      }
    };

    function veljavenKanal(){

      if($("#izbiraKanala option:selected").attr("id") == "k0"){

        $(".izbira_kanala_warning").css("display", "");
        return false;
      }
      else{

        $(".izbira_kanala_warning").css("display", "none");
        return true;
      }
    };

    ///////////// kliki na zavihke //////////////

    $("#nastavitve").on("click", function(){

      $("#nastavi").css("display", "");
      $("#meri").css("display", "none");
      $("#prikazi").css("display", "none");
    });

    $("#meritve").on("click", function(){

      $("#meri").css("display", "");
      $("#nastavi").css("display", "none");
      $("#prikazi").css("display", "none");
    });

    $("#prikaz").on("click", function(){

      $("#prikazi").css("display", "");
      $("#nastavi").css("display", "none");
      $("#meri").css("display", "none");
    });
    
    ///////////// formula //////////////

    var formula = [];
    var operatorji = [" + ", " - ", "\\cdot ", " / ", " ^ ", " \\log "];
    var kanali = ["V_{1}", "V_{2}", "V_{3}", "V_{4}"];

    function izpisFormule(){

      var f = "";

      for(var i = 0; i < formula.length; i++){
        f += formula[i];
      }

      var texexp = math.parse(f).toTex();
      $("#formula").html("$$" + texexp + "$$");
      var rezultat = math.eval(f);

      $("#formulaNapaka").css("display", "none");

      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }

    function preberiFormulo(){

      return formula.toString();
    }

    $("#uklepaj").on("click", function(){
      if(operatorji.indexOf(formula[formula.length - 1]) != -1 || formula.length == 0 || formula[formula.length - 1] == " ( "){

        formula[formula.length] = " ( ";
        izpisFormule();
      }
      else{
        opozorilo("Pred uklepajem mora stati operator.");
      }
    });

    $("#zaklepaj").on("click", function(){
      if(kanali.indexOf(formula[formula.length - 1]) != -1 || !isNaN(formula[formula.length - 1]) || formula[formula.length - 1] == " ) "){

        formula[formula.length] = " ) ";
        izpisFormule();
      }
      else{
        opozorilo("Pred zaklepajem mora stati kanal ali konstanta.");
      }
    });

    $("#izbrisi").on("click", function(){
      formula.pop();

      izpisFormule();
    });

    $("#izbrisiVso").on("click", function(){
      formula = [];

      izpisFormule();
    });

    $("#logaritem").on("click", function(){
      if(operatorji.indexOf(formula[formula.length - 1]) != -1 ){
        formula[formula.length] = " \\log ";

        izpisFormule();
      }
      else if( operatorji.indexOf(formula[formula.length - 2]) != -1 && !isNaN(formula[formula.length - 1])){
        formula[formula.length] = " \\log ";

        izpisFormule();
      }
      else{
        opozorilo("Pred logaritmom mora stati operator.");
      }
    });

    $("#potenca").on("click", function(){
      if(kanali.indexOf(formula[formula.length - 1]) != -1 || formula[formula.length - 1] == " ) " || !isNaN(formula[formula.length - 1])){
        formula[formula.length] = " ^ ";

        izpisFormule();
      }
      else if( operatorji.indexOf(formula[formula.length - 2]) != -1 && !isNaN(formula[formula.length - 1])){
        formula[formula.length] = " ^ ";

        izpisFormule();
      }
      else{
        opozorilo("Pred izbiro operatorja morate izbrati kanal.");
      }
    });

    $("#deljeno").on("click", function(){
      if(kanali.indexOf(formula[formula.length - 1]) != -1 || formula[formula.length - 1] == " ) " || !isNaN(formula[formula.length - 1])){
        formula[formula.length] = " / ";

        izpisFormule();
      }
      else if( operatorji.indexOf(formula[formula.length - 2]) != -1 && !isNaN(formula[formula.length - 1])){
        formula[formula.length] = " / ";

        izpisFormule();
      }
      else{
        opozorilo("Pred izbiro operatorja morate izbrati kanal.");
      }
    });

    $("#krat").on("click", function(){
      if(kanali.indexOf(formula[formula.length - 1]) != -1 || formula[formula.length - 1] == " ) " || !isNaN(formula[formula.length - 1])){
        formula[formula.length] = "\\cdot ";

        izpisFormule();
      }
      else if( operatorji.indexOf(formula[formula.length - 2]) != -1 && !isNaN(formula[formula.length - 1])){
        formula[formula.length] = "\\cdot ";

        izpisFormule();
      }
      else{
        opozorilo("Pred izbiro operatorja morate izbrati kanal.");
      }
    });

    $("#minus").on("click", function(){
      if(kanali.indexOf(formula[formula.length - 1]) != -1 || formula[formula.length - 1] == " ) " || !isNaN(formula[formula.length - 1])){
        formula[formula.length] = " - ";

        izpisFormule();
      }
      else if( operatorji.indexOf(formula[formula.length - 2]) != -1 && !isNaN(formula[formula.length - 1])){
        formula[formula.length] = " - ";

        izpisFormule();
      }
      else{
        opozorilo("Pred izbiro operatorja morate izbrati kanal.");
      }
    });

    $("#plus").on("click", function(){
      if(kanali.indexOf(formula[formula.length - 1]) != -1 || formula[formula.length - 1] == " ) " || !isNaN(formula[formula.length - 1])){
        formula[formula.length] = " + ";

        izpisFormule();
      }
      else if( operatorji.indexOf(formula[formula.length - 2]) != -1 && !isNaN(formula[formula.length - 1])){
        formula[formula.length] = " + ";

        izpisFormule();
      }
      else{
        opozorilo("Pred izbiro operatorja morate izbrati kanal.");
      }
    });

    $("#kanal1").on("click", function(){
      if(operatorji.indexOf(formula[formula.length - 1]) != -1 || !isNaN(formula[formula.length - 1]) || formula.length == 0 || formula[formula.length - 1] == " ( "){
        formula[formula.length] = "V_{1}";

        izpisFormule();
      }
      else{
        opozorilo("Pred izbiro kanala morate izbrati konstanto ali operator.");
      }
    });

    $("#kanal2").on("click", function(){
      if(operatorji.indexOf(formula[formula.length - 1]) != -1 || !isNaN(formula[formula.length - 1]) || formula.length == 0 || formula[formula.length - 1] == " ( "){
        formula[formula.length] = "V_{2}";

        izpisFormule();
      }
      else{
        opozorilo("Pred izbiro kanala morate izbrati konstanto ali operator.");
      }
    });

    $("#kanal3").on("click", function(){
      if(operatorji.indexOf(formula[formula.length - 1]) != -1 || !isNaN(formula[formula.length - 1]) || formula.length == 0 || formula[formula.length - 1] == " ( "){
        formula[formula.length] = "V_{3}";

        izpisFormule();
      }
      else{
        opozorilo("Pred izbiro kanala morate izbrati konstanto ali operator.");
      }
    });

    $("#kanal4").on("click", function(){
      if(operatorji.indexOf(formula[formula.length - 1]) != -1 || !isNaN(formula[formula.length - 1]) || formula.length == 0 || formula[formula.length - 1] == " ( "){
        formula[formula.length] = "V_{4}";

        izpisFormule();
      }
      else{
        opozorilo("Pred izbiro kanala morate izbrati konstanto ali operator.");
      }
    });

    $("#dodajKonstanto").on("click", function(){

      $("#formulaNapaka").css("display", "none");

      if(!isNaN(parseFloat($("#konstanta").val())) && (operatorji.indexOf(formula[formula.length - 1]) != -1 || formula.length == 0)){
        formula[formula.length] = parseFloat($("#konstanta").val());

        izpisFormule();
      }
      else if(formula[formula.length - 1] == " ( "){

        formula[formula.length] = parseFloat($("#konstanta").val());
        izpisFormule();
      }
      else if(isNaN(parseFloat($("#konstanta").val()))){
        opozorilo("Vnesite veljavno konstanto.");
      }
      else if( operatorji.indexOf(formula[formula.length - 1]) == -1){
        opozorilo("Pred konstanto vnesite operator.");
      }
      $("#konstanta").val("");
    });

    ////////////////////////  izracun kolicin  ////////////////////////////

    function dodajKolicine(vse){

      var kolicine = JSON.parse(sessionStorage.kolicine);
      var n = kolicine.length;

      var k = "";
      var i;
      var x;
      var y;

      for(i = 0; i < n; i++){

        if(vse){
          if(kolicine[i].ime == undefined || kolicine[i].oznaka == undefined || kolicine[i].enota == undefined || kolicine[i].formula == undefined){

            kolicine.splice(i, 1);
            sessionStorage.setItem("kolicine", JSON.stringify(kolicine));

            break;
          }
        }

        k += "<div class='row text-center' style='border-bottom: 1px solid #ddd; margin: 0;'> <div class='col-xs-3 text-center' style='border-left: 1px solid #ddd; padding: 0.5em 0;'>" +  kolicine[i].ime + "</div><div class='col-xs-2 text-center' style='border-left: 1px solid #ddd; padding: 0.5em 0;'>" +  kolicine[i].oznaka + "</div><div class='col-xs-2 text-center' style='border-left: 1px solid #ddd; padding: 0.5em 0;'>" +  kolicine[i].enota + "</div><div class='col-xs-5 text-center' style='border-left: 1px solid #ddd; border-right: 1px solid #ddd; padding: 0.5em 0;'>" + kolicine[i].formula + "</div></div> </div>"
      
        dodajFunkcijoVgraf(kolicine[i].ime);

        x = document.createElement("option");
        x.value = kolicine[i].ime;
        x.innerHTML = kolicine[i].ime;

        y = document.createElement("option");
        y.value = kolicine[i].ime;
        y.innerHTML = kolicine[i].ime;

        $("#osX").append(x);
        $("#osY").append(y);
      }

      $("#kolicine").html("");
      $("#kolicine").append(k);
    }

    function dodajFunkcijoVgraf(ime){

      var barva = parseInt(sessionStorage.steviloKolicin) - 1;

      graf.addSeries({

        useHTML: true,
        name: '<h4>' + ime + '</h4>',
        color: barve[barva],
        data: []
      });

      barva++;
    }

    function dodajKolicinoVjson(prvic, lastnost, vrednost){

      var kolicine = sessionStorage.kolicine;
      var steviloKolicin;

      if(kolicine == null){

        kolicine = [];
        kolicine[0] = {};
        kolicine[0][lastnost] = vrednost;

        sessionStorage.setItem("kolicine", JSON.stringify(kolicine));
        sessionStorage.setItem("steviloKolicin", 1);
      }
      else{

        kolicine = JSON.parse(kolicine);
        steviloKolicin = parseInt(sessionStorage.steviloKolicin);

        if(prvic){

          kolicine[steviloKolicin - 1] = {};
          kolicine[steviloKolicin - 1][lastnost] = vrednost;
        }
        else{
          kolicine[steviloKolicin - 1][lastnost] = vrednost;

          if(lastnost === "formula"){
            sessionStorage.setItem("steviloKolicin", parseInt(sessionStorage.getItem("steviloKolicin")) + 1);
          }
        }
        sessionStorage.setItem("kolicine", JSON.stringify(kolicine));
      }
    }

    $("#dodaj").click(function(){

      var o = $("#obstojece");

      o.find(".panel-heading").html("<h4>Dodajanje količine</h4>");
      o.find("#originalno").css("display", "none");
      o.find("#dodajanjeImena").css("display", "");
    });

    $("#dodajIme").click(function(){

      var o = $("#obstojece");

      ime = o.find("#ime").val();

      if(ime.replace(/^\s+|\s+$/gm,'') != ""){

        o.find("#dodajanjeImena").css("display", "none");
        o.find("#dodajanjeOznake").css("display", "");

        dodajKolicinoVjson(true, "ime", ime);
        o.find("#ime").val("");
      }
    });

    $("#dodajOznako").click(function(){

      var o = $("#obstojece");
      oznaka = o.find("#oznaka").val();

      if(oznaka.replace(/^\s+|\s+$/gm,'') != ""){
        
        o.find("#dodajanjeOznake").css("display", "none");
        o.find("#dodajanjeEnote").css("display", "");

        dodajKolicinoVjson(false, "oznaka", oznaka);
        o.find("#oznaka").val("");
      }
    });

    $("#dodajEnoto").click(function(){

      var o = $("#obstojece");
      enota = o.find("#enota").val();

      if(enota.replace(/^\s+|\s+$/gm,'') != ""){

        o.find("#dodajanjeEnote").css("display", "none");
        o.find("#dodajanjeFormule").css("display", "");

        o = $("#obstojece");

        var h = o.find("#dodajanjeFormule").height();

        o.height(h + 100);
        
        dodajKolicinoVjson(false, "enota", enota);
        o.find("#enota").val("");
      }
    });

    $("#dodajFormulo").click(function(){

      var o = $("#obstojece");

      o.find("#dodajanjeFormule").css("display", "none");
      o.find("#originalno").css("display", "");

      o = $("#obstojece");

      var maks = Math.max(o.find(".panel-body").height(), $("#merjenje").height());

      o.find(".panel-body").height(maks);
      o.height(maks);

      formula = preberiFormulo();

      dodajKolicinoVjson(false, "formula", formula);
      dodajKolicine(false);

      o.find(".panel-heading").html("<h4>Obstoječe količine</h4>");

      $("#formula").html("");
      formula = [];
    });

    $("#izbrisiVse").click(function(){

      sessionStorage.removeItem("kolicine");
      sessionStorage.removeItem("steviloKolicin");

      var x = document.getElementById("osX");
      var y = document.getElementById("osY");
      var i;

      for(i = 2; i < x.length; i++){
        x.remove(i);
        y.remove(i - 1);
      }

      $("#kolicine").html("");
      ponovnoNarisiGraf();
    });

    if(sessionStorage.kolicine != undefined){
      dodajKolicine(true);
    }

    /////////////////////// osnovna aplikacija  ///////////////////////////
    
    // Show different buttons on touch screens    
    if(window.ontouchstart === undefined) {}
    else {
      update_interval = update_interval_mobdev;
      meas_panel_dec = meas_panel_dec_mobdev;
    }
    
    // Add application ID in the message from modal popup
    $('.app-id').text(app_id);
    
    // Disable all controls until the params state is loaded for the first time 
    /*$('input, select, button', '.container').prop('disabled', true);*/
          
    // Modals
    
    $('#modal_err, #modal_app').modal({ show: false, backdrop: 'static', keyboard: false });
    $('#modal_upload').modal({ show: false });
    
    // Load first data
    updateGraphData();
    
    // Stop the application when page is unloaded
    window.onbeforeunload = function() { 

      $.ajax({
        url: stop_app_url,
        async: false
      });
    };
            
  });
  
  function startApp() {
	
    $.get(
      start_app_url
    )
    .done(function(dresult) {
      if(dresult.status == 'ERROR') {
        showModalError((dresult.reason ? dresult.reason : 'Could not start the application.'), true);
      }
      else {
        $.post(
          post_url, 
          JSON.stringify({ datasets: { params: def_params } })
        )
        .done(function(dresult) {
          app_started = true;
          updateGraphData();      
        })
        .fail(function() {
          showModalError('Could not initialize the application with default parameters.', false, true);
        });
      }
    })
    .fail(function() {
      showModalError('Could not start the application.', true);
    });
  }
  
  function showModalError(err_msg, retry_btn, restart_btn, ignore_btn) {
    var err_modal = $('#modal_err');
    
    err_modal.find('#btn_retry_get')[retry_btn ? 'show' : 'hide']();
    err_modal.find('.btn-app-restart')[restart_btn ? 'show' : 'hide']();
    err_modal.find('#btn_ignore')[ignore_btn ? 'show' : 'hide']();
    err_modal.find('.modal-body').html(err_msg);
    err_modal.modal('show');
  }   
  
  function updateGraphData() {
  
    if(downloading) {
      return;
    }
    if(update_timer) {
      clearTimeout(update_timer);
      update_timer = null;
    }
    downloading = true;

    // Send params if there are any unsent changes
    sendParams();

    var arun_before_ajax = autorun;
    var long_timeout_used = use_long_timeout;
    
    change = 0;

    if(params.local != null){
      change = params.local.change;
    }

    $.ajax({
      url: get_url,
      timeout: (use_long_timeout ? long_timeout : request_timeout),
      cache: false
    })
    .done(function(dresult) {
      last_get_failed = false;
      
      if(dresult.status === 'ERROR') {
        if(! app_started) {
          startApp();
        }
        else {
          showModalError((dresult.reason ? dresult.reason : 'Application error.'), true, true);
        }
      }
      else if(dresult.datasets !== undefined && dresult.datasets.params !== undefined) {
        // Check if the application started on the server is the same as on client
        if(app_id !== dresult.app.id) {
          if(! app_started) {
            startApp();
          }
          else {
            $('#new_app_id').text(dresult.app.id);
            $('#modal_app').modal('show');
          }
          return;
        }
        
        app_started = true;
      
        // Check if trigger mode (which may switch autorun) was changed during ajax request
        var arun_after_ajax = autorun;
        
        datasets = [];
		    var t_channel=$('#t-channel').text();

        for(var i = 0; i < dresult.datasets.g1.length; i++) {
          dresult.datasets.g1[i].color = i;
          dresult.datasets.g1[i].label = t_channel + (i+1);          
          datasets.push(dresult.datasets.g1[i]);
        }

        // Apply the params state received from server if not in edit mode
        if(! user_editing) {
          loadParams(dresult.datasets.params);
            
            // Restore the autorun value modified by loadParams 
          if(arun_before_ajax != arun_after_ajax) {
              autorun = arun_after_ajax; 
          }
        }

        // nova vrednost senzorja
        if(params.local != null){
          if(params.local.change != change){
            getData();
            graf.redraw();
          }
        }
        
        if(autorun || dresult.status === 'AGAIN') {
          
          update_timer = setTimeout(function() {
            updateGraphData();
          }, update_interval);
        }
      }
      else {
        showModalError('Wrong application data received.', true, true);
      }
    })
    .fail(function(jqXHR, textStatus, errorThrown) {
      if(last_get_failed) {
        showModalError('Data receiving failed.<br>Error status: ' + textStatus, true, true);
        last_get_failed = false;
      }
      else {
        last_get_failed = true;
        downloading = false;
        updateGraphData();  // One more try
      }
    })
    .always(function() {
      if(! last_get_failed) {
        downloading = false;        
      }
      
      if(long_timeout_used) {
        use_long_timeout = false;
      }
    });
  }
  
  function loadParams(orig_params) {
    if(! $.isPlainObject(orig_params)) {
      return;
    }
    
    // Same data in local and original params
    params.original = $.extend({}, orig_params);
    params.local = $.extend({}, params.original);

    // Autorun if trigger mode is Auto(0) or Normal(1), stop if it is Single(2)
    autorun = (params.original.trig_mode == 2 ? 0 : 1);
  }
  
  function isParamChanged() {
    if(params.original) {
      for(var key in params.original) {
        if(params.original[key] != params.local[key]) {
          return true;
        }
      }
    }
    return false;
  }
  
  function sendParams(refresh_data, force_send, single_btn) {

    if(sending || (force_send !== true && !isParamChanged())) {
      send_que = sending;
      return;
    }
    
    var auto_flag = params.local.auto_flag;  // Keep the value of auto_flag, because in POST response it is always 0
    sending = true;
    params.local.single_btn = (single_btn === true ? 1 : 0);
    use_long_timeout = !!auto_flag;
  
    $.ajax({
      type: 'POST',
      url: post_url,
      data: JSON.stringify({ datasets: { params: params.local } }),
      timeout: (use_long_timeout ? long_timeout : request_timeout),
      cache: false
    })
    .done(function(dresult) {
      // OK: Load the params received as POST result
      if(dresult.datasets !== undefined && dresult.datasets.params !== undefined) {
      
        loadParams(dresult.datasets.params);
        
        if(refresh_data && !downloading) {
          updateGraphData();
        }

      }
      else if(dresult.status == 'ERROR') {
        showModalError((dresult.reason ? dresult.reason : 'Error while sending data (E1).'), false, true, true);
        send_que = false;
      }
      else {
        showModalError('Error while sending data (E2).', false, true, true);
      }


    })
    .fail(function() {
      showModalError('Error while sending data (E3).', false, true, true);
    })
    .always(function() {
      sending = false;
      user_editing = false;
      
      if(send_que) {
        send_que = false;
        setTimeout(function(refresh_data) {
          sendParams(refresh_data);
        }, 100);
      }
    });
  }
  
  var s = [];

  function getData(from, to) {

    if(koncaj == 0){

      graf = $("#senzorji_graf").highcharts();

      for(j = 0; j < 512; j++) {

        if((datasets[0].data[j][0] > -50) && (datasets[0].data[j + 512][1] > -50) && (datasets[1].data[j][0] > -50) && (datasets[1].data[j +512][1] > -50)){
          
          if(oznaka == "a"){
            s[0] = 166.7*datasets[0].data[j][1] - 250;
          }
          else if(oznaka == "B"){
            s[0] = 22.22*datasets[0].data[j][1] - 22.22;
          }
          else if(oznaka == "T"){
            s[0] = 13150/datasets[0].data[j][1] - 2893;
          }
          else if(oznaka == "Napetost"){
            s[0] = datasets[0].data[j][1];
          }
          else if(oznaka == "E"){
            s[0] = 18380*datasets[0].data[j][1];
          }
          else if(oznaka == "p"){
            s[0] = 1750*datasets[0].data[j][1] - 875;
          }

          s[0] = Math.round(s[0]*10000)/10000;

          graf.series[0].addPoint([t, s[0] ], false);

          $('#tabela_signalov').append(

            "<div class='row' style='border-bottom: solid 1px #D3D3D3;'> <div class='col-xs-6 text-center'>" + t + "</div><div class='col-xs-6 text-center'>" + s[0] + "</div>"
          );

          senzorji_podatki[0].push([t, s[0]]);

          t += cas;
        }
        else{
          break;
        }
      }
    }
  }
    
  </script>
  <script src="../assets/redpitaya.custom.js"></script>
</head>
<body>
  <div class="header">
    <div class="container">
      <a id="btn_exit" class="pull-left" href="index.html"><span class="glyphicon glyphicon-chevron-left" title="Exit" alt="Exit"></span></a>
      <img class="logo pull-left" src="../assets/images/eEksperimenti_logo.png">
      <h2 class="page-title pull-left"> eSenzor </h2>
    </div>
  </div>
  
  <div id="modal_err" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_err_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_err_label">Application error</h4>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default btn-close-modal" id="btn_ignore">Ignore</button>
          <button type="button" class="btn btn-default" id="btn_retry_get">Retry</button>
          <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
        </div>
      </div>
    </div>
  </div>
  <div id="modal_app" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_app_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_app_label">Application stopped</h4>
        </div>
        <div class="modal-body">
          The <strong><span class="app-id"></span></strong> application was stopped. The current started application is <strong><span id="new_app_id"></span></strong>.<br />
          Do you want to switch to newly started application or to restart <strong><span class="app-id"></span></strong>?
        </div>
        <div class="modal-footer">
          <a href="/index.html" class="btn btn-danger pull-left">Exit app</a>
          <button type="button" class="btn btn-default" id="btn_switch_app">Switch</button>
          <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
        </div>
      </div>
    </div>
  </div>
      <div class="container" style="padding: 1em 0 5em 0; margin: 2em auto; width: 90%;">
        <div class="row">
          <ul class="nav nav-tabs">
            <li class="active" id="nastavitve" style="width: 33%;" ><a class="text-center" data-target="#nastavi" aria-controls="#nastavi" role="tab" data-toggle="tab" style="cursor: pointer;"> NASTAVITVE </a></li>
            <li id="prikaz" style="width: 33%;"><a class="text-center" aria-controls="#prikazi" data-target="#prikazi" role="tab" data-toggle="tab" style="cursor: pointer;"> GRAF </a></li>
            <li id="meritve" style="width: 34%;"><a class="text-center" aria-controls="#meri" data-target="#meri" role="tab" data-toggle="tab" style="cursor: pointer;"> MERITVE </a></li>
          </ul>
        </div>
        <div role="tabpanel" class="tab-pane fade in active row" id="nastavi" style="padding: 0 1em; border-left: 1px solid #ddd; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd;">
          <div class="row" style="margin: 2em 0 2em 0;">
            <div class="col-xs-5 panel panel-primary" id="merjenje" style="padding: 0; margin: 0;">
              <div class="panel-heading text-center" style="padding: 0.2em;">
                <h4>
                  Merjenje 
                </h4>
              </div>
              <div class="panel-body">
                <div class="row form-inline" style="padding: 1em 1em 0 1em;">
                  <div class="col-xs-6">
                    <div class="row text-center"> ena meritev na vsakih </div>
                    <div class="row text-center">
                      <input type="number" id="cas" min="0.001" max="100000000000" style="margin: 0 2em;">ms
                    </div>
                  </div>
                  <div class="col-xs-6" style="display: none;">
                    <div class="row text-center"> povprečenje meritev: </div>
                    <div class="row text-center">
                      <form class="form-group"> 
                        <input type="radio" style="margin-left: 1em;"> DA 
                        <input type="radio" style="margin-left: 1em;"> NE 
                      </form>
                    </div>
                  </div>
                <!--/div> 
                <div class="row form-inline" style="padding: 2em 1em 1em 1em;"-->
                  <div class="col-xs-6">
                    <div class="row text-center"> število meritev </div>
                    <div class="row text-center">
                      <input type="number" id="st_meritev" min="1" max="10000000">
                    </div> 
                  </div>
                  <div class="col-xs-6 text-center" style="display: none;">
                    <div class="col-xs-6">
                      <div class="row"> os X: </div>
                      <div class="row"> 
                        <select id="osX">
                          <option value="0"> Izberite </option>
                          <option value="1"> Čas </option>
                        </select>
                      </div>
                    </div>
                    <div class="col-xs-6">
                      <div class="row"> os Y: </div>  
                      <div class="row">
                        <select id="osY">
                          <option value="0"> Izberite </option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>      
              </div>
            </div>
            <div class="col-xs-7" style="padding: 0; margin: 0;">
              <div class="col-xs-12 panel panel-info" id="obstojece" style="padding: 0; margin: 0;">
                <div class="panel-heading text-center" style="padding: 0.2em;">
                  <h4> Obstoječe količine </h4>
                </div>
                <div class="panel-body text-center" style="padding: 1em 0 0 0; margin: 0;">
                  <div id="originalno" class="text-center">
                    <div class="row" style="border-top: 1px solid #ddd; border-bottom: 3px solid #ddd; margin: 0 1em;">
                      <div class="col-xs-3" style="padding: 0.5em 0; border-left: 1px solid #ddd;"> IME </div>
                      <div class="col-xs-2" style="padding: 0.5em 0; border-left: 1px solid #ddd;"> SIMBOL </div>
                      <div class="col-xs-2" style="padding: 0.5em 0; border-left: 1px solid #ddd;"> ENOTA </div>
                      <div class="col-xs-5" style="padding: 0.5em 0; border-left: 1px solid #ddd; border-right: 1px solid #ddd;"> IZRAČUN </div>
                    </div>
                    <div class="row" id="kolicine" style="margin: 0 1em;">

                    </div>
                    <div class="row" style="padding-top: 1em; display: none;">
                      <button class="btn btn-default" id="dodaj"> 
                        DODAJ KOLIČINO 
                      </button>
                      <button class="btn btn-default" id="izbrisiVse"> 
                        IZBRIŠI VSE KOLIČINE
                      </button>
                    </div>
                  </div>
                  <div id="dodajanjeImena" style="display: none;">
                    <div class="row text-center" style="padding: 1em 0 1em 0;">
                      Vpišite ime za količino. Vidno bo na grafu in v tabeli meritev.  
                    </div>
                    <div class="row text-center" style="padding: 0 0 1em 0;">
                      <input id="ime">
                    </div>
                    <div class="row text-center">
                      <button class="btn btn-default" id="dodajIme"> DODAJ IME </button>
                    </div>
                  </div>
                  <div id="dodajanjeOznake" style="display: none;">
                    <div class="row text-center" style="padding: 1em 0 1em 0;">
                      Vpišite oznako za količino. Vidno bo na grafu in v tabeli meritev.
                    </div>
                    <div class="row text-center" style="padding: 0 0 1em 0;">
                      <input id="oznaka">
                    </div>
                    <div class="row text-center">
                      <button class="btn btn-default" id="dodajOznako"> DODAJ OZNAKO </button>
                    </div>
                  </div>
                  <div id="dodajanjeEnote" style="display: none;">
                    <div class="row text-center" style="padding: 1em 0 1em 0;">
                      Vpišite enoto za količino. Vidno bo na grafu in v tabeli meritev.
                    </div>
                    <div class="row text-center" style="padding: 0 0 1em 0;">
                      <input id="enota">
                    </div>
                    <div class="row text-center">
                      <button class="btn btn-default" id="dodajEnoto"> DODAJ ENOTO </button>
                    </div>
                  </div>
                  <div id="dodajanjeFormule" style="display: none;">
                    <div class="row text-center" style="padding: 0 1em 1em 1em;">
                      S pritiskanjem na spodnje gumbe določite formulo, ki bo predstavljala izračun količine.
                    </div>
                    <div class="row"> 
                      <div class="col-xs-12 text-center"> 
                        <div class="row">
                          <div id="formula" style="height: 2em; border: 2px solid rgb(221, 221, 221); font-size: 1.5em; padding: 0 0 3em 0; margin: 0 2em;"> </div>
                        </div>
                        <div class="row text-center" style="padding-top: 1em;">
                          <div class="col-xs-8">
                            <div id="formulaNapaka" class="alert alert-danger" style="display: none; margin: 0 0 0 1em;"></div>
                          </div>
                          <div class="col-xs-4">
                            <button class="btn btn-info" id="dodajFormulo"> DODAJ FORMULO </button>
                          </div>
                        </div>
                        <div class="row text-center" style="padding-top: 1em;">
                          <button class="btn btn-default" id="izbrisi"> IZBRIŠI ZADNJI ZNAK </button>
                          <button class="btn btn-default" id="izbrisiVso" style="padding-left: 2em;"> IZBRIŠI CELOTNO FORMULO </button>
                        </div>
                      </div> 
                    </div>
                    <div class="row" style="padding-top: 1em;">
                      <div class="col-xs-12">
                        <div class="row">
                          <div class="col-xs-6 col-md-3">
                            <button class="btn btn-default" id="kanal1"> IZHOD1 ( V<sub>1</sub> ) </button>
                          </div>
                          <div class="col-xs-6 col-md-3">
                            <button class="btn btn-default" id="kanal2"> IZHOD2 ( V<sub>2</sub> ) </button>
                          </div>
                          <div class="col-xs-6 col-md-3">
                            <button class="btn btn-default" id="kanal3"> IZHOD3 ( V<sub>3</sub> ) </button>
                          </div>
                          <div class="col-xs-6 col-md-3">
                            <button class="btn btn-default" id="kanal4"> IZHOD4 ( V<sub>4</sub> ) </button>
                          </div>
                        </div>
                        <div class="row text-center" style="padding-top: 0.5em;">
                          <div class="row">
                            Vnesite konstanto in pritisnite gumb dodaj:
                          </div>
                          <div class="row text-center" style="padding-top: 0.3em;">
                            <input type="number" id="konstanta">
                            <button class="btn btn-default" id="dodajKonstanto"> DODAJ </button>
                          </div>
                        </div>
                        <div class="row text-center" style="padding-top: 1em;">
                          <button class="btn btn-default" id="plus"> SEŠTEJ </button>
                          <button class="btn btn-default" id="minus" style="margin-left: 1em;"> ODŠTEJ </button>
                          <button class="btn btn-default" id="krat" style="margin-left: 1em;"> MNOŽI </button>
                          <button class="btn btn-default" id="deljeno" style="margin-left: 1em;"> DELI </button>
                          <button class="btn btn-default" id="potenca" style="margin-left: 1em;"> POTENCIRAJ </button>
                          <button class="btn btn-default" id="logaritem" style="margin-left: 1em;"> LOGARITMIRAJ </button>
                        </div>
                        <div class="row text-center" style="padding-top: 1em;">
                          <button class="btn btn-default" id="uklepaj" style="margin-left: 1em;"> UKLEPAJ </button>
                          <button class="btn btn-default" id="zaklepaj" style="margin-left: 1em;"> ZAKLEPAJ </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div role="tabpanel" class="tab-pane fade row" id="meri" style="border-left: 1px solid #ddd; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; display: none;">
          <div class="col-xs-1"></div>
          <div class="col-xs-10" id="tabela_signalov" style="padding: 3em 0 2em 0;">
            <div class="row text-center" style="border-bottom: solid 1px #D3D3D3; padding-bottom: 0.2em; font-size: 1em;">
              <div class="col-xs-6"> ČAS </div>
              <div class="col-xs-6"></div>
            </div>
          </div>
          <div class="col-xs-1"></div>
        </div>
        <div role="tabpanel" class="tab-pane fade row" id="prikazi" style="border-left: 1px solid #ddd; border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; display: none; padding-bottom: 2em;">
          <div class="col-xs-12 text-center" style="padding: 3em 0 0.5em 0;">
            <button class="btn btn-default" id="start" style="margin-left: 2em;"> ZAČNI </button>
            <button class="btn btn-default" id="ustavi" style="margin-left: 2em;"> USTAVI </button>
            <button class="btn btn-default" id="koncaj" style="margin-left: 2em;"> KONČAJ </button>
          </div>
          <div class="col-xs-12">
            <div class="col-xs-3"></div>
            <div id="neveljavno" class="col-xs-6 alert alert-warning text-center" style="margin: 1em 0 1em 0; display: none;">
              V zavihku nastavitve niste vnesli veljavnega števila meritev in časovnega intervala.
            </div>
            <div class="col-xs-3"></div>
          </div>
          <div class="col-xs-12" style="padding: 0;">
            <div id="senzorji_graf" class="center-block" style="width: 70em; height: 30em; min-width: 30em; margin: 0 auto;"></div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>