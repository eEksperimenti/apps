<!-- $Id$
 *
 * Red Pitaya Generator & Oscilloscope client.
 *
 * Author: Dakus <info@eskala.eu>
 *         
 * (c) Red Pitaya  http://www.redpitaya.com
 *
 * This part of code is written in Javascript & HTML.
 * Please visit http://en.wikipedia.org/wiki/JavaScript
 *              http://en.wikipedia.org/wiki/HTML
 * for more details on the languages used herein.
-->
<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> eTok </title>
  <link href="../assets/bootstrap-3.0.0/css/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../assets/style.css" rel="stylesheet" type="text/css">
  <style type="text/css">
    .zoomYaxis{
      -ms-transform: rotate(-90deg);
      -webkit-transform: rotate(-90deg);
      transform: rotate(-90deg);
    }
    .leftZoom{
      left: -70px;
      top: 300px;
    }
    .graph-holder{
      margin-right:30px;
    }
     .rightZoom{
      left: 40px;
      float: right;
      top: 300px;
    }
  </style>
  <script src="../assets/bootstrap-3.0.0/js/jquery.js"></script>
  <script src="../assets/bootstrap-3.0.0/js/bootstrap.min.js"></script>
  <script src="../assets/flot/jquery.flot.min.js"></script>
  <script src="../assets/flot/jquery.flot.crosshair.js"></script>
  <script src="../assets/value-picker.js"></script>
  <script src="../assets/flot/jquery.flot.selection.min.js"></script>
  <script src="../assets/flot/jquery.flot.navigate.js"></script>
  <script src="../assets/flot/jquery.flot.resize.min.js"></script>
  <script src="../assets/flot/jquery.flot.touch.js"></script>
  <script src="../assets/axes-manager.js"></script>
  <script src="../assets/translator.js"></script>
  <script type="text/javascript">

  am.div_id='nastavitve'; //id razdelka za izris kontrol
  am.yaxis2=true; //omogoči/onemogoči delovanje druge y osi
  
  // Settings which can be modified
  
  var app_id = 'eTok';  
  var root_url = '';
  //var root_url = 'http://10.0.1.221';      // Test local
  //var root_url = 'http://192.168.53.133';  // Test remote and local
  //var root_url = 'http://192.168.1.100';   // Default RedPitaya IP
  var start_app_url = root_url + '/bazaar?start=' + app_id;
  var stop_app_url = root_url + '/bazaar?stop=';
  var get_url = root_url + '/data';
  var post_url = root_url + '/data';
  var upload_url = root_url + '/upload_gen_ch';  // The channel number is added automatically
  
  var update_interval = 50;              // Update interval for PC, milliseconds
  var update_interval_mobdev = 500;      // Update interval for mobile devices, milliseconds 
  var request_timeout = 3000;            // Milliseconds
  var long_timeout = 20000;              // Milliseconds
  var meas_panel_dec = 5;                // Decimation for numerical measure panel to make it human readable
  var meas_panel_dec_mobdev = 1;         // Decimation for numerical measure panel for mobile devices
  var points_per_px = 5;                 // How many points per pixel should be drawn. Set null for unlimited (will disable client side decimation).
  var xdecimal_places = 2;               // Number of decimal places for the xmin/xmax values. Maximum supported are 12.
  var trigger_level_xdecimal_places = 4; // Number of decimal places for trigger level tooltip
  var range_offset = 1;                  // Percentages
    
  var xmin = -1000000;
  var xmax = 1000000;  

  var time_range_max = [130, 1000, 8, 130, 1, 8];
  var range_steps = [0.5, 1, 2, 5, 10, 20, 50, 100];
  
  var plot_options = {
    colors: ['#3276B1', '#D2322D', '#009900'],    // channel1, channel2, trigger line
    lines: { lineWidth: 1 },
    selection: { mode: null },
    zoom: { interactive: false, trigger: null },
    xaxis: { min: xmin, max: xmax },
    grid: { borderWidth: 0 },
    legend: { noColumns: 2, margin: [0, 0], backgroundColor: 'transparent' },
    touch: { autoWidth: false, autoHeight: false }
  };
  
  // Settings which should not be modified
  
  var update_timer = null;
  var zoompan_timer = null;
  var downloading = false;
  var sending = false;
  var send_que = false;
  var use_long_timeout = false;
  var trig_dragging = false;
  var touch_last_y = 0;
  var user_editing = false;
  var app_started = false;
  var last_get_failed = false;
  var refresh_counter = 0;
  var autorun = 1;
  var datasets = [];
  var plot = null;
  var params = {
    original: null,
    local: null
  };
  
  var stariXmin = 0;
  var stariXmax = 0;
  var prvic = 1;
  var najmanjsaFrekvenca = -2;
  var najvecjaFrekvenca = -1;
  var privzetaFrekvenca = 0;
  var izbrano = false;

  var faktor1 = $("#faktor-y1");
  var gen_ch1;

  var faktor2 = $("#faktor-y2");
  var vrednostF2;

  var napetost1;
  var napetost2;

  var stevec = 0;
  var prejsnjaNapetost = -1;

  var src = (window.location).toString();

  var tezavnost = "lahko";

  var indeks = -1;
  var konec = false;

  var i_vprasanje = 0;
  var pitayaNum = 0;

  // Default parameters - posted after server side app is started 
  var def_params = {
    en_avg_at_dec: 0
  }; 
    

  var kvizi = {
      
      lahko: {

        tuljava: {

          sinusni: 
          [

            [ "Ali je napetostni signal enake oblike kot tokovni ?", "da", "ne", 1], 

            [ "Napetostni in tokovni signal sta:", "Enake oblike, vendar zamaknjena v času.", "Različne oblike, vendar ne zamaknjena.", "Enaka.", 1],

            [ "Tokovni in napetostni signal sta zamaknjena za približno:", "Pol periode signala.", "Celo periodo signala", "Eno četrtino periode signala.", "Nista zamaknjena.", 3], 

            [ "Če amplitudo napetostnega signala povečamo za 2x ( na 1 V), se amplituda toka:", "Poveča približno za 2x.", "Ne spremeni.", "Zmanjša za 2x.", "Poveča za 3x.", "Zmanjša za 3x.", 3],

            [ "Če povečamo frekvenco vzbujalnega (napetostnega) signala za 10x (na 50 kHz):", "Ostane frekvenca toka enaka kot prej (5 kHz).", "Se enako poveča tudi frekvenca tokovnega signala.", 2], 

            [ "Pri povišani frekvenci signala je amplituda toka:", "Večja kot pri prejšnji (nižji) frekvenci.", "Enaka kot pri prejšnji frekvenci.", "Manjša kot pri prejšnji frekvenci.", 3]

          ]
        },
        // lahko
        kondenzator: {

          sinusni:
            [
              [ "Ali je pri sinusnem napetostnem signalu napetostni signal enake oblike kot tokovni signal?", "da", "ne", 1], 

              [ "Napetostni in tokovni signal sta:", "Enake oblike vendar zamaknjena v času.", "Različne oblike, vendar ne zamaknjena.", "Enaka.", 1], 

              [ "Tokovni in napetostni signal sta zamaknjena za:", "Približno pol periode signala.", "Celo periodo signala.", "Eno četrtino periode signala.", "Nista zamaknjena.", 3],

              [ "Če amplitudo napetostnega signala povečamo za 2x (na 1 V), se amplituda toka:", "Poveča približno za 2x.", "Ne spremeni.", "Zmanjša za 2x.", "Poveča za 3x.", "Zmanjša za 3x.", 1],

              [ "Če povečamo frekvenco vzbujalnega (napetostnega) signala za 10x (na 50 kHz):", "Ostane frekvenca toka enaka kot prej (5 kHz).", "Se enako poveča tudi frekvenca tokovnega signala.", 2],

              [ "Pri povišani frekvenci signala je amplituda toka:", "Večja kot pri prejšnji (nižji) frekvenci.", "Enaka kot pri prejšnji frekvenci.", "Manjša kot pri prejšnji frekvenci.", 1]
          ]
        },
        // lahko
        upor: {

          sinusni:
            [
              [ "Ali je napetostni signal enake oblike kot tokovni ?", "da", "ne", 1],

              [ "Če amplitudo napetostnega signala povečamo za 2x (na 1 V), se amplituda toka:", "Poveča za 2x.", "Ne spremeni.", "Se zmanjša za 2x.", "Se poveča za 3x.", "Se zmanjša za 3x.", 1],

              [ "Če povečamo frekvenco vzbujalnega (napetostnega) signala za 10x (na 10 kHz):", "Ostane frekvenca toka enaka kot prej (1 kHz)", "Se enako poveča tudi frekvenca tokovnega signala.", 2],

              [ "Če spremenimo vzbujalni napetostni signal na trikotnega:", "Se enako spremeni tudi oblika toka.", "Ostane oblika toka sinusne oblike.", "Je oblika toka bolj pravokotne oblike.", 1]
          ],
        },
        // lahko
        dioda: {

          sinusni: 
            [
              [ "Ali je napetostni signal enake oblike kot tokovni ?", "da", "ne", 1],

              [ "Napetostni in tokovni signal sta:", "Enake oblike, vendar zamaknjena v času.", "Različne oblike, vendar ne zamaknjena.", "Enaka.", 1],

              [ "Tok prevaja skozi element:", "Enako v obe smeri.", "Le v eni smeri, v drugi pa ne.", 1], 

              [ "Tokovni in napetostni signal sta zamaknjena za približno:", "Pol periode signala.", "Celo periodo signala.", "Eno četrtino periode signala.", "Nista zamaknjena.", 4],

              [ "Če amplitudo napetostnega signala povečamo za 2x (na 1 V), se amplituda toka ob prevajanju:", "Poveča približno za 2x.", "Ne spremeni.", "Zmanjša za 2x.", "Poveča za 3x.", "Zmanjša za 3x.", 2],

              [ "Če povečamo frekvenco vzbujalnega (napetostnega) signala za 10x (na 50 kHz):", "Ostane frekvenca toka enaka kot prej (5 kHz).", "Se enako poveča tudi frekvenca tokovnega signala.", 2], 

              [ "Pri povišani frekvenci signala je amplituda toka:", "Večja kot pri prejšnji (nižji) frekvenci.", "Enaka kot pri prejšnji frekvenci.", "Manjša kot pri prejšnji frekvenci.", 2],

              [ "Če spremenimo vzbujalni napetostni signal na trikotnega:", "Se enako spremeni tudi oblika toka.", "Postane oblika toka podobna sinusni obliki.", "Ostane oblika toka sinusne oblike", 1],

              [ "Če spremenimo vzbujalni napetostni signal na pravokotnega:", "Je tok velik le ob spremembah napetostnega signala.", "Se enako spremeni tudi oblika toka, le prevaja le v eno smer.", "Postane tok trikotne oblike.", "Se enako spremeni tudi oblika toka in prevaja v obe smeri.", 2]
          ]
        }
      }
    };

    var predvajanje = 0;

  // On page loaded

$(function() {

        window.audioContext = new (window.AudioContext || window.webkitAudioContext)();

    $('#zvok1').popover({ trigger: "hover", html: true });
    $('#zvok2').popover({ trigger: "hover", html: true });

    $('#zvok1').on('click', function(){
      if(predvajanje != 1){
        predvajanje = 1;
        zvok(1);
      }
    });

    $('#zvok2').on('click', function(){
      if(predvajanje != 1){
        predvajanje = 1;
        zvok(2);
      }
    });

    function zvok(kanal){
      
      var min = 1000;
      var max = -1000;
      var m = 0;

      for (var i = 0; i < 1024; i = i+2){
        m = parseFloat(datasets[kanal - 1].data[i][1]);
        if(m < min){
          min = m;
        }
        else if(m > max){
          max = m;
        }
      }

      var Nsignal = 1024;                      
      var fmin = 200;
      var fmax = 1200;
       
      var k = (fmax - fmin)/(Math.abs(max - min));
      var n = fmax - k*Math.abs(max);

      var frekvence = [];
      var fr;

      for (var i = 0; i < 1024; i = i+2){   // zracunaj sample

        fr = k*parseFloat(datasets[kanal - 1].data[i][1]) + n;
        fr = Math.round(fr*10000)/10000;

        frekvence.push(fr);
      }

      var oscillator = window.audioContext.createOscillator();
      var gain =  window.audioContext.createGain();
      gain.gain.value = 1;

      oscillator.connect(gain);
      gain.connect(window.audioContext.destination);
      oscillator.noteOn(0);

      var i = 0;

      var cs = setInterval( function(){

        oscillator.frequency.value = frekvence[i];
        
        if(i == 512){
          gain.gain.value = 0;
          oscillator.noteOff(0);
          predvajanje = 0;
          clearInterval(cs);
        }
        i++;

      }, 5);
    }

    //////////////  local  ////////////////////

    localStorage.setItem("i_vprasanje", "0");
  
      function elementi(i){
  
        var kviz = "";
  
        switch(i){
          case 1:
            kviz = sestaviKviz(kvizi[tezavnost].tuljava.sinusni);
            break;
          case 2:
            kviz = sestaviKviz(kvizi[tezavnost].kondenzator.sinusni);
            break;
          case 3:
            kviz = sestaviKviz(kvizi[tezavnost].upor.sinusni);
            break;
          case 4:
            kviz = sestaviKviz(kvizi[tezavnost].dioda.sinusni);
            break;
        }
  
        return "<form>" + kviz + "</form>";
      }

    function odgovori(s){

      var res;

      switch(s){
        case 1:
          res = kvizi[tezavnost].tuljava.sinusni;
          return resitve(res);
        case 2:
          res = kvizi[tezavnost].kondenzator.sinusni;
          return resitve(res);
        case 3:
          res = kvizi[tezavnost].upor.sinusni;
          return resitve(res);
        case 4:
          res = kvizi[tezavnost].dioda.sinusni;
          return resitve(res);
      }
    }

    function resitve(r){
      
      var re = [];

      for(var i = 0; i < r.length; i++){
        re[i] = r[i][ r[i].length - 1 ];
      }

      return re;
    }

    function sestaviKviz(s){

      var vprasanje = "";
      var j = 0;
      
      i_vprasanje = parseInt(localStorage.getItem("i_vprasanje"));

      for(j = 0; j < ( s[i_vprasanje].length - 1); j++){

        vprasanje += "<div class='row";

        if(j != 0){
          if(j == s[i_vprasanje].length - 2){
            vprasanje += " alert' style='margin: 0 0 20px 0; padding: 0;'><input type='radio' name='vprasanje' value='" + j + "'>";
          }
          else{
            vprasanje += " alert' style='padding: 0; margin:0;'><input type='radio' name='vprasanje' value='" + j + "'>";
          }
        }
        else{
          vprasanje += " vprasanje'>";
        }

        vprasanje += s[i_vprasanje][j] + "</div>";
      }

      return vprasanje;
    }

    /*
    
      1-3 tuljava
      4-6 kondenzator
      7-9 upor
      10-12 dioda
      
    */

    function narisiKviz(){

      var kviz = elementi(parseInt(localStorage.getItem("kviz")));

      var k = $("#kviz .col-xs-12");
      
      k.html(kviz);
      k.find("input").css("margin-right", "15px");
      k.find(".vprasanje").css("margin-bottom", "10px");
    }
  
    $("#preveri").css("display", "none");

    var naprej = false; 
    var naslednji = false;

    localStorage.setItem("pravilni", 0);

    $("#preveri").on("click", function(){
      
      i_vprasanje = parseInt(localStorage.getItem("i_vprasanje"));

      var resitve = odgovori(parseInt(localStorage.getItem("kviz")));
      
      if(!naprej && !konec){

        var el = $("#kviz .col-xs-12").find("form .alert").find("input:checked");
        var odgovor = resitve[i_vprasanje];

        if(parseInt(el.val()) != odgovor || isNaN(parseInt(el.val()))){

          el.parent().addClass("alert-danger");
        }
        else if(parseInt(el.val()) == odgovor && !isNaN(parseInt(el.val()))){

          el.parent().addClass("alert-success");
          var pravilni = parseInt(localStorage.getItem("pravilni")) + 1;
          localStorage.setItem("pravilni", pravilni);
        }

        if(el.length != 0){

          $("#kviz .col-xs-12").find("form .alert").find("input").prop("disabled", "true");

          $("#kviz").find(".alert-warning").css("display", "none");
          $(this).removeClass();
          $(this).addClass("btn");
          $(this).css("background-color", "#337ab7");

          if(resitve.length > (i_vprasanje + 1)){

            $("#kviz").find(".alert-danger:last").css("display", "none");
            $("#kviz").find(".alert-success:last").css("display", "none");
            $(this).html("NAPREJ");

            naprej = true;

            i_vprasanje = i_vprasanje + 1;
            localStorage.setItem("i_vprasanje", i_vprasanje);
          }
          else if(resitve.length <= (i_vprasanje + 1)){

            if(parseInt(localStorage.getItem("pravilni")) >= Math.round(resitve.length/2)){

              $("#kviz").find(".alert-success:last").html(
                "Čestitamo ! Pravilno ste odgovorili na " + localStorage.getItem("pravilni") + " od " + resitve.length + " vprašanj. Če želite izboljšati svoj rezultat, kviz ponovite, sicer pa nadaljujte z izbiro naslednjega elementa."
              );
              $("#kviz").find(".alert-success:last").css("display", "");
              $(this).html("PONOVITE KVIZ");
              
              naprej = true;

              i_vprasanje = 0;
              localStorage.setItem("i_vprasanje", i_vprasanje);
              localStorage.setItem("pravilni", 0);
            }
            else{

              var meja = "";

              if(Math.round(resitve.length/2) == 1){
                meja = "vprašanje";
              }
              else if(Math.round(resitve.length/2) == 2){
                meja = "vprašanji";
              }
              else if(Math.round(resitve.length/2) == 3 || Math.round(resitve.length/2) == 4){
                meja = "vprašanja";
              }
              else if(Math.round(resitve.length/2) > 3){
                meja = "vprašanj";
              }

              $("#kviz").find(".alert-danger:last").html(
                  "Pravilno ste odgovorili na " + localStorage.getItem("pravilni") + " od " + resitve.length + " vprašanj. Če želite izboljšati svoj rezultat svoj rezultat, kviz ponovite, sicer pa nadaljujte z izbiro naslednjega elementa."
              );

              $("#kviz").find(".alert-danger:last").css("display", "");

              $(this).html("PONOVITE KVIZ");

              naprej = true;
              i_vprasanje = 0;

              localStorage.setItem("i_vprasanje", i_vprasanje);
              localStorage.setItem("pravilni", 0);
            }
          }
        }
        else{
          $("#kviz").find(".alert-warning").html("Odgovorite na vprašanje.");
          $("#kviz").find(".alert-warning").css("display", "");
        }
      }
      else if(naprej && !konec){

        if(naslednji){

          eraseCookie(parseInt(getFirstCookieName()));
          nastaviElement(true);
          naslednji = false;
        }

        $("#kviz").find(".alert-danger:last").css("display", "none");
        $("#kviz").find(".alert-success:last").css("display", "none");

        $(this).removeClass();
        $(this).addClass("btn btn-info");
        $(this).css("background-color", "");
        $(this).html("PREVERI");

        naprej = false;

        narisiKviz();
      }
      else if(konec){

        $("#preveri").css("display", "none");
        $("#konec").css("display", "");

        $("#kviz").html("");
      }
    });

    //eraseCookie(prvi);

    /*
    
      1-3 tuljava
      4-6 kondenzator
      7-9 upor
      10-12 dioda
      
    */

    //lahek način

    $("#izberiElement").on("change", function(){

      var element = $(this).find(":selected").text().replace(/^\s+|\s+$/g, '');
      var i_kviz = -1;

      if(element == "Tuljava"){

        nastavitveElementov(true, 2, 5000, 100000, 20000, 2, -2, 2, -0.015, 0.015, 500);

        i_kviz = 1;
      }
      else if(element == "Kondenzator"){

        nastavitveElementov(true, 1, 1000, 20000, 10000, 1, -2, 2, -0.015, 0.015, 500);

        i_kviz = 2;
      }
      else if(element == "Upor"){

        nastavitveElementov(true, 0, 10, 100000, 1000, 2, -2, 2, -0.015, 0.015, 999);

        i_kviz = 3; 
      }
      else if(element == "Dioda"){

        nastavitveElementov(true, 3, 100, 100000, 10000, 2, -2, 2, -0.015, 0.015, 990);

        i_kviz = 4;
      }
      else if(element == "Izberite element"){

        nastavitveElementov(true, -1, 0, 1000000, 0, 0, -2, 2, -0.02, 0.02, 500);

        i_kviz = -1;
      } 

      plot.setupGrid();
      plot.draw();

      if(i_kviz != -1){

        var kviz = elementi(i_kviz);

        localStorage.setItem("kviz", i_kviz);
        localStorage.setItem("i_vprasanje", 0);

        var prev = $("#preveri");

        prev.html("PREVERI");
        prev.css("display", "");
        prev.css("background-color", "");
        prev.addClass("btn-info");

        var k = $("#kviz .col-xs-12");
        k.html(kviz);
        k.find("input").css("margin-right", "15px");
        k.find(".vprasanje").css("margin-bottom", "10px");

        $("#kviz").find(".alert-danger:last").css("display", "none");
        $("#kviz").find(".alert-success:last").css("display", "none");
      }
      else{

        var k = $("#kviz .col-xs-12");
        k.html("");
      }
    });



















    //////////////// preostala koda /////////////////////////

    var protocol  = window.location.protocol;
    var base_addr = window.location.hostname;

    $(".opis").on("click", function(){
      var win = window.open(protocol +"//" + base_addr + '/index.html?page=lastnosti-elementov-vezij-aplikacija-neoddaljen', '_blank');
      win.focus();
    });

    $("#tezji_navodila").on("click", function(){
      var win = window.open(protocol +"//" + base_addr + '/index.html?page=elementi-vezij-tezji-neoddaljen', '_blank');
      win.focus();
    });

    $("#srednji_navodila").on("click", function(){
      var win = window.open(protocol +"//" + base_addr + '/index.html?page=elementi-vezij-srednji-neoddaljen', '_blank');
      win.focus();
    });

    $("#lazji_navodila").on("click", function(){
      var win = window.open(protocol +"//" + base_addr + '/index.html?page=elementi-vezij-lazji-neoddaljen', '_blank');
      win.focus();
    });

    // Show different buttons on touch screens    
    if(window.ontouchstart === undefined) {
      $('.btn-lg').removeClass('btn-lg');
      $('#accordion .btn, .modal .btn').addClass('btn-sm');
      $('#btn_zoompan').remove();
      $('#btn_zoomin, #btn_zoomout, #btn_pan').show();
    }
    else {
      update_interval = update_interval_mobdev;
      meas_panel_dec = meas_panel_dec_mobdev;
      $('#btn_zoomin, #btn_zoomout, #btn_pan').remove();
      $('#btn_zoompan').show();
    }
    
    // Add application ID in the message from modal popup
    $('.app-id').text(app_id);
    
    // Disable all controls until the params state is loaded for the first time 
   // $('input, select, button', '.container').prop('disabled', true);
    
    // Events binding for trigger controls
    
    $('#trigger_canvas').on({
      'mousedown touchstart': function(evt) {
      
        // Ignore the event if trigger source is External or mode is not Normal
        if(!params.original || params.original.trig_mode != 1 || params.original.trig_source == 2) {
          return;
        }
      
        trig_dragging = true;
        $('input, select', '#accordion').blur();
        mouseDownMove(this, evt);
        evt.preventDefault();
        return false;
      },
      'mousemove touchmove': function(evt) {
        if(! trig_dragging) {
          return;
        }
        mouseDownMove(this, evt);
        evt.preventDefault();
        return false;
      },
      'mouseup mouseout touchend': mouseUpOut
    });
    
    $('input,select', '#accordion').on('focus', function() {
      user_editing = true;
    });
    
    autorun = false;
    $('#trig_mode').on('change', function() {
      onDropdownChange($(this), 'trig_mode', true);
      
      // Autorun if trigger mode is Auto(0) or Normal(1), stop if it is Single(2).
      autorun = (params.local.trig_mode == 2 ? 0 : 1); 
      runStop();
    });
    
    $('#trig_source').on('change', function() { onDropdownChange($(this), 'trig_source'); });
    $('#trig_edge').on('change', function() { onDropdownChange($(this), 'trig_edge'); });
    
    $('#trig_level')
      .on('focus paste', function() {
        $(this).parent().addClass('input-group');
        $('#apply_trig_level').show();
      })
      .on('blur', function() {
        $('#apply_trig_level').hide();
        $(this).parent().removeClass('input-group');
        
        var tlev = parseLocalFloat($(this).val());
        var scale = (params.local.trig_source == 0 ? params.local.scale_ch1 : params.local.scale_ch2);

        if(! isNaN(tlev)) {
          params.local.trig_level = tlev / scale;
          updateTriggerSlider(undefined, false);
          redrawPlot();
          sendParams();
        }
        else {
          tlev = params.local.trig_level * scale;
          $(this).val(tlev);
        }
        user_editing = false;
      })
      .on('change', function() {
        $(this).blur();
      })
      .on('keypress', function(e) {
        if(e.keyCode == 13) {
          $(this).blur();
        }
      });
    
    function xMinimum(s){

      //var nearest = $(this).data('nearest');

      if(plot){
        
        var options = plot.getOptions();
        var axes = plot.getAxes();

        var min = parseFloat(s.val());
        var max = parseFloat($('#sprememba_xmax').val());

        var unit = $(this).data('unit');
        
        // Convert nanoseconds to milliseconds.
        if(unit == 'ns') {
          nearest /= 1000;
        }

        if(stariXmin != min || min == 0){

          if(!isNaN(min) && min < max){

            options.xaxes[0].min = min;
            options.xaxes[0].max = max;

            plot.setupGrid();
            plot.draw();
            
            params.local.xmin = min;
            params.local.xmax = max;
            
            //updateRanges();

            s.tooltip( s.prop('disabled') === true ? 'hide' : 'show');
            sendParams(true);
          }
          else if(min > max){
            s.val(stariXmin);
          }
        }
        stariXmin = min;
      }
    }

    $('#sprememba_xmin').on('keypress', function(event) {
      
      if(event.keyCode == 13){

        var t = $(this); 

        xMinimum(t);
        t.blur();
      }
    });

    $('#sprememba_xmax').on('keypress', function(event) {
      
      if(event.keyCode == 13){

        var t = $(this);

        xMaksimum(t);
        t.blur();
      }
    });

    $('#sprememba_xmin').on('blur', function() {
      
      var t = $(this);

      xMinimum(t);
    });

    $('#sprememba_xmax').on('blur', function() {
      
      var t = $(this);
      
      xMaksimum(t);
    });

    // Events binding for range controls
    
    $('#range_x_minus, #range_x_plus').on('click', function() {

      var nearest = $(this).data('nearest');
      
      if(nearest && plot) {

        var options = plot.getOptions();
        var axes = plot.getAxes();

        var min = (options.xaxes[0].min !== null ? options.xaxes[0].min : axes.xaxis.min);
        var max = (options.xaxes[0].max !== null ? options.xaxes[0].max : axes.xaxis.max);

        var unit = $(this).data('unit');
        
        // Convert nanoseconds to milliseconds.
        if(unit == 'ns') {
          nearest /= 1000;
        }
        
        var center = (min + max) / 2;
        var half = nearest / 2;
        min = center - half;
        max = center + half;

        options.xaxes[0].min = min;
        options.xaxes[0].max = max;

        plot.setupGrid();
        plot.draw();
        
        params.local.xmin = min;
        params.local.xmax = max;       
        
        updateRanges();

        $(this).tooltip($(this).prop('disabled') === true ? 'hide' : 'show');
        sendParams(true);
      }
    });
    
    $('#range_y_minus').on('click', function() {
      var options = plot.getOptions();
      am.update_yrange(0,options.yaxes[0].min/2,options.yaxes[0].max/2);
    });

    $('#range_y_plus').on('click', function() {
      var options = plot.getOptions();
      am.update_yrange(0,options.yaxes[0].min*2,options.yaxes[0].max*2);
    });

    $('#range_y2_minus').on('click', function() {
      var options = plot.getOptions();
      am.update_yrange(1,options.yaxes[1].min/2,options.yaxes[1].max/2);
    });

    $('#range_y2_plus').on('click', function() {
      var options = plot.getOptions();
      am.update_yrange(1,options.yaxes[1].min*2,options.yaxes[1].max*2);
    });
    
    $('#offset_x_minus, #offset_x_plus').on('click', function() {
      if(plot) {

        var direction = ($(this).attr('id') == 'offset_x_minus' ? 'left' : 'right');
        var options = plot.getOptions();
        var axes = plot.getAxes();
        var min = (options.xaxes[0].min !== null ? options.xaxes[0].min : axes.xaxis.min);
        var max = (options.xaxes[0].max !== null ? options.xaxes[0].max : axes.xaxis.max);
        var offset = (max - min) * range_offset/100;
        
        if(direction == 'left') {
          min -= offset;
          max -= offset;
        }
        else {
          min += offset;
          max += offset;
        }
        
        options.xaxes[0].min = min;
        options.xaxes[0].max = max;

        plot.setupGrid();
        plot.draw();
        
        params.local.xmin = min;
        params.local.xmax = max;
               
        updateRanges();
        sendParams(true);
      }
    });
    
    $('#offset_y_minus, #offset_y_plus').on('click', function() {
      if(plot) {
        var direction = ($(this).attr('id') == 'offset_y_minus' ? 'down' : 'up');
        var options = plot.getOptions();
        var axes = plot.getAxes();
        var min = (options.yaxes[0].min !== null ? options.yaxes[0].min : axes.yaxis.min);
        var max = (options.yaxes[0].max !== null ? options.yaxes[0].max : axes.yaxis.max);
        var offset = (max - min) * range_offset/100;
        
        if(direction == 'down') {
          min -= offset;
          max -= offset;
        }
        else {
          min += offset;
          max += offset;
        }
        
        options.yaxes[0].min = min;
        options.yaxes[0].max = max;

        plot.setupGrid();
        plot.draw();
               
        updateRanges();
        updateTriggerSlider();
      }
    });
      
    // Events binding for gain controls
    
    $('#gain_ch1_att').on('change', function() { onDropdownChange($(this), 'prb_att_ch1'); });
    $('#gain_ch1_sett').on('change', function() { onDropdownChange($(this), 'gain_ch1'); });
    $('#gain_ch2_att').on('change', function() { onDropdownChange($(this), 'prb_att_ch2'); });
    $('#gain_ch2_sett').on('change', function() { onDropdownChange($(this), 'gain_ch2'); });
    
    // Events binding for signal generator
    
    $('#gen_enable_ch1, #gen_enable_ch2').on('change', function() { 
      params.local[this.id] = ($(this).is(':checked') ? 1 : 0);
      sendParams(); 
    });
    
    $('#gen_ch1_sigtype').on('change', function() { onDropdownChange($(this), 'gen_sig_type_ch1'); });
    $('#gen_ch1_trigmode').on('change', function() { onDropdownChange($(this), 'gen_trig_mod_ch1'); });
    $('#gen_ch2_sigtype').on('change', function() { onDropdownChange($(this), 'gen_sig_type_ch2'); });
    $('#gen_ch2_trigmode').on('change', function() { onDropdownChange($(this), 'gen_trig_mod_ch2'); });
    
    $('#gen_ch1_ampl')
      .on('focus paste', function() {

        $(this).parent().addClass('input-group');
        $('#apply_gen_ch1_ampl').show();

      })
      .on('blur', function() {

        $('#apply_gen_ch1_ampl').hide();
        $(this).parent().removeClass('input-group');
        
        var val = parseLocalFloat($(this).val());

        if(prejsnjaNapetost != val){

          prejsnjaNapetost = val;

          if(! isNaN(val)) {
            params.local.gen_sig_amp_ch1 = val;
            sendParams();
          }
          else {
            $(this).val(params.local.gen_sig_amp_ch1);
          }

          user_editing = false;
        }
      })
      .on('change', function() {
        $(this).blur();

        var val = parseLocalFloat($(this).val());
        
        if(prejsnjaNapetost != val){

          prejsnjaNapetost = val;

          if(! isNaN(val)) {
            params.local.gen_sig_amp_ch1 = val;
            sendParams();
          }
          else {
            $(this).val(params.local.gen_sig_amp_ch1);
          }
        }
      })
      .on('keypress', function(e) {

        if(prejsnjaNapetost != val){

          prejsnjaNapetost = val;

          if(e.keyCode == 13) {
            $(this).blur();
          
            var val = parseLocalFloat($(this).val());
          
            if(! isNaN(val)) {
              params.local.gen_sig_amp_ch1 = val;
              sendParams();
            }
            else {
              $(this).val(params.local.gen_sig_amp_ch1);
            }
          }  
        }    
      });
      
    $('#gen_ch1_freq')

      .on('focus paste', function() {
        $(this).parent().addClass('input-group');
        $('#apply_gen_ch1_freq').show();
      })
      .on('blur', function() {
        $('#apply_gen_ch1_freq').hide();
        $(this).parent().removeClass('input-group');
        
        var val = parseLocalFloat($(this).val());
      
        if(! isNaN(val)) {

          if(izbrano){

            if(val < najmanjsaFrekvenca){
              params.local.gen_sig_freq_ch1 = najmanjsaFrekvenca;
            }
            else if(val > najvecjaFrekvenca){
              params.local.gen_sig_freq_ch1 = najvecjaFrekvenca;
            }
            else{
              params.local.gen_sig_freq_ch1 = val;
            }
          }
          else{
            params.local.gen_sig_freq_ch1 = val;
          }

          sendParams();
        }
        else {
          $(this).val(params.local.gen_sig_freq_ch1);
        }
        user_editing = false;
      })
      .on('change', function() {
        $(this).blur();
      })
      .on('keypress', function(e) {
        if(e.keyCode == 13) {
          $(this).blur();
        }
      });
      
    $('#gen_ch1_dc')
      .on('focus paste', function() {
        $(this).parent().addClass('input-group');
        $('#apply_gen_ch1_dc').show();
      })
      .on('blur', function() {
        $('#apply_gen_ch1_dc').hide();
        $(this).parent().removeClass('input-group');
        
        var val = parseLocalFloat($(this).val());
        if(! isNaN(val)) {
          params.local.gen_sig_dcoff_ch1 = val;
          sendParams();
        }
        else {
          $(this).val(params.local.gen_sig_dcoff_ch1);
        }
        user_editing = false;
      })
      .on('change', function() {
        $(this).blur();
      })
      .on('keypress', function(e) {
        if(e.keyCode == 13) {
          $(this).blur();
        }
      });
      
    $('#gen_ch2_ampl')
      .on('focus paste', function() {
        $(this).parent().addClass('input-group');
        $('#apply_gen_ch2_ampl').show();
      })
      .on('blur', function() {
        $('#apply_gen_ch2_ampl').hide();
        $(this).parent().removeClass('input-group');
        
        var val = parseLocalFloat($(this).val());
        if(! isNaN(val)) {
          params.local.gen_sig_amp_ch2 = val;
          sendParams();
        }
        else {
          $(this).val(params.local.gen_sig_amp_ch2);
        }
        user_editing = false;
      })
      .on('change', function() {
        $(this).blur();
      })
      .on('keypress', function(e) {
        if(e.keyCode == 13) {
          $(this).blur();
        }
      });
      
    $('#gen_ch2_freq')
      .on('focus paste', function() {
        $(this).parent().addClass('input-group');
        $('#apply_gen_ch2_freq').show();
      })
      .on('blur', function() {
        $('#apply_gen_ch2_freq').hide();
        $(this).parent().removeClass('input-group');
        
        var val = parseLocalFloat($(this).val());
        if(! isNaN(val)) {
          params.local.gen_sig_freq_ch2 = val;
          sendParams();
        }
        else {
          $(this).val(params.local.gen_sig_freq_ch2);
        }
        user_editing = false;
      })
      .on('change', function() {
        $(this).blur();
      })
      .on('keypress', function(e) {
        if(e.keyCode == 13) {
          $(this).blur();
        }
      });
      
    $('#gen_ch2_dc')
      .on('focus paste', function() {
        $(this).parent().addClass('input-group');
        $('#apply_gen_ch2_dc').show();
      })
      .on('blur', function() {
        $('#apply_gen_ch2_dc').hide();
        $(this).parent().removeClass('input-group');
                
        var val = parseLocalFloat($(this).val());
        if(! isNaN(val)) {
          params.local.gen_sig_dcoff_ch2 = val;
          sendParams();
        }
        else {
          $(this).val(params.local.gen_sig_dcoff_ch2);
        }
        user_editing = false;
      })
      .on('change', function() {
        $(this).blur();
      })
      .on('keypress', function(e) {
        if(e.keyCode == 13) {
          $(this).blur();
        }
      });
      
    // Modals
    
    $('#modal_err, #modal_app').modal({ show: false, backdrop: 'static', keyboard: false });
    $('#modal_upload').modal({ show: false });
    
    $('#btn_switch_app').on('click', function() {
      var newapp_id = $('#new_app_id').text();
      if(newapp_id.length) {
        location.href = location.href.replace(app_id, newapp_id);
      }
    });
    
    $('.btn-app-restart').on('click', function() {
      location.reload();
    });
    
    $('#btn_retry_get').on('click', function() {
      $('#modal_err').modal('hide');
      updateGraphData();
    });
    
    $('.btn-close-modal').on('click', function() {
      $(this).closest('.modal').modal('hide');
    });
    
    // Reset the upload form to prevent browser caching of the uploaded file name
    $('#upload_form')[0].reset();
      
    // Other event bindings
    
    $('#trigger_tooltip').tooltip({
      title: '',
      trigger: 'manual',
      placement: 'auto left',
      animation: false
    });
    
    $('.btn').on('click', function() {
      var btn = $(this);
      setTimeout(function() { btn.blur(); }, 10);
    });
    
    $('#btn_toolbar .btn').on('blur', function() {
      $(this).removeClass('active');
    });
    
    $(document).on('click', '#accordion > .panel > .panel-heading', function(event) {
      $(this).next('.panel-collapse').collapse('toggle');
      event.stopImmediatePropagation();
    });
    
    // Tooltips for range buttons
    $('#range_x_minus, #range_x_plus, #range_y_minus, #range_y_plus').tooltip({
      container: 'body'
    });

    // Load first data
    updateGraphData();
    
    if(params.local != null){

      stariXmin = params.local.xmin;
      stariXmax = params.local.xmax;
    }

    // Stop the application when page is unloaded
    window.onbeforeunload = function() { 
      $.ajax({
        url: stop_app_url,
        async: false
      });
    };
            
  });
  
  function startApp() {
	
    $.get(start_app_url)

    .done(function(dresult) {
      if(dresult.status == 'ERROR') {
        showModalError((dresult.reason ? dresult.reason : 'Could not start the application.'), true);
      }
      else {
        $.post(
          post_url, 
          JSON.stringify({ datasets: { params: def_params } })
        )
        .done(function(dresult) {
          app_started = true;
          updateGraphData();      
        })
        .fail(function() {
          showModalError('Could not initialize the application with default parameters.', false, true);
        });
      }
    })
    .fail(function() {
      showModalError('Could not start the application.', true);
    });
  }
  
  function showModalError(err_msg, retry_btn, restart_btn, ignore_btn) {
    var err_modal = $('#modal_err');
    
    err_modal.find('#btn_retry_get')[retry_btn ? 'show' : 'hide']();
    err_modal.find('.btn-app-restart')[restart_btn ? 'show' : 'hide']();
    err_modal.find('#btn_ignore')[ignore_btn ? 'show' : 'hide']();
    err_modal.find('.modal-body').html(err_msg);
    err_modal.modal('show');
  }   

  function updateGraphData() {

    if(downloading) {
      return;
    }
    if(update_timer) {
      clearTimeout(update_timer);
      update_timer = null;
    }
    downloading = true;

    stevec++;

    if(params.local != null && prvic == 1){

      prejsnjaNapetost = params.local.gen_sig_amp_ch1;

      nastavitveElementov(false, -1, 0, 1000000, 0, 0, -2, 2, -0.015, 0.015, 500);

      prvic = 0;
    }

    if(params.local != null && stevec % 10 == 0){

      if(params.local.gen_enable_ch1 != 0){

        premajhnaNapetost();
      }
      else{

        $("#naslednjiObvestilo").find(".alert").eq(0).css("display", "none");
      }
    }

    // Send params if there are any unsent changes
    sendParams();
    
    var arun_before_ajax = autorun;
    var long_timeout_used = use_long_timeout;
    
    $.ajax({
      url: get_url,
      timeout: (use_long_timeout ? long_timeout : request_timeout),
      cache: false
    })
    .done(function(dresult) {
      last_get_failed = false;
      
      if(dresult.status === 'ERROR') {
        if(! app_started) {
          startApp();
        }
        else {
          showModalError((dresult.reason ? dresult.reason : 'Application error.'), true, true);
        }
      }
      else if(dresult.datasets !== undefined && dresult.datasets.params !== undefined) {
        // Check if the application started on the server is the same as on client
        if(app_id !== dresult.app.id) {
          if(! app_started) {
            startApp();
          }
          else {
            $('#new_app_id').text(dresult.app.id);
            $('#modal_app').modal('show');
          }
          return;
        }
        
        app_started = true;
      
        // Check if trigger mode (which may switch autorun) was changed during ajax request
        var arun_after_ajax = autorun;
        
        datasets = [];

		    var t_channel = $('#t-channel').text();

        var imena = [];
        imena.push($("#velicina-y1").val());
        imena.push($("#velicina-y2").val());
        
        for(var i=0; i<dresult.datasets.g1.length; i++) {
          dresult.datasets.g1[i].color = i;
          dresult.datasets.g1[i].label = imena[i];          
          datasets.push(dresult.datasets.g1[i]);
        }
        
        if(! plot) {
          initPlot(dresult.datasets.params);
        }
        else {
          // Apply the params state received from server if not in edit mode
          if(! user_editing) {
            loadParams(dresult.datasets.params);
            
            // Restore the autorun value modified by loadParams 
            if(arun_before_ajax != arun_after_ajax) {
              autorun = arun_after_ajax; 
            }
          }
          // Time units must be always updated
          else {
            updateTimeUnits(dresult.datasets.params);
          }
          
          // Force X min/max
          if(dresult.datasets.params.forcex_flag == 1) {
            var options = plot.getOptions();
            options.xaxes[0].min = dresult.datasets.params.xmin;
            options.xaxes[0].max = dresult.datasets.params.xmax;
          }
          
          // Redraw the plot using new datasets
          plot.setData(filterData(datasets, plot.width()));
          plot.setupGrid();
          plot.draw();
        }
        
        if(! trig_dragging) {
          updateTriggerSlider();
        }
        
        updateRanges();

        if(autorun || dresult.status === 'AGAIN') {
          if(autorun) {
            $('#btn_single').prop('disabled', true);
          }
          update_timer = setTimeout(function() {
            updateGraphData();
          }, update_interval);
        }
        else {
          $('#btn_single').prop('disabled', false);
        }
      }
      else {
        showModalError('Wrong application data received.', true, true);
      }
    })
    .fail(function(jqXHR, textStatus, errorThrown) {
      if(last_get_failed) {
        showModalError('Data receiving failed.<br>Error status: ' + textStatus, true, true);
        last_get_failed = false;
      }
      else {
        last_get_failed = true;
        downloading = false;
        updateGraphData();  // One more try
      }
    })
    .always(function() {
      if(! last_get_failed) {
        downloading = false;
        
        if(params.local) {
          // Disable trigger level input if trigger source is External or mode is not Normal
          if(params.original.trig_mode != 1 || params.original.trig_source == 2) {
            $('#trig_level').prop('disabled', true);
            if($('#trig_level').is(':focus')) {
              $('#trig_level').blur();
            }
            $('#apply_trig_level').hide().parent().removeClass('input-group');
          }
          else {
            $('#trig_level').prop('disabled', false);
          }
          
          // Manage the state of other components
          $('#accordion').find('input,select').not('#trig_level').prop('disabled', false);
          $('.btn').not('#btn_single, #range_y_plus, #range_y_minus, #range_x_plus, #range_x_minus, #gen_ch1_single, #gen_ch2_single').prop('disabled', false);
        }
      }
      
      if(long_timeout_used) {
        use_long_timeout = false;
      }
    });
  }
  
  function initPlot(init_params) {
    var plot_holder = $('#plot_holder');
    var ymax = init_params.gui_reset_y_range / 2;
    var ymin = ymax * -1;
    
    // Load received params
    loadParams(init_params);
    
    // When xmin/xmax are null, the min/max values of received data will be used. For ymin/ymax use the gui_reset_y_range param.
    $.extend(true, plot_options, {
      xaxis: { min: null, max: null },
      yaxis: { min: ymin, max: ymax }
    });
    
    // Local optimization    
    var filtered_data = filterData(datasets, plot_holder.width());
  
    // Plot first creation and drawing
    plot = $.plot(
      plot_holder, 
      filtered_data,
      plot_options
    );
    
    // Selection
    plot_holder.on('plotselected', function(event, ranges) {
    
      // Clamp the zooming to prevent eternal zoom
      if(ranges.xaxis.to - ranges.xaxis.from < 0.00001) {
        ranges.xaxis.to = ranges.xaxis.from + 0.00001;
      }
      if(ranges.yaxis.to - ranges.yaxis.from < 0.00001) {
        ranges.yaxis.to = ranges.yaxis.from + 0.00001;
      }
  
      // Do the zooming
      plot = $.plot(
        plot_holder, 
        getData(ranges.xaxis.from, ranges.xaxis.to),
        $.extend(true, plot_options, {
          xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
          yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to }
        })
      );
      
      params.local.xmin = parseFloat(ranges.xaxis.from.toFixed(xdecimal_places));
      params.local.xmax = parseFloat(ranges.xaxis.to.toFixed(xdecimal_places));
      
      updateTriggerSlider();
      sendParams(true);
    });
    
    // Zoom / Pan
    plot_holder.on('plotzoom plotpan touchmove touchend', function(event) {
      
      if(zoompan_timer) {
        clearTimeout(zoompan_timer);
        zoompan_timer = null;
      }
      
      zoompan_timer = setTimeout(function() {
        zoompan_timer = null;
        
        var xaxis = plot.getAxes().xaxis;
        params.local.xmin = parseFloat(xaxis.min.toFixed(xdecimal_places));
        params.local.xmax = parseFloat(xaxis.max.toFixed(xdecimal_places));
        
        updateTriggerSlider();
        sendParams(true);
                
      }, 250);
    });
  }
  
  function onDropdownChange(that, param_name, do_get) {
    params.local[param_name] = parseInt(that.val());
    sendParams(do_get);
    that.blur();
    user_editing = false;
  }
  
  function loadParams(orig_params) {
    if(! $.isPlainObject(orig_params)) {
      return;
    }
    
    // Ignore xmin/xmax values received from server. That values must be used only on AUTO button click 
    // and on ForceX flag, but that is done before the sendParams() function is called.
    if(plot) {
      var options = plot.getOptions();
      if(options.xaxes[0].min && options.xaxes[0].max) {
        orig_params.xmin = options.xaxes[0].min;
        orig_params.xmax = options.xaxes[0].max;
      }
    }
    
    // Same data in local and original params
    params.original = $.extend({}, orig_params);
    params.local = $.extend({}, params.original);

    // Autorun if trigger mode is Auto(0) or Normal(1), stop if it is Single(2)
    autorun = (params.original.trig_mode == 2 ? 0 : 1);
    
    // Enable the Single button when not in autorun mode

    $("#sprememba_xmin").val(zaokrozi(params.local.xmin));
    $("#sprememba_xmax").val(zaokrozi(params.local.xmax));

    $('#btn_single').prop('disabled', autorun);
    
    $('#trig_mode').val(params.original.trig_mode);
    $('#trig_source').val(params.original.trig_source);
    $('#trig_edge').val(params.original.trig_edge);
    var scale = (params.original.trig_source == 0 ? params.original.scale_ch1 : params.original.scale_ch2);
    $('#trig_level').val(floatToLocalString(params.original.trig_level * scale));
    
    if ((refresh_counter++ % meas_panel_dec) == 0) {
        $('#info_ch1_min').html(floatToLocalString(shortenFloat(params.original.meas_min_ch1)));
        $('#info_ch1_max').html(floatToLocalString(shortenFloat(params.original.meas_max_ch1)));
        $('#info_ch1_amp').html(floatToLocalString(shortenFloat(params.original.meas_amp_ch1)));
        $('#info_ch1_avg').html(floatToLocalString(shortenFloat(params.original.meas_avg_ch1)));
        $('#info_ch1_freq').html(convertHz(params.original.meas_freq_ch1));
        $('#info_ch1_period').html(convertSec(params.original.meas_per_ch1));

        $('#info_ch2_min').html(floatToLocalString(shortenFloat(params.original.meas_min_ch2)));
        $('#info_ch2_max').html(floatToLocalString(shortenFloat(params.original.meas_max_ch2)));
        $('#info_ch2_amp').html(floatToLocalString(shortenFloat(params.original.meas_amp_ch2)));
        $('#info_ch2_avg').html(floatToLocalString(shortenFloat(params.original.meas_avg_ch2)));
        $('#info_ch2_freq').html(convertHz(params.original.meas_freq_ch2));
        $('#info_ch2_period').html(convertSec(params.original.meas_per_ch2));
    }
    
    $('#gain_ch1_att').val(params.original.prb_att_ch1);
    $('#gain_ch1_sett').val(params.original.gain_ch1);
    $('#gain_ch2_att').val(params.original.prb_att_ch2);
    $('#gain_ch2_sett').val(params.original.gain_ch2);
    
    $('#gen_enable_ch1').prop('checked', (params.original.gen_enable_ch1 ? true : false));
    $('#gen_enable_ch2').prop('checked', (params.original.gen_enable_ch2 ? true : false));
    
    $('#gen_ch1_sigtype').val(params.original.gen_sig_type_ch1);

    $('#gen_ch1_ampl').val(floatToLocalString(params.original.gen_sig_amp_ch1));

    $('#gen_ch1_freq').val(floatToLocalString(params.original.gen_sig_freq_ch1));
    $('#gen_ch1_dc').val(floatToLocalString(params.original.gen_sig_dcoff_ch1));
    $('#gen_ch1_trigmode').val(params.original.gen_trig_mod_ch1);
    
    $('#gen_ch2_sigtype').val(params.original.gen_sig_type_ch2);
    $('#gen_ch2_ampl').val(floatToLocalString(params.original.gen_sig_amp_ch2));
    $('#gen_ch2_freq').val(floatToLocalString(params.original.gen_sig_freq_ch2));
    $('#gen_ch2_dc').val(floatToLocalString(params.original.gen_sig_dcoff_ch2));
    $('#gen_ch2_trigmode').val(params.original.gen_trig_mod_ch2);
    
    $('#gen_ch1_single').prop('disabled', (params.original.gen_trig_mod_ch1 == 1 ? false : true));
    $('#gen_ch2_single').prop('disabled', (params.original.gen_trig_mod_ch2 == 1 ? false : true));    
    
    if(params.original.en_avg_at_dec) {
      $('#btn_avg').removeClass('btn-default').addClass('btn-primary');
    }
    else {
      $('#btn_avg').removeClass('btn-primary').addClass('btn-default');
    }
    
    updateTimeUnits(orig_params);
    $('#ytitle').show();
  }
  
  function updateTimeUnits(new_params) {
    if(! $.isPlainObject(new_params)) {
      return;
    } 
    
    params.original.time_units = params.local.time_units = new_params.time_units;
    var timeu_lbl = (params.original.time_units == 0 ? 'µs' : (params.original.time_units == 1 ? 'ms' : 's'));
    $('#xtitle').text(  'Čas [ ' + timeu_lbl + ' ]').trigger('translate');
  }
  
  function isParamChanged() {
    if(params.original) {
      for(var key in params.original) {
        if(params.original[key] != params.local[key]) {
          return true;
        }
      }
    }
    return false;
  }
  
  function sendParams(refresh_data, force_send, single_btn) {

    if(sending || (force_send !== true && !isParamChanged())) {
      send_que = sending;
      return;
    }
    
    var auto_flag = params.local.auto_flag;  // Keep the value of auto_flag, because in POST response it is always 0
    sending = true;
    params.local.single_btn = (single_btn === true ? 1 : 0);
    use_long_timeout = !!auto_flag;
  
    $.ajax({
      type: 'POST',
      url: post_url,
      data: JSON.stringify({ datasets: { params: params.local } }),
      timeout: (use_long_timeout ? long_timeout : request_timeout),
      cache: false
    })
    .done(function(dresult) {
      // OK: Load the params received as POST result
      if(dresult.datasets !== undefined && dresult.datasets.params !== undefined) {
      
        // Use the provided min/max values only once after AUTO button was clicked
        if(auto_flag == 1 && dresult.datasets.params.min_y !== dresult.datasets.params.max_y) {
          var options = plot.getOptions();
          
          options.xaxes[0].min = dresult.datasets.params.xmin;
          options.xaxes[0].max = dresult.datasets.params.xmax;
          options.yaxes[0].min = dresult.datasets.params.min_y;
          options.yaxes[0].max = dresult.datasets.params.max_y;
          
          // Enable both channels after click on AUTO button
          if(!$('#btn_ch1').data('checked') || !$('#btn_ch2').data('checked')) {
            $('#btn_ch1').data('checked', true).removeClass('btn-default').addClass('btn-primary');
            $('#btn_ch2').data('checked', true).removeClass('btn-default').addClass('btn-primary');
            redrawPlot();
          }
          // Both channels are already active, do a quick redraw
          else {
            plot.setupGrid();
            plot.draw();
          }
        }
      
        if(auto_flag == 0 && dresult.datasets.params.forcex_flag == 1) {
          var options = plot.getOptions();
          
          options.xaxes[0].min = dresult.datasets.params.xmin;
          options.xaxes[0].max = dresult.datasets.params.xmax;
         
          plot.setupGrid();
          plot.draw();
        }      
      
        loadParams(dresult.datasets.params);
        updateTriggerSlider();
        
        if(refresh_data && !downloading) {
          updateGraphData();
        } 
      }
      else if(dresult.status == 'ERROR') {
        showModalError((dresult.reason ? dresult.reason : 'Error while sending data (E1).'), false, true, true);
        send_que = false;
      }
      else {
        showModalError('Error while sending data (E2).', false, true, true);
      }
    })
    .fail(function() {
      showModalError('Error while sending data (E3).', false, true, true);
    })
    .always(function() {
      sending = false;
      user_editing = false;
      
      if(send_que) {
        send_que = false;
        setTimeout(function(refresh_data) {
          sendParams(refresh_data);
        }, 100);
      }
    });
  }
  
  function getData(from, to) {

    var rangedata = new Array();

    for(var i=0; i<datasets.length; i++) {
      if(! $('#btn_ch' + (i+1)).data('checked')) {
        continue;
      }
      rangedata.push({ color: datasets[i].color, label: datasets[i].label, data: [] });

      for(var j=0; j<datasets[i].data.length; j++) {
        if(datasets[i].data[j][0] > to) {
          break;
        }
        if(datasets[i].data[j][0] >= from) {
          rangedata[rangedata.length - 1].data.push(datasets[i].data[j]);
        }
      }
    }
    rangedata = filterData(rangedata, (plot ? plot.width() : $('plot_holder').width()));
    return rangedata;
  }
  
  // Use only data for selected channels and do downsamling (data decimation), which is required for 
  // better performance. On the canvas cannot be shown too much graph points. 
  function filterData(dsets, points) {
    var filtered = [];
    var num_of_channels = 2;

    for(var l=0; l<num_of_channels; l++) {
      if(! $('#btn_ch' + (l+1)).data('checked')) {
        continue;
      }

      i = Math.min(l, dsets.length - 1);

      filtered.push({ color: dsets[i].color, label: dsets[i].label, data: [] });
      
      if(points_per_px === null || dsets[i].data.length > points * points_per_px) {
        var step = Math.ceil(dsets[i].data.length / (points * points_per_px));
        var k = 0;

        for(var j=0; j<dsets[i].data.length; j++) {
          if(k > 0 && ++k < step) {
            continue;
          }
          filtered[filtered.length - 1].data.push(dsets[i].data[j]);
          k = 1;
        }
      }
      else {
        filtered[filtered.length - 1].data = dsets[i].data.slice(0);
      }
    }
    
    filtered = addTriggerDataSet(filtered);
    return filtered;
  }
  
  // Add a data series for the trigger level line
  function addTriggerDataSet(dsets) {

    // Transform trigger level to real values
    var scale = (params.local.trig_source == 0 ? params.local.scale_ch1 : params.local.scale_ch2);
    var tlev = params.local.trig_level * scale;
  
    // Don't add trigger dataset if trigger level is outside the visible area...
    if(plot) {
      var yaxis = plot.getAxes().yaxis;
      if(tlev < yaxis.min || tlev > yaxis.max) {
        return dsets;
      }
    }
    // ...or trigger mode is not Normal
    if(params.local.trig_mode != 1) {
      return dsets;
    }
    // ...or trigger source is external
    if(params.local.trig_source == 2) {
      return dsets;
    }
    // ...or outside of received data for Y axis
    var ch1ymin = null, 
        ch1ymax = null;
    // Find Y min/max values from data for first visible channel
    for(var i=0; i<dsets[0].data.length; i++) {
      ch1ymin = (ch1ymin === null || ch1ymin > dsets[0].data[i][1] ? dsets[0].data[i][1] : ch1ymin);
      ch1ymax = (ch1ymax === null || ch1ymax < dsets[0].data[i][1] ? dsets[0].data[i][1] : ch1ymax);
    }
    if(dsets.length > 1) {
      var ch2ymin = null, 
          ch2ymax = null;
      // Find Y min/max values from data for second visible channel
      for(var i=0; i<dsets[1].data.length; i++) {
        ch2ymin = (ch2ymin === null || ch2ymin > dsets[1].data[i][1] ? dsets[1].data[i][1] : ch2ymin);
        ch2ymax = (ch2ymax === null || ch2ymax < dsets[1].data[i][1] ? dsets[1].data[i][1] : ch2ymax);
      }
      // Check if trigger level is outside of found values
      if(tlev < Math.min(ch1ymin, ch2ymin) || tlev > Math.max(ch1ymax, ch2ymax)) {
        return dsets;
      }
    }
    else {
      // Check if trigger level is outside of found values
      if(tlev < ch1ymin || tlev > ch1ymax) {
        return dsets;
      }
    }
  
    var index = 0;
    var dxmin = 0;
    var dxmax = 1;
    
    if(dsets.length && dsets[0].data[0]) {
      index = dsets.length;
      
      dxmin = dsets[0].data[0][0];
      dxmax = dsets[0].data[dsets[0].data.length - 1][0];
    }
    dsets[index] = { color: 2, data: [[dxmin, tlev], [dxmax, tlev]], shadowSize: 1 };
    
    return dsets;
  }
  
  function runStop() {
    if(autorun) {
      $('#btn_single').prop('disabled', true);
      updateGraphData();
    }
    else {
      $('#btn_single').prop('disabled', false);
      if(update_timer) {
        clearTimeout(update_timer);
        update_timer = null;
      }
    }
  }
  
  function singleUpdate() {
    if(! autorun) {
      sendParams(true, true, true);
    }
  }
  
  function redrawPlot() {
    if(! downloading) {
      if(! plot) {
        updateGraphData();
      }
      else {
        var options = plot.getOptions();
        plot = $.plot(
          plot.getPlaceholder(), 
          filterData(datasets, plot.width()),
          $.extend(true, plot_options, {
            xaxis: { min: options.xaxes[0].min, max: options.xaxes[0].max },
            yaxis: { min: options.yaxes[0].min, max: options.yaxes[0].max }
          })
        );
        updateTriggerSlider();        
      }
    }
  }
  
  function setVisibleChannels(btn) {
    var other_btn = $(btn.id == 'btn_ch1' ? '#btn_ch2' : '#btn_ch1');
    var btn = $(btn);
    var checked = !btn.data('checked');
    
    btn.data('checked', checked).toggleClass('btn-default btn-primary');
    
    // At least one button must be checked, so that at least one graph will be visible.
    if(! checked) {
      other_btn.data('checked', true).removeClass('btn-default').addClass('btn-primary');
    }
    redrawPlot();
  }
  
  function autoscaleY() {
    if(! plot) {
      return;
    }
    
    var options = plot.getOptions();
    var axes = plot.getAxes();
    
    // Set Y scale to data min/max + 10%
    options.yaxes[0].min = (axes.yaxis.datamin < 0 ? axes.yaxis.datamin * 1.1 : axes.yaxis.datamin - axes.yaxis.datamin * 0.1); 
    options.yaxes[0].max = (axes.yaxis.datamax > 0 ? axes.yaxis.datamax * 1.1 : axes.yaxis.datamax + axes.yaxis.datamax * 0.1);

    plot.setupGrid();
    plot.draw();
    
    updateRanges();
    updateTriggerSlider();
  }
  
  function setAvgAtDec() {
    if(! plot) {
      return;
    }
    
    $('#btn_avg').toggleClass('btn-default btn-primary');

    if($('#btn_avg').hasClass('btn-primary')) {
      params.local.en_avg_at_dec = 1;
    }
    else{
      params.local.en_avg_at_dec = 0;
    }

    sendParams(true, true);
  }

  function resetZoom() {
    if(! plot) {
      return;
    }
    
    $('#btn_ch1, #btn_ch2').data('checked', true).removeClass('btn-default').addClass('btn-primary');
    
    var ymax = params.original.gui_reset_y_range / 2;
    var ymin = ymax * -1;
    
    $.extend(true, plot_options, {
      xaxis: { min: null, max: null },
      yaxis: { min: ymin, max: ymax }
    });
         
    var options = plot.getOptions();
    options.xaxes[0].min = null;
    options.xaxes[0].max = null;
    options.yaxes[0].min = ymin;
    options.yaxes[0].max = ymax;
    
    plot.setupGrid();
    plot.draw();
    
    params.local.xmin = xmin;
    params.local.xmax = xmax;
    
    sendParams(true, true);
  }

  function updateZoom() {
    if(! plot) {
      return;
    }
    
    params.local.xmin = 0;
    params.local.xmax = time_range_max[params.local.time_range];
  
    var axes = plot.getAxes();
    var options = plot.getOptions();
    
    options.xaxes[0].min = params.local.xmin;
    options.xaxes[0].max = params.local.xmax;
    options.yaxes[0].min = axes.yaxis.min;
    options.yaxes[0].max = axes.yaxis.max;
    
    plot.setupGrid();
    plot.draw();

    sendParams(true, true);
  }
  
  function selectTool(toolname) {
    $('#selzoompan .btn').removeClass('btn-primary').addClass('btn-default');
    $(this).toggleClass('btn-default btn-primary');
  
    if(toolname == 'zoomin') {
      enableZoomInSelection();
    }
    if(toolname == 'zoomout') {
      enableZoomOut();
    }
    else if(toolname == 'pan') {
      enablePanning();
    }
  }

  function enableZoomInSelection() {
    if(plot_options.hasOwnProperty('selection')) {
      return;
    }
    
    var plot_pholder = plot.getPlaceholder();

    // Disable panning and zoom out
    delete plot_options.pan;
    plot_pholder.off('click.rp');
    
    // Get current min/max for both axes to use them to fix the current view
    var axes = plot.getAxes();
    
    plot = $.plot(
      plot_pholder, 
      plot.getData(),
      $.extend(true, plot_options, {
        selection: { mode: 'xy' },
        xaxis: { min: axes.xaxis.min, max: axes.xaxis.max },
        yaxis: { min: axes.yaxis.min, max: axes.yaxis.max }
      })
    );
  }
  
  function enableZoomOut() {
    var plot_pholder = plot.getPlaceholder();
    
    plot_pholder.on('click.rp', function(event) {
      var offset = $(event.target).offset();
      
      plot.zoomOut({
        center: { left: event.pageX - offset.left, top: event.pageY - offset.top },
        amount: 1.2
      });
    });
    
    // Disable zoom in selection and panning
    delete plot_options.selection;
    delete plot_options.pan;
    
    // Get current min/max for both axes to use them to fix the current view
    var axes = plot.getAxes();
    
    plot = $.plot(
      plot_pholder, 
      plot.getData(),
      $.extend(true, plot_options, {
        xaxis: { min: axes.xaxis.min, max: axes.xaxis.max },
        yaxis: { min: axes.yaxis.min, max: axes.yaxis.max }
      })
    );
  }
  
  function enablePanning() {
    if(plot_options.hasOwnProperty('pan')) {
      return;
    }
    
    var plot_pholder = plot.getPlaceholder();
    
    // Disable selection zooming and zoom out
    delete plot_options.selection;
    plot_pholder.off('click.rp');
    
    // Get current min/max for both axes to use them to fix the current view
    var axes = plot.getAxes();
    
    plot = $.plot(
      plot_pholder, 
      plot.getData(),
      $.extend(true, plot_options, {
        pan: { interactive: true },
        xaxis: { min: axes.xaxis.min, max: axes.xaxis.max },
        yaxis: { min: axes.yaxis.min, max: axes.yaxis.max }
      })
    );
  }
  
  function mouseDownMove(that, evt) {
    var y;
    user_editing = true;
    
    if(evt.type.indexOf('touch') > -1) {
      y = evt.originalEvent.touches[0].clientY - that.getBoundingClientRect().top - plot.getPlotOffset().top;
      touch_last_y = y;
    }
    else {
      y = evt.clientY - that.getBoundingClientRect().top - plot.getPlotOffset().top;
    }
    updateTriggerSlider(y);
    
    $('#trigger_tooltip').data('bs.tooltip').options.title = plot.getAxes().yaxis.c2p(y).toFixed(trigger_level_xdecimal_places);
    $('#trigger_tooltip').tooltip('show');
  }

  function mouseUpOut(evt) {
    if(trig_dragging) {
      trig_dragging = false;
      
      var y;
      if(evt.type.indexOf('touch') > -1) {
        //y = evt.originalEvent.touches[0].clientY - this.getBoundingClientRect().top - plot.getPlotOffset().top;
        y = touch_last_y;
      }
      else {
        y = evt.clientY - this.getBoundingClientRect().top - plot.getPlotOffset().top;
      }
      
      var scale = (params.local.trig_source == 0 ? params.local.scale_ch1 : params.local.scale_ch2);
      params.local.trig_level = parseFloat(plot.getAxes().yaxis.c2p(y).toFixed(trigger_level_xdecimal_places)) / scale;           
      
      updateTriggerSlider();
      redrawPlot();
      sendParams();
    }
    else {
      user_editing = false;
    }
    $('#trigger_tooltip').tooltip('hide');
  }
  
  function updateTriggerSlider(y, update_input) {
    if(! plot) {
      return;
    }
    
    var canvas = $('#trigger_canvas')[0];
    var context = canvas.getContext('2d');
    var plot_offset = plot.getPlotOffset();
    var ymax = params.original.gui_reset_y_range / 2;
    var ymin = ymax * -1;
    
    // Transform trigger level to real values
    // TODO: local or original params?
    var scale = (params.local.trig_source == 0 ? params.local.scale_ch1 : params.local.scale_ch2);
    var tlev = params.local.trig_level * scale;

    // If trigger level is outside the predefined ymin/ymax, change the level
    
    if(tlev < ymin) {
      tlev = ymin;
    }
    else if(tlev > ymax) {
      tlev = ymax;
    }
    
    if(y === undefined) {
      if(update_input !== false) {
        $('#trig_level').not(':focus').val(floatToLocalString(tlev));
      }
      y = plot.getAxes().yaxis.p2c(tlev);
    }
    
    // If trigger source is External or mode is not Normal or trigger level is not in visible area, do not show the trigger slider and paint the vertical line with gray
    context.clearRect(0, 0, canvas.width, canvas.height); 
    var yaxis = plot.getAxes().yaxis;
    if(params.original.trig_mode != 1 || tlev < yaxis.min || tlev > yaxis.max || params.original.trig_source == 2) {
      context.lineWidth = 1;
      context.strokeStyle = '#dddddd';
      context.stroke();
      context.beginPath();
      context.moveTo(10, plot_offset.top);
      context.lineTo(10, canvas.height - plot_offset.bottom + 1);
      context.stroke();
    }
    else {
      context.beginPath();
      context.arc(10, y + plot_offset.top, 8, 0, 2 * Math.PI, false);
      context.fillStyle = '#009900';
      context.fill();
      context.lineWidth = 1;
      context.strokeStyle = '#007700';
      context.stroke();
      context.beginPath();
      context.moveTo(10, plot_offset.top);
      context.lineTo(10, canvas.height - plot_offset.bottom + 1);
      context.stroke();
    }
    $('#trigger_tooltip').css({ top: y + plot_offset.top });  
  }
  
  function updateRanges() {

    var xunit = (params.local.time_units == 0 ? 'µs' : (params.local.time_units == 1 ? 'ms' : 's'));
    var yunit = 'V';
    var axes = plot.getAxes();
    var xrange = axes.xaxis.max - axes.xaxis.min;
    var yrange = axes.yaxis.max - axes.yaxis.min;
    var y2range = axes.y2axis.max - axes.y2axis.min;
    var yminrange = 5e-3;  // Volts
    var ymaxrange = params.original.gui_reset_y_range;
    var xmaxrange = 10.0;  // seconds
    var xminrange = 20e-9; // seconds
    var decimals = 0;

    if(xunit == 'µs' && xrange < 1) {
      xrange *= 1000;
      xunit = 'ns';
    }
    if(xrange < 1) {
      decimals = 1;
    }
    var seconds = (xunit == 'ns' ? 1e-9 : ( xunit == 'µs' ? 1e-6 : (xunit == 'ms' ? 1e-3 : 1)));
    
    /*
    if(yrange < 1) {
      yunit = 'mV';
      yrange *= 1000;
      ymaxrange *= 1000;
      yminrange *= 1000;
    }
    */

    $('#range_x').html(+(Math.round(xrange + "e+" + decimals) + "e-" + decimals) + ' ' + xunit);
    $('#range_y').html(Math.floor(yrange) + ' ' + yunit);
    
    var nearest_x = getNearestRanges(xrange);
    
    // X limitations 
    if(nearest_x.next * seconds > xmaxrange) {
      nearest_x.next = null;
      $('#range_x_plus').prop('disabled', true);
    }
    else {
      $('#range_x_plus').prop('disabled', false);
    }
    if(nearest_x.prev * seconds < xminrange) {
      nearest_x.prev = null;
      $('#range_x_minus').prop('disabled', true);
    }
    else {
      $('#range_x_minus').prop('disabled', false);
    }
    
    $('#range_x_minus').data({ nearest: nearest_x.prev, unit: xunit }).data('bs.tooltip').options.title = nearest_x.prev;
    $('#range_x_plus').data({ nearest: nearest_x.next, unit: xunit }).data('bs.tooltip').options.title = nearest_x.next;
    
    // Y limitations
    //y_limitations('#range_y_minus, .range_y_minus','#range_y_plus',nearest_y,yminrange,ymaxrange,yunit);
    //y_limitations('#range_y2_minus','#range_y2_plus, .range_y2_plus',nearest_y2,yminrange,ymaxrange,yunit);
  }
  
  function getNearestRanges(number) {

    var log10 = Math.floor(Math.log(number) / Math.LN10); 
    var normalized = number / Math.pow(10, log10);    
    var i = 0;
    var prev = null;
    var next = null;
    
    while(i < range_steps.length - 1) {

      var ratio = range_steps[i+1] / normalized;

      if(ratio > 0.99 && ratio < 1.01) {
        prev = range_steps[i];
        next = range_steps[i+2];
        break;
      }

      if(range_steps[i] < normalized && normalized < range_steps[i+1]) {
        prev = range_steps[i];
        next = range_steps[i+1];
        break;
      }
      i++;
    }

    return { 
      prev: prev * Math.pow(10, log10), 
      next: next * Math.pow(10, log10) 
    };
  }
  
  function serverAutoScale() {
    params.local.auto_flag = 1;
    sendParams(true);
  }
  
  function postGenSingle(channel) {
    if(params.local['gen_trig_mod_ch' + channel] == 1) {
      params.local['gen_single_ch' + channel] = 1;
      sendParams();
    }
    else {
      $('#gen_ch' + channel + '_single').prop('disabled', true);
    }
    return false;
  }
  
  function showUploadForm(channel) {
    var file_elem = $('#uploaded_file');
    var fcontent_elem = $('#uploaded_file_content');
    var hint_elem = $('#upload_form .help-block');
    
    fcontent_elem.val('');
    hint_elem.html('Select the CSV file to upload.');
    $('#upload_form')[0].reset();
    $('#modal_upload_label span').text(channel);
    
    if(file_elem[0].files === undefined) {
      file_elem.hide().parent().addClass('has-error');
      hint_elem.html('Your browser is too old and do not support this feature.');
    }
    else {
      file_elem.show().parent().removeClass('has-error');
      file_elem.off('change').on('change', function() {
        var file = this.files[0];
        var freader = new FileReader();
        
        // File validation
        //var size = file.size;
        var type = file.type;
        if(file.type !== 'text/csv' && file.type !== 'text/comma-separated-values' && file.type !== 'application/vnd.ms-excel') {
          file_elem.parent().addClass('has-error');
          hint_elem.html('Wrong file type: ' + file.type);
          $('#upload_form')[0].reset();
        }
        else {
          file_elem.parent().removeClass('has-error');
          hint_elem.html('File size: ' + file.size + ' bytes');
          freader.onload = function(data) {
            fcontent_elem.val(this.result);
          };
          freader.readAsText(file);
        }
      });
    }
    
    $('#modal_upload').modal('show');
    
    return false;
  }
  
  function startUpload() {
    var mbody = $('#modal_upload .modal-body');
    var file_elem = $('#uploaded_file');
    var hint_elem = $('#upload_form .help-block');
    var channel = $('#modal_upload_label span').text();
    
    if(mbody.data('errtimer')) {
      clearTimeout(mbody.data('errtimer'));
      mbody.removeData('errtimer');
    }
    
    if(! $('#uploaded_file').val().length) {
      mbody.addClass('alert-danger').data('errtimer', setTimeout(function() { 
        $('#modal_upload .modal-body').removeClass('alert-danger'); 
      }, 1000));
      return;
    }
    
    file_elem.hide();
    hint_elem.html('Uploading file...');
    
    $.post(upload_url + channel, $('#uploaded_file_content').val(), function(dresult) {
      if($.type(dresult) == 'string' && dresult.trim() == 'OK') {
        $('#upload_form')[0].reset();
        $('#modal_upload').modal('hide');
        
        user_editing = true;
        params.local.gen_awg_refresh = parseInt(channel);
        sendParams();
      }
      else {
        file_elem.show();
        hint_elem.html('Error while uploading the file.');
        file_elem.parent().addClass('has-error');
      }
    })
    .fail(function() {
      file_elem.show();
      hint_elem.html('Error while uploading the selected file.');
      file_elem.parent().addClass('has-error');
    });
  }
  
  function getLocalDecimalSeparator() {
    var n = 1.1;
    return n.toLocaleString().substring(1,2);
  }
  
  function parseLocalFloat(num) {
    return +(num.replace(getLocalDecimalSeparator(), '.'));
  }
  
  function floatToLocalString(num) {
    // Workaround for a bug in Safari 6 (reference: https://github.com/mleibman/SlickGrid/pull/472)
    //return num.toString().replace('.', getLocalDecimalSeparator());
    return (num + '').replace('.', getLocalDecimalSeparator());
  }
  
  function shortenFloat(value) {
    return value.toFixed(Math.abs(value) >= 10 ? 1 : 3);
  }

  function convertHz(value) {
    var unit = '';
    var decsep = getLocalDecimalSeparator();
    
    if(value >= 1e6) {
      value /= 1e6;
      unit = '<span class="unit">MHz</span>';
    }
    else if(value >= 1e3) {
      value /= 1e3;
      unit = '<span class="unit">kHz</span>';
    }
    else {
      unit = '<span class="unit">Hz</span>';
    }

    // Fix to 4 decimal digits in total regardless of the decimal point placement
    var eps = 1e-2;
    if (value >= 100 - eps) {
      value = value.toFixed(1);
    }
    else if  (value >= 10 - eps) {
      value = value.toFixed(2);
    }
    else {
      value = value.toFixed(3);
    }
    
    value = (value == 0 ? '---' + decsep + '-' : floatToLocalString(value));
    return value + unit;
  }
  
  function convertSec(value) {
    var unit = '';
    var decsep = getLocalDecimalSeparator();
    
    if(value < 1e-6) {
      value *= 1e9;
      unit = '<span class="unit">ns</span>';
    }
    else if(value < 1e-3) {
      value *= 1e6;
      unit = '<span class="unit">µs</span>';
    }
    else if(value < 1) {
      value *= 1e3
      unit = '<span class="unit">ms</span>';
    }
    else {
      unit = '<span class="unit">s</span>';
    }

    // Fix to 4 decimal digits in total regardless of the decimal point placement
    var eps = 1e-2;
    if (value >= 100 - eps) {
      value = value.toFixed(1);
    }
    else if  (value >= 10 - eps) {
      value = value.toFixed(2);
    }
    else {
      value = value.toFixed(3);
    }
    
    value = (value == 0 ? '---' + decsep + '-' : floatToLocalString(value));
    return value + unit;
  }

  /*
    
    1-3 tuljava
    4-6 kondenzator
    7-9 upor
    10-12 dioda

    a) trikotni
    b) pravokotni
    c) sinusni
    
    */

  function premajhnaNapetost(){

    vrednostF1 = $("#faktor-y1").val().replace(" ","").replace("[", "").replace("]", "").split(","); 

    vrednostF2 = $("#faktor-y2").val().replace(" ","").replace("[", "").replace("]", "").split(","); 

    napetost1 = params.local.meas_amp_ch1*parseFloat(vrednostF1[0]) + params.local.meas_amp_ch2*parseFloat(vrednostF1[1]) + parseFloat(vrednostF1[2]);

    napetost2 = params.local.meas_amp_ch1*parseFloat(vrednostF2[0]) + params.local.meas_amp_ch2*parseFloat(vrednostF2[1]) + parseFloat(vrednostF2[2]);

    if(params.local.gen_sig_freq_ch1 != 0){

      if( ((napetost1 - napetost2) < 0.04 || napetost1 < 0.04) && ((napetost1 - napetost2) > 0 || napetost1 > 0)){

        $("#naslednjiObvestilo").find(".alert").eq(0).css("display", "");
      }
      else if( ((napetost1 - napetost2) > -0.04 || napetost1 > -0.04) && ((napetost1 - napetost2) < 0 || napetost1 < 0)){

        $("#naslednjiObvestilo").find(".alert").eq(0).css("display", "");
      }
      else{

        $("#naslednjiObvestilo").find(".alert").eq(0).css("display", "none");      
      }

      if((params.local.meas_amp_ch1 > 2 && params.local.meas_amp_ch1 > 0) || (params.local.meas_amp_ch1 < -2 && params.local.meas_amp_ch1 < 0)){

        $("#naslednjiObvestilo").find(".alert").eq(1).css("display", "");
      }
      else{

        $("#naslednjiObvestilo").find(".alert").eq(1).css("display", "none");
      }
    }
    else{

      $("#naslednjiObvestilo").find(".alert").eq(0).css("display", "none"); 
      $("#naslednjiObvestilo").find(".alert").eq(1).css("display", "none");     
    }
  }

  function nastavitveElementov(send, el, minF, maxF, defF, amp, y1min, y1max, y2min, y2max, xmax){

      params.local.gen_sig_freq_ch1 = defF;
      $('#gen_ch1_freq')[0].value = defF;

      if(send){
        params.local.read_element = el;
      }

      params.local.gen_sig_amp_ch1 = amp;

      najmanjsaFrekvenca = minF;
      najvecjaFrekvenca = maxF;

      $("#ymin-y1").val(y1min);
      $("#ymax-y1").val(y1max);

      $("#ymin-y2").val(y2min);
      $("#ymax-y2").val(y2max);

      var a = $("#sprememba_xmax").val(xmax);
      xMaksimum(a);

      indeks = el;
      izbrano = true;

      am.update(true);

      if(send){
        sendParams();
      }
    }

  function nastaviElement(send){

    var cookie = parseInt(getFirstCookie());

    var div = Math.ceil(cookie/3) - 1;
    var ostanek = cookie - 3*div - 1;

    ostanek = 2 - ostanek;

    if(params.local != null){

      if(div == 0){
        params.local.read_element = 2;
      }
      else if(div == 2){
        params.local.read_element = 0;
      }
      else{
        params.local.read_element = div; 
      }

      params.local.gen_sig_type_ch1 = ostanek;

      if(send){
        sendParams();
      }

      $('#gen_ch1_sigtype').val(ostanek);
    }
  }

  function xMaksimum(s){

      if(plot) {

        var options = plot.getOptions();
        var axes = plot.getAxes();

        var min = parseFloat($('#sprememba_xmin').val());
        var max = parseFloat(s.val());
        
        if(stariXmax != max){

          if(!isNaN(max) && min < max ){

            options.xaxes[0].max = max;

            plot.setupGrid();
            plot.draw();
            
            params.local.xmax = max;
            
            updateRanges();

            s.tooltip( s.prop('disabled') === true ? 'hide' : 'show');
            sendParams(true);
          }
          else if(max < min){
            s.val(stariXmax);
          }
        }

        stariXmax = max;
      }
    }

  function getFirstCookie(){

    var ca = document.cookie.split(';');
    var c = ca[0];
      
    c = c.split(" ").toString();
    
    var s = c[c.length - 2] + c[c.length - 1];

    if(s[0] == "="){
      s = c[c.length - 1];
    }

    if(isNaN(parseInt(s))){

      c = ca[1];
      c = c.split(" ").toString();
      
      s = c[c.length - 2] + c[c.length - 1];

      if(s[0] == "="){
        s = c[c.length - 1];
      }
    }

    return s;
  }

  function setCookie(cname, cvalue, exdays){

      var d = new Date();
      d.setTime(d.getTime() + (exdays*24*60*60*1000));
      var expires = "expires="+d.toUTCString();
      document.cookie = cname + "=" + cvalue + "; " + expires;
    }

    function eraseCookie(cname){

      var d = new Date();
      d.setTime(-1);
      var expires = "expires="+d.toUTCString();
      document.cookie = cname + "=" + "42" + "; " + expires;
    }

    function getFirstCookieName(){

      var ca = document.cookie.split(';');
      var c = ca[0].replace(/(^[\s]+|[\s]+$)/g, '');

      var s = c[0] + c[1];

      if(c[1] == "="){
        s = c[0];
      }

      if(isNaN(s)){

        c = ca[1];
        s = c[0] + c[1];

        if(c[1] == "="){
          s = c[0];
        }
      }

      return s;
    }

    function getCookie(cname){

        var name = cname + "=";
        var ca = document.cookie.split(';');

        for(var i=0; i<ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') 
              c = c.substring(1);
            if (c.indexOf(name) == 0) 
              return c.substring(name.length, c.length);
        }
        return "";
    }

    function shuffle(array){
      var currentIndex = array.length, temporaryValue, randomIndex ;

      // While there remain elements to shuffle...
      while (0 !== currentIndex) {

        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }

      return array;
    }

  function lenCookie(){

    var ca = document.cookie.split(';');
    
    if(ca[0] != ""){
      return ca.length;
    }
    else{
      return 0;
    }
  }

  function zaokrozi(a){

    var s = a.toString();
    var n;

    var i = s.indexOf(".");

    if(i != -1){
      if(i > 2){
          n = Math.round(a);
      }
      else{
        n = a.toPrecision(3);
      }
    }
    else{
        var j = s.indexOf(",");
        if(j != -1){
          if(i > 2){
            n = Math.round(a);
          }
          else{
            n = a.toPrecision(3);
          }   
        }
        else{
          n = a;
        }
    }
    return n;
  }
  
  </script>
  <script src="../assets/redpitaya.custom.js"></script>
</head>
<body>
  <div class="header">
    <div class="container">
      <a id="btn_exit" class="pull-left" href="../../../apps"><span class="glyphicon glyphicon-chevron-left" title="Exit" alt="Exit"></span></a>
      <img class="logo pull-left" src="../assets/images/eEksperimenti_logo.png">
      <h2 class="page-title pull-left"> eNapetost/Tok </h2>
      <div class="cdropdown dropdown-menu-right pull-right" style="margin-top: 1em; display: none;">
        <button id="langage" class="btn btn-default dropdown-toggle btn-info" style="color: #FFF;" type="button" data-toggle="dropdown">Jezik
        <span class="caret" ></span></button>
        </button>
        <ul class="dropdown-menu">
        <li><a href="#en" class='translate' >en</a></li>
        <li><a href="#sl" class='translate' >sl</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- <a href='#sl' class='translate' style ="float: right"">sl</a>
  <a href='#en' class='translate' style ="float: right">en</a> -->
  
  <div class="row" style="margin: 1em 2em 0 2em;">
    <div class="col-xs-1"></div>
    <div class="col-xs-6">
      <div class="col-xs-5" style="margin: 0.5em 0 0 0;">
        <select id="izberiElement" class="input-sm">
          <option selected="selected">
            Izberite element
          </option>
          <option>
            Upor
          </option>
          <option>
            Tuljava
          </option>
          <option>
            Kondenzator
          </option>
          <option>
            Dioda
          </option>
        </select>
      </div>
      <div class="col-xs-7">
        <div class="col-xs-4">
          <button id="zvok1" style="background-color: white; border: none;" data-content="S klikom na ta gumb, se signal na zaslonu pretvori v zvočni signal z uporabo pretvorbe iz amplitude v frekvenco (amplitudno frekvenčna modulacija). To je eksperimentalni sistem, ki je namenjen slabovidnim ali slepim, ki jim ta način morda lahko olajša ali sploh omogoča sodelovanje pri eksperimentih. Sinusni signal se torej ne sliši kot zvok ene frekvence pač pa kot izmenjaje višji in nižji toni. <br><br> Aplikacija deluje smiselno, če graf na sliki miruje. To dosežemo z ustrezno nastavitvijo Proženja signala." data-placement="bottom">
          <img class="img-responsive" src="../assets/images/zvok_simbol_ch1.png" alt="zvok1" style="width: 100%;"/>
          </button>
        </div>
        <div class="col-xs-4">
          <button id="zvok2" style="background-color: white; border: none;" data-content="S klikom na ta gumb, se signal na zaslonu pretvori v zvočni signal z uporabo pretvorbe iz amplitude v frekvenco (amplitudno frekvenčna modulacija). To je eksperimentalni sistem, ki je namenjen slabovidnim ali slepim, ki jim ta način morda lahko olajša ali sploh omogoča sodelovanje pri eksperimentih. Sinusni signal se torej ne sliši kot zvok ene frekvence pač pa kot izmenjaje višji in nižji toni. <br><br> Aplikacija deluje smiselno, če graf na sliki miruje. To dosežemo z ustrezno nastavitvijo Proženja signala." data-placement="bottom">
          <img class="img-responsive" src="../assets/images/zvok_simbol_ch2.png" alt="zvok2" style="width: 100%;"/>
          </button>
        </div>
        <div class="col-xs-4"></div>
      </div>
    </div>
    <div class="col-xs-4">
      <div class="col-xs-12" id="naslednjiObvestilo" style="padding: 0; height: 1em;">
        <div class="alert alert-danger text-center" style="display: none; padding: 0 1em;">
          Napetost na elementu je premajhna, da bi jo lahko dovolj natančno izmerili.
        </div>
        <div class="alert alert-danger text-center" style="display: none; padding: 0 1em;">
          Tok skozi element je prevelik, da bi ga lahko dovolj natančno izmerili.
        </div>
      </div>
    </div>
    <div class="col-xs-1"></div>
  </div>

  <div class="container" style="padding-top: 0;">
    <div class="row">
      <div id="btn_toolbar" class="col-xs-12" style="display:none">
        
        <div id="selzoompan" class="btn-group" data-toggle="buttons">
          <button id="btn_zoomin" class="btn btn-primary" onclick="selectTool.call(this, 'zoomin')" style="display: none">
            <span class="glyphicon glyphicon-zoom-in"></span>
          </button>
          <button id="btn_zoomout" class="btn btn-default" onclick="selectTool.call(this, 'zoomout')" style="display: none">
            <span class="glyphicon glyphicon-zoom-out"></span>
          </button>
          <button id="btn_pan" class="btn btn-default" onclick="selectTool.call(this, 'pan')" style="display: none">
            <span class="glyphicon glyphicon-move"></span>
          </button>
          <button id="btn_zoompan" class="btn btn-primary btn-lg" onclick="selectTool.call(this, 'zoompan')" style="display: none">
            <span class="glyphicon glyphicon-search"></span><span class="glyphicon glyphicon-move"></span>
          </button>
        </div>
        <button id="btn_ch1" class="btn btn-primary btn-lg" data-checked="true" onclick="setVisibleChannels(this)">Kanal 1</button>
        <button id="btn_ch2" class="btn btn-primary btn-lg" data-checked="true" onclick="setVisibleChannels(this)">Kanal 2</button>
        
        <!-- <button id="btn_avg" class="btn btn-default btn-lg" onclick="setAvgAtDec()">Averaging</button>
		-->
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12 col-sm-12 col-md-8">
        <div class="btn-group zoomYaxis leftZoom">
            <button id="range_y_minus" type="button" class="btn btn-lg range-btn-left" style="background-color: rgb(40, 97, 161); color: white;">
              <span class="glyphicon glyphicon-minus"></span>
            </button>
            <button id="range_y_plus" type="button" class="btn btn-lg range-btn-right" style="background-color: rgb(40, 97, 161); color: white;">
              <span class="glyphicon glyphicon-plus"></span>
            </button>
            </div>
        <div class="btn-group zoomYaxis rightZoom">
          <button id="range_y2_minus" type="button" class="btn btn-lg range-btn-left" style="background-color: rgb(197, 29, 34); color: white;">
            <span class="glyphicon glyphicon-minus"></span>
          </button>
          <button id="range_y2_plus" type="button" class="btn btn-lg range-btn-right" style="background-color: rgb(197, 29, 34); color: white;">
            <span class="glyphicon glyphicon-plus"></span>
          </button>
        </div>
        <div class="graph-holder well well-small">
          <div id="ytitle" style="color: rgb(40, 97, 161);">Napetost [ V ]</div>
          <div id="trigger_cnv_holder">
            <canvas id="trigger_canvas" width="25" height="460"></canvas>
            <div id="trigger_tooltip"></div>
          </div>
          <div id="plot_holder"></div>
          <div id="xtitle"></div>
		        <span id='t-channel' style='display: none'>Kanal </span>
        </div>
        <div class="col-xs-5 text-center" style="margin-top: -10px;left:50px">
          <div>
            <span> časovni interval </span>
          </div>
          <div class="btn-group" style="margin-bottom: -3px;">
            <button id="range_x_minus" type="button" class="btn btn-primary btn-lg range-btn-left">
              <span class="glyphicon glyphicon-minus"></span>
            </button>
            <button id="range_x_plus" type="button" class="btn btn-primary btn-lg range-btn-right">
              <span class="glyphicon glyphicon-plus"></span>
            </button>
          </div>
          <div>
            <span id="range_x" class="badge range-badge">-</span>
          </div>
        </div>
        <div class="col-xs-5 text-center" style="margin-top: -10px;left:50px">
          <div>
            <span> časovni zamik </span>
          </div>
          <div class="btn-group" style="margin-bottom: -3px;">
            <button id="offset_x_minus" type="button" class="btn btn-primary btn-lg range-btn-left">
              <span class="glyphicon glyphicon-minus"></span>
            </button>
            <button id="offset_x_plus" type="button" class="btn btn-primary btn-lg range-btn-right">
              <span class="glyphicon glyphicon-plus"></span>
            </button>
          </div>
        </div>
      </div>
        <div class="col-md-4 col-xs-12 col-sm-12" style="padding-top: 2em;">
          <ul class="nav nav-tabs" id="zavihki">
              <li style="width: 34%; cursor: pointer;"><a data-toggle="tab" data-target="#meritve" class="text-center"> MERITVE </a></li>
              <li style="width: 33%; cursor: pointer;">
                <a data-toggle="tab" data-target="#kviz" class="text-center"> KVIZ </a>
              </li>
              <li class="active" style="width: 33%; cursor: pointer;">
                <a data-toggle="tab" class="text-center" data-toggle="dropdown" data-target="#navodila"> NAVODILA </a>
              </li>
          </ul>
            <div class="tab-content" id="desno">
              <div class="tab-pane fade" id="meritve">
    <div class="panel-group col-xs-12" id="accordion">
      <div class="panel panel-default">
          <a data-toggle="collapse" data-target="#settings" style="cursor: pointer;">
            <div class="panel-heading">
              <h4 class="panel-title">
                  Nastavitve prikaza 
                </a>
              </h4>
            </div>
          </a>
          <div id="settings" class="panel-collapse collapse in"> 
            <div class="container">
              <div class="panel-group" style="margin-top: 1em;">
                <div class="panel panel-default">
                  <a data-toggle="collapse" data-target="#osX" style="color: black; text-decoration: none; cursor: pointer;">
                    <div class="panel panel-heading" style="background-color: rgb(242, 242, 242);">
                      <h4 class="panel-title">
                        Abscisa = Čas
                      </h4>
                    </div>
                  </a>
                  <div class="panel-collapse collapse" id="osX" style="padding: 0 1em;">
                    <div class="panel-body" style="border: none;">
                      <div class="text-center">
                        Enote vnešenih vrednosti so enake tistim na grafu.
                      </div>
                      <label for="sprememba_xmin"> X<sub>min</sub> </label>
                      <input type="number" class="form-control" id="sprememba_xmin">
                      <label for="sprememba_xmax" style="padding-top: 1em;"> X<sub>max </sub> </label>
                      <input type="number" class="form-control" id="sprememba_xmax">
                    </div>
                  </div>
                </div>
                <div class="panel panel-default" id="nastavitve1">
                  
                </div>
                <div class="panel panel-default" id="nastavitve2">
                  
                </div>
                <div id="nastavitve3">
                  
                </div>
              </div>
            </div>
          </div>
      </div>
		  <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#autoscale">
                Samodejna nastavitev merilnih območij
              </a>
            </h4>
          </div>
          <div  id="autoscale"  class="panel-collapse collapse"> 
            <div class="container">
				<div class="row" style="margin: 4px">
					<button id="btn_autoscale_y" class="btn btn-primary btn-block" data-autozoom="false" onclick="serverAutoScale()">
						<span class="glyphicon glyphicon-move"></span> Napetostnega in časovnega
					</button>
				</div>
				
				<div class="row" style="margin: 4px">
					<button id="btn_auto" class="btn btn-primary btn-block"  onclick="autoscaleY()">
						<span class="glyphicon glyphicon-resize-vertical"></span> Napetostnega
					</button>
				</div>
				<div class="row" style="margin: 4px">
					<button id="btn_resetZoom" class="btn btn-primary btn-block" onclick="resetZoom()">
						<span class="glyphicon glyphicon-retweet"></span> Ponastavi
					</button>  
				</div> 
				 
			</div>
          </div>
        </div>	
		
        <div class="panel panel-default" style="display:none">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#range">
                Range
              </a>
            </h4>
          </div>
          <div id="range" class="panel-collapse collapse">
            <div class="panel-body">
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="form-group">
                  <label class="col-xs-4 col-sm-3 control-label" style="padding-top: 35px;">Range :</label>
                  <div class="col-xs-8 col-sm-9">
                    <div class="row">
                    
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-xs-4 col-sm-3 control-label">Premik:</label>
                  <div class="col-xs-8 col-sm-9">
                    <div class="row">
                      <div class="col-xs-6 text-center">
                        <div class="btn-group" style="margin-bottom: -3px;">
                          <button id="offset_x_minus" type="button" class="btn btn-primary btn-lg range-btn-left">
                            <span class="glyphicon glyphicon-minus"></span>
                          </button>
                          <button id="offset_x_plus" type="button" class="btn btn-primary btn-lg range-btn-right">
                            <span class="glyphicon glyphicon-plus"></span>
                          </button>
                        </div>
                      </div>
                      <div class="col-xs-6 text-center">
                        <div class="btn-group" style="margin-bottom: -3px;">
                          <button id="offset_y_minus" type="button" class="btn btn-primary btn-lg range-btn-left">
                            <span class="glyphicon glyphicon-minus"></span>
                          </button>
                          <button id="offset_y_plus" type="button" class="btn btn-primary btn-lg range-btn-right">
                            <span class="glyphicon glyphicon-plus"></span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
		
        <div class="panel panel-default" style="display: none;">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#measure">
                Prikaz signalnih parametrov
              </a>
            </h4>
          </div>
          <div id="measure" class="panel-collapse collapse">
            <div class="panel-body">
              <div class="row group-label">
                <div class="col-xs-6" style="text-align: center">Kanal 1</div>
                <div class="col-xs-6" style="text-align: center">Kanal 2</div>
              </div>
              <div class="row">
                <div class="col-xs-3 txt-right">Najmanjša napetost:</div>
                <div class="col-xs-3"><span id="info_ch1_min">-</span><span class="unit">V</span></div>
                <div class="col-xs-3 txt-right">Najmanjša napetost:</div>
                <div class="col-xs-3"><span id="info_ch2_min">-</span><span class="unit">V</span></div>
              </div>
              <div class="row">
                <div class="col-xs-3 txt-right">Največja napetost:</div>
                <div class="col-xs-3"><span id="info_ch1_max">-</span><span class="unit">V</span></div>
                <div class="col-xs-3 txt-right">Največja napetost:</div>
                <div class="col-xs-3"><span id="info_ch2_max">-</span><span class="unit">V</span></div>
              </div>
              <div class="row">
                <div class="col-xs-3 txt-right">Vršna napetost:</div>
                <div class="col-xs-3"><span id="info_ch1_amp">-</span><span class="unit">Vpp</span></div>
                <div class="col-xs-3 txt-right">Vršna napetost:</div>
                <div class="col-xs-3"><span id="info_ch2_amp">-</span><span class="unit">Vpp</span></div>
              </div>
              <div class="row">
                <div class="col-xs-3 txt-right">Povprečna napetost</div>
                <div class="col-xs-3"><span id="info_ch1_avg">-</span><span class="unit">V</span></div>
                <div class="col-xs-3 txt-right">Povprečna napetost</div>
                <div class="col-xs-3"><span id="info_ch2_avg">-</span><span class="unit">V</span></div>
              </div>
              <div class="row">
                <div class="col-xs-3 txt-right">Frekvenca:</div>
                <div class="col-xs-3" id="info_ch1_freq">-<span class="unit">Hz</span></div>
                <div class="col-xs-3 txt-right">Frekvenca:</div>
                <div class="col-xs-3" id="info_ch2_freq">-<span class="unit">Hz</span></div>
              </div>
              <div class="row">
                <div class="col-xs-3 txt-right">Perioda:</div>
                <div class="col-xs-3" id="info_ch1_period">-<span class="unit">s</span></div>
                <div class="col-xs-3 txt-right">Perioda:</div>
                <div class="col-xs-3" id="info_ch2_period">-<span class="unit">s</span></div>
              </div>
            </div>
          </div>
        </div>
		
		    <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#trigger">
                Proženje
              </a>
            </h4>
          </div>
          <div id="trigger" class="panel-collapse collapse">
            <div class="panel-body">
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="form-group">
                  <label for="trig_source" class="col-xs-4 control-label">Izvor prožilnega signala:</label>
                  <div class="col-xs-8">
                    <select id="trig_source" class="form-control">
                      <option value="0">Kanal 1</option>
                      <option value="1">Kanal 2</option>
                      <option value="2">Zunanji izvor</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="trig_mode" class="col-xs-4 control-label">Način proženja:</label>
                  <div class="col-xs-8">
                    <select id="trig_mode" class="form-control">
                      <option value="0">Samodejno</option>
                      <option value="1"> Običajno </option>
                      <option value="2">Enkratno</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="trig_edge" class="col-xs-4 control-label">Prehod signala za proženje:</label>
                  <div class="col-xs-8">
                    <select id="trig_edge" class="form-control">
                      <option value="0">Pozitiven prehod</option>
                      <option value="1">Negativen prehod</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="trig_level" class="col-xs-4 control-label">Prag proženja:</label>
                  <div class="col-xs-5">
                    <input type="text" id="trig_level" value="0" class="form-control" autocomplete="off">
                    <span id="apply_trig_level" class="input-group-btn" style="display: none;">
                      <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
                  <div id="trig_lev_units" class="col-xs-3" style="padding: 7px 0 0;">V</div>
                </div>
              </form>
              <div class="row">
                <div class="col-xs-4"> </div>
                <div class="col-xs-5">
                  <button id="btn_single" class="btn btn-primary" onclick="singleUpdate()" disabled>
                    <span class="glyphicon glyphicon-step-forward"></span> Enkratno proženje
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#gain">
                Merilni sondi
              </a>
            </h4>
          </div>
          <div id="gain" class="panel-collapse collapse">
            <div class="panel-body">
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="group-label" style="padding-bottom: 10px;">Kanal 1</div>
                <div class="form-group">
                  <label for="gain_ch1_att" class="col-xs-4 col-sm-6 control-label">Faktor slabljenja:</label>
                  <div class="col-xs-4 col-sm-5">
                    <select class="form-control" id="gain_ch1_att">
                      <option value="0">1x</option>
                      <option value="1">10x</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="gain_ch1_sett" class="col-xs-4 col-sm-6 control-label">Nastavitev ojačanja:</label>
                  <div class="col-xs-4 col-sm-5">
                    <select class="form-control" id="gain_ch1_sett">
                      <option value="0">LV</option>
                      <option value="1">HV</option>
                    </select>
                  </div>
                </div>
                <div class="group-label" style="padding: 10px 0;">Kanal 2</div>
                <div class="form-group">
                  <label for="gain_ch2_att" class="col-xs-4 col-sm-6 control-label">Faktor slabljenja:</label>
                  <div class="col-xs-4 col-sm-5">
                    <select class="form-control" id="gain_ch2_att">
                      <option value="0">1x</option>
                      <option value="1">10x</option>
                    </select>
                  </div>
                </div>
                <div class="form-group">
                  <label for="gain_ch2_sett" class="col-xs-4 col-sm-6 control-label">Nastavitev ojačanja:</label>
                  <div class="col-xs-4 col-sm-5">
                    <select class="form-control" id="gain_ch2_sett">
                      <option value="0">LV</option>
                      <option value="1">HV</option>
                    </select>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="panel panel-default" style="margin-bottom: 15em;">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#generator">
                Signalni generator
              </a>
            </h4>
          </div>
          <div id="generator" class="panel-collapse collapse">
            <div class="panel-body">
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="checkbox" style="padding-bottom: 12px;">
                  <label class="group-label">
                    <input type="checkbox" id="gen_enable_ch1" checked> Kanal 1
                  </label>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="form-group">
                  <label for="gen_ch1_sigtype" class="col-xs-4 control-label">Oblika izhodnega signala:</label>
                  <div class="col-xs-4 col-sm-7">
                    <select class="form-control" id="gen_ch1_sigtype">
                      <option value="0">Sinusna</option>
                      <option value="1">Pravokotna</option>
                      <option value="2">Trikotna</option>
                      <option value="3">Iz datoteke</option>
                    </select>
                  </div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="form-group">
                  <label for="gen_ch1_ampl" class="col-xs-4 control-label"> Vršna napetost:</label>
                  <div class="col-xs-4 col-sm-5">
                    <input type="text" autocomplete="off" class="form-control" value="0" id="gen_ch1_ampl">
                    <span style="display: none;" class="input-group-btn" id="apply_gen_ch1_ampl">
                      <button type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
                  <div style="padding: 7px 0 0;" class="col-xs-2" id="gen_ch1_ampl_units">Vpp</div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="form-group">
                  <label for="gen_ch1_freq" class="col-xs-4 control-label"> Frekvenca:</label>
                  <div class="col-xs-4 col-sm-5">
                    <input type="text" autocomplete="off" class="form-control" value="0" id="gen_ch1_freq">
                    <span style="display: none;" class="input-group-btn" id="apply_gen_ch1_freq">
                      <button type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
                  <div style="padding: 7px 0 0;" class="col-xs-2" id="gen_ch1_freq_units">Hz</div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="form-group">
                  <label for="gen_ch1_dc" class="col-xs-4 control-label">Enosmerna komponenta:</label>
                  <div class="col-xs-4 col-sm-5">
                    <input type="text" autocomplete="off" class="form-control" value="0" id="gen_ch1_dc">
                    <span style="display: none;" class="input-group-btn" id="apply_gen_ch1_dc">
                      <button type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
                  <div style="padding: 7px 0 0;" class="col-xs-2" id="gen_ch1_dc_units">V</div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="form-group">
                  <label for="gen_ch1_trigmode" class="col-xs-4 control-label" style="white-space: nowrap;">Način proženja:</label>
                  <div class="col-xs-4 col-sm-7">
                    <select class="form-control" id="gen_ch1_trigmode">
                      <option value="0">Ponavljajoče</option>
                      <option value="1">Enkratno</option>
                      <option value="2">Zunanji izvor</option>
                    </select>
                  </div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="row">
                  <div class="col-xs-8 col-md-12 col-lg-8 col-sm-offset-4 col-md-offset-0 col-lg-offset-4">
                    <button id="gen_ch1_single" class="btn btn-primary" onclick="return postGenSingle(1)">
                      <span class="glyphicon glyphicon-step-forward"></span> Enkratno
                    </button>
                    <button id="gen_ch1_upload" class="btn btn-primary" onclick="return showUploadForm(1)">
                      <span class="glyphicon glyphicon-upload"></span> Naloži datoteko
                    </button>
                  </div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;" style="display: none;">
                <div class="checkbox" style="padding-top: 15px; padding-bottom: 12px;">
                  <label class="group-label">
                    <input type="checkbox" id="gen_enable_ch2" checked> Kanal 2
                  </label>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;" style="display: none;">
                <div class="form-group">
                  <label for="gen_ch2_sigtype" class="col-xs-4 control-label">Oblika izhodnega signala:</label>
                  <div class="col-xs-4 col-sm-7">
                    <select class="form-control" id="gen_ch2_sigtype">
                      <option value="0">Sinusna</option>
                      <option value="1">Pravokotna</option>
                      <option value="2">Trikotna</option>
                      <option value="3">Iz datoteke</option>
                    </select>
                  </div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;" style="display: none;">
                <div class="form-group">
                  <label for="gen_ch2_ampl" class="col-xs-4 control-label"> Vršna napetost:</label>
                  <div class="col-xs-4 col-sm-5">
                    <input type="text" autocomplete="off" class="form-control" value="0" id="gen_ch2_ampl">
                    <span style="display: none;" class="input-group-btn" id="apply_gen_ch2_ampl">
                      <button type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
                  <div style="padding: 7px 0 0;" class="col-xs-2" id="gen_ch2_ampl_units">Vpp</div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;" style="display: none;">
                <div class="form-group">
                  <label for="gen_ch2_freq" class="col-xs-4 control-label"> Frekvenca:</label>
                  <div class="col-xs-4 col-sm-5">
                    <input type="text" autocomplete="off" class="form-control" value="0" id="gen_ch2_freq">
                    <span style="display: none;" class="input-group-btn" id="apply_gen_ch2_freq">
                      <button type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
                  <div style="padding: 7px 0 0;" class="col-xs-2" id="gen_ch2_freq_units">Hz</div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;" style="display: none;">
                <div class="form-group">
                  <label for="gen_ch2_dc" class="col-xs-4 control-label">Enosmerna komponenta:</label>
                  <div class="col-xs-4 col-sm-5">
                    <input type="text" autocomplete="off" class="form-control" value="0" id="gen_ch2_dc">
                    <span style="display: none;" class="input-group-btn" id="apply_gen_ch2_dc">
                      <button type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
                  <div style="padding: 7px 0 0;" class="col-xs-2" id="gen_ch2_dc_units">V</div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;" style="display: none;">
                <div class="form-group">
                  <label for="gen_ch2_trigmode" class="col-xs-4 control-label" style="white-space: nowrap;">Način proženja:</label>
                  <div class="col-xs-4 col-sm-7">
                    <select class="form-control" id="gen_ch2_trigmode">
                      <option value="0">Ponavljajoče</option>
                      <option value="1">Enkratno</option>
                      <option value="2">Zunanji izvor</option>
                    </select>
                  </div>
                </div>
              </form>
              <form class="form-horizontal" role="form" onsubmit="return false;" style="display: none;">
                <div class="row">
                  <div class="col-xs-8 col-md-12 col-lg-8 col-sm-offset-4 col-md-offset-0 col-lg-offset-4">
                    <button id="gen_ch2_single" class="btn btn-primary" onclick="return postGenSingle(2)">
                      <span class="glyphicon glyphicon-step-forward"></span> Enkratno
                    </button>
                    <button id="gen_ch2_upload" class="btn btn-primary" onclick="return showUploadForm(2)">
                      <span class="glyphicon glyphicon-upload"></span> Naloži datoteko
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="kviz" style="padding: 0 2em;">
      <div class="col-xs-12"></div>
        <div class="row text-center">
          <button class="btn btn-default btn-info" id="preveri" style="color: white;"> PREVERI </button>
        </div>
        <div class="alert alert-danger text-center" style="display: none; margin: 1em 0 0 0;"> </div>
        <div class="alert alert-warning text-center" style="display: none; margin: 1em 0 0 0;"> </div>
        <div class="alert alert-success text-center" style="display: none; margin: 1em 0 0 0;"> </div>
      </div>
      <div class="tab-pane fade in active" id="navodila">
        <div class="row" style="padding: 0 2em;">
          <div class="row" style="padding: 0 2em;">
            Aplikacija eNapetost/Tok je namenjena opazovanju toka in napetosti na osnovnih elementih vezja. 
          </div>
          <div class="row" style="padding: 1em 2em;">
            Ta aplikacija je vezana na eEksperiment <a class="opis">Lastnosti elementov vezja</a>, ki se lahko izvaja v treh zahtevnostnih načinih. Če ste pravilno povezali potrebne komponente, se navodila za izvajanje eksperimenta nahajajo na sledečih povezavah:
          </div>
          <div class="row" style="padding: 0 2em;">
            -<a id="lazji_navodila"> Enostaven način izvajanja</a>
          </div>
          <div class="row" style="padding: 0 2em;">
            -<a id="srednji_navodila"> Srednje zahteven način izvajanja</a>
          </div>
          <div class="row" style="padding: 0 2em;">
           -<a id="tezji_navodila"> Zahteven način izvajanja</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
 <!-- <div id="modal_err" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_err_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_err_label">Application error</h4>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default btn-close-modal" id="btn_ignore">Ignore</button>
          <button type="button" class="btn btn-default" id="btn_retry_get">Retry</button>
          <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
        </div>
      </div>
    </div>
  </div>-->
  <div id="modal_app" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_app_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_app_label">Application stopped</h4>
        </div>
        <div class="modal-body">
          The <strong><span class="app-id"></span></strong> application was stopped. The current started application is <strong><span id="new_app_id"></span></strong>.<br />
          Do you want to switch to newly started application or to restart <strong><span class="app-id"></span></strong>?
        </div>
        <div class="modal-footer">
          <a href="/index.html" class="btn btn-danger pull-left">Exit app</a>
          <button type="button" class="btn btn-default" id="btn_switch_app">Switch</button>
          <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
        </div>
      </div>
    </div>
  </div>
  <div id="modal_upload" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_upload_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_upload_label">File upload for channel <span></span></h4>
        </div>
        <div class="modal-body"> 
          <form id="upload_form" role="form">
            <div class="form-group">
              <input type="file" name="file_select" id="uploaded_file">
              <input type="hidden" name="file_content" id="uploaded_file_content">
              <p class="help-block">Select the CSV file to upload.</p>
            </div>
          </form>
        </div>
        <div class="modal-footer" style="margin-top: 0;">
          <button type="button" class="btn btn-default btn-close-modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="startUpload()">Upload</button>
        </div>
      </div>
    </div>
  </div>  
</body>
</html>
